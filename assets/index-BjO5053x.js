const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/BifurcationDiagram-DrE9rQq3.js","assets/three-vendor-CMdyc2H8.js","assets/BifurcationDiagram-7MOkXOt8.css","assets/PoincareSection-s4wDGFf_.js","assets/PoincareSection-Bu5ajD9c.css","assets/ParameterSpace-4LOxwncI.js","assets/ParameterSpace-U0tBLzM4.css"])))=>i.map(i=>d[i]);
import{V as O,c as We,r as l,u as W,B as Q,L as Ne,A as ne,j as t,a as Fe,D as Ye,C as X,b as Le,d as Xe,E as Ke,e as Ze,G as Je,O as Qe,f as et,w as tt,_ as Te,g as st}from"./three-vendor-CMdyc2H8.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function s(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(o){if(o.ep)return;o.ep=!0;const n=s(o);fetch(o.href,n)}})();class at{points=[];position;params;dt=.01;perturbation=new O(1,0,0);lyapunovSum=0;lyapunovSteps=0;lyapunovExponent=0;RENORM_INTERVAL=10;stepsSinceRenorm=0;prevZ=0;prevDz=0;poincarePoints=[];MAX_POINCARE=5e3;constructor(e=new O(1,1,1),s){this.position=e.clone(),this.params=s,this.points=[this.position.clone()],this.prevZ=e.z}derivatives(e,s,a){const{sigma:o,rho:n,beta:c}=this.params;return[o*(s-e),e*(n-a)-s,e*s-c*a]}jacobianApply(e,s,a,o,n,c){const{sigma:m,rho:h,beta:u}=this.params;return[m*(n-o),(h-a)*o-n-e*c,s*o+e*n-u*c]}step(e=1){const s=this.dt*e,{x:a,y:o,z:n}=this.position,[c,m,h]=this.derivatives(a,o,n),[u,p,i]=this.derivatives(a+.5*s*c,o+.5*s*m,n+.5*s*h),[f,d,b]=this.derivatives(a+.5*s*u,o+.5*s*p,n+.5*s*i),[C,x,S]=this.derivatives(a+s*f,o+s*d,n+s*b);this.position.x+=s/6*(c+2*u+2*f+C),this.position.y+=s/6*(m+2*p+2*d+x),this.position.z+=s/6*(h+2*i+2*b+S),(!isFinite(this.position.x)||!isFinite(this.position.y)||!isFinite(this.position.z)||Math.abs(this.position.x)>1e6)&&this.position.set(1,1,1),this.points.push(this.position.clone());const y=this.perturbation.x,P=this.perturbation.y,T=this.perturbation.z,[k,j,A]=this.jacobianApply(this.position.x,this.position.y,this.position.z,y,P,T);if(this.perturbation.x+=k*s,this.perturbation.y+=j*s,this.perturbation.z+=A*s,this.stepsSinceRenorm++,this.stepsSinceRenorm>=this.RENORM_INTERVAL){const R=this.perturbation.length();if(R>0&&isFinite(R)){this.lyapunovSum+=Math.log(R),this.lyapunovSteps++,this.perturbation.divideScalar(R);const g=this.lyapunovSteps*this.RENORM_INTERVAL*this.dt;this.lyapunovExponent=this.lyapunovSum/g}this.stepsSinceRenorm=0}const v=this.position.z-this.prevZ;return this.prevDz>0&&v<=0&&this.points.length>100&&(this.poincarePoints.push([this.position.x,this.position.y]),this.poincarePoints.length>this.MAX_POINCARE&&this.poincarePoints.splice(0,this.poincarePoints.length-this.MAX_POINCARE)),this.prevDz=v,this.prevZ=this.position.z,this.position.clone()}reset(e=new O(1,1,1)){this.position=e.clone(),this.points=[this.position.clone()],this.perturbation.set(1,0,0),this.lyapunovSum=0,this.lyapunovSteps=0,this.lyapunovExponent=0,this.stepsSinceRenorm=0,this.prevZ=e.z,this.prevDz=0,this.poincarePoints=[]}updateParams(e){this.params={...this.params,...e}}trimTrail(e){this.points.length>e&&this.points.splice(0,this.points.length-e)}getSpeed(){if(this.points.length<2)return 0;const e=this.points[this.points.length-1],s=this.points[this.points.length-2];return e.distanceTo(s)}getParams(){return{...this.params}}perturb(e){this.position.x+=(Math.random()-.5)*e*2,this.position.y+=(Math.random()-.5)*e*2,this.position.z+=(Math.random()-.5)*e*2}getPosition(){return{x:this.position.x,y:this.position.y,z:this.position.z}}}const K={system:null,type:null};function Ee(r,e){K.system=r,K.type=e}function Ce(r){K.system===r&&(K.system=null,K.type=null)}function rt(r){const e=K.system;e&&typeof e.perturb=="function"&&e.perturb(r)}const U={classic:{bg:"#000010",bgRgb:"0,0,16",panelBg:"rgba(20, 20, 25, 0.95)",panelBorder:"rgba(255, 255, 255, 0.1)",text:"#cccccc",textMuted:"rgba(255,255,255,0.6)",accent:"#88ccff",accent2:"#aaffaa",heading:"#88ccff",paramColor:"#ffcc88",trailHue1:.55,trailHue2:.85,starColor:"#ffffff"},neon:{bg:"#000000",bgRgb:"0,0,0",panelBg:"rgba(10, 0, 20, 0.95)",panelBorder:"rgba(255, 0, 255, 0.25)",text:"#e0e0e0",textMuted:"rgba(255,255,255,0.5)",accent:"#ff00ff",accent2:"#00ffff",heading:"#ff44ff",paramColor:"#ffff00",trailHue1:.83,trailHue2:.5,starColor:"#ff88ff"},blueprint:{bg:"#0a1628",bgRgb:"10,22,40",panelBg:"rgba(15, 30, 60, 0.95)",panelBorder:"rgba(100, 160, 255, 0.3)",text:"#c0d8f0",textMuted:"rgba(192,216,240,0.6)",accent:"#4488ff",accent2:"#88bbff",heading:"#6699ff",paramColor:"#aaccff",trailHue1:.6,trailHue2:.58,starColor:"#4488ff"},terminal:{bg:"#000a00",bgRgb:"0,10,0",panelBg:"rgba(0, 15, 0, 0.95)",panelBorder:"rgba(0, 255, 0, 0.2)",text:"#00dd00",textMuted:"rgba(0,220,0,0.5)",accent:"#00ff00",accent2:"#88ff88",heading:"#00ff00",paramColor:"#44ff44",trailHue1:.33,trailHue2:.28,starColor:"#00ff00"}},Ie={lorenz:[{name:"Classic Lorenz",description:"The original butterfly attractor",params:{sigma:10,rho:28,beta:8/3}},{name:"Edge of Chaos",description:"Parameters at the edge between order and chaos",params:{sigma:10,rho:24,beta:8/3}},{name:"Strange Attractor",description:"Different parameter set creating unique patterns",params:{sigma:12,rho:30,beta:2.5}}],rossler:[{name:"Classic RÃ¶ssler",description:"The standard RÃ¶ssler attractor parameters",params:{a:.2,b:.2,c:5.7}},{name:"Spiral Focus",description:"Creates tighter spiral patterns",params:{a:.1,b:.1,c:4}},{name:"Period Doubling",description:"Shows period-doubling route to chaos",params:{a:.15,b:.2,c:10}}],doublePendulum:[{name:"Equal Masses",description:"Two pendulums with equal mass and length",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0}},{name:"Heavy Bottom",description:"Bottom pendulum twice as heavy",params:{mass1:1,mass2:2,length1:1,length2:1,gravity:9.81,damping:0}},{name:"With Damping",description:"Small damping showing energy dissipation",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:.05}}]},ae=[{name:"The Butterfly Effect",emoji:"ðŸ¦‹",description:"Two nearly identical universes diverge into completely different futures",system:"lorenz",params:{sigma:10,rho:28,beta:8/3},trailLength:2e3,speed:1,sideBySide:!0,offset:1e-6},{name:"The Strange Attractor",emoji:"ðŸŒ€",description:"The iconic Lorenz butterfly â€” a shape that never repeats, yet never escapes",system:"lorenz",params:{sigma:10,rho:28,beta:8/3},trailLength:4e3,speed:1.5,sideBySide:!1,offset:.001},{name:"Edge of Order",emoji:"âš–ï¸",description:"Right at the boundary where predictable behavior gives way to chaos",system:"lorenz",params:{sigma:10,rho:24.5,beta:8/3},trailLength:3e3,speed:.8,sideBySide:!1,offset:.001},{name:"The Spiral",emoji:"ðŸŒŠ",description:"The RÃ¶ssler attractor â€” simplicity breeds complexity in this elegant spiral",system:"rossler",params:{a:.2,b:.2,c:5.7},trailLength:3500,speed:1.2,sideBySide:!1,offset:.001},{name:"Period Doubling",emoji:"ðŸ”„",description:"Watch the RÃ¶ssler system trace a period-2 orbit â€” the route to chaos begins",system:"rossler",params:{a:.2,b:.2,c:3.5},trailLength:3e3,speed:1,sideBySide:!1,offset:.001},{name:"The Pendulum",emoji:"âš¡",description:"A simple double pendulum â€” deterministic laws, unpredictable motion",system:"doublePendulum",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},trailLength:2e3,speed:1,sideBySide:!1,offset:.001},{name:"Dual Pendulums",emoji:"ðŸ”€",description:"Two pendulums, almost identical â€” watch them dance apart",system:"doublePendulum",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},trailLength:1500,speed:1,sideBySide:!0,offset:1e-4},{name:"The Murmuration",emoji:"ðŸ¦",description:"A swarm of particles traces the attractor â€” chaos as collective motion",system:"lorenz",params:{sigma:10,rho:28,beta:8/3},trailLength:1500,speed:1.2,sideBySide:!1,offset:.001}],B=We(r=>({currentSystem:"lorenz",setCurrentSystem:e=>r({currentSystem:e}),isPlaying:!0,setIsPlaying:e=>r({isPlaying:e}),speed:1,setSpeed:e=>r({speed:e}),trailLength:2e3,setTrailLength:e=>r({trailLength:e}),sideBySideMode:!1,setSideBySideMode:e=>r({sideBySideMode:e}),initialOffset:.001,setInitialOffset:e=>r({initialOffset:e}),divergence:0,setDivergence:e=>r({divergence:e}),colorTheme:"classic",setColorTheme:e=>r({colorTheme:e}),lorenzParams:{sigma:10,rho:28,beta:8/3},setLorenzParams:e=>r(s=>({lorenzParams:{...s.lorenzParams,...e}})),rosslerParams:{a:.2,b:.2,c:5.7},setRosslerParams:e=>r(s=>({rosslerParams:{...s.rosslerParams,...e}})),doublePendulumParams:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},setDoublePendulumParams:e=>r(s=>({doublePendulumParams:{...s.doublePendulumParams,...e}})),currentPreset:null,setCurrentPreset:e=>r({currentPreset:e}),showInfoPanel:!0,setShowInfoPanel:e=>r({showInfoPanel:e}),autoRotate:!0,setAutoRotate:e=>r({autoRotate:e}),_resetCounter:0,resetSimulation:()=>{r(e=>({_resetCounter:e._resetCounter+1,isPlaying:!1})),setTimeout(()=>r({isPlaying:!0}),100)},showPerformanceWarning:!1,setShowPerformanceWarning:e=>r({showPerformanceWarning:e}),showLyapunov:!1,setShowLyapunov:e=>r({showLyapunov:e}),lyapunovExponent:0,setLyapunovExponent:e=>r({lyapunovExponent:e}),showBifurcation:!1,setShowBifurcation:e=>r({showBifurcation:e}),showPoincare:!1,setShowPoincare:e=>r({showPoincare:e}),showParameterSpace:!1,setShowParameterSpace:e=>r({showParameterSpace:e}),cinematicCamera:!1,setCinematicCamera:e=>r({cinematicCamera:e}),chaosAutopilot:!1,setChaosAutopilot:e=>r({chaosAutopilot:e}),storyMode:!1,setStoryMode:e=>r({storyMode:e}),currentStoryIndex:0,setCurrentStoryIndex:e=>r({currentStoryIndex:e}),bloomEnabled:!0,setBloomEnabled:e=>r({bloomEnabled:e}),bloomIntensity:1.5,setBloomIntensity:e=>r({bloomIntensity:e}),audioEnabled:!1,setAudioEnabled:e=>r({audioEnabled:e}),audioVolume:.3,setAudioVolume:e=>r({audioVolume:e}),particleSwarm:!1,setParticleSwarm:e=>r({particleSwarm:e}),_perturbCounter:0,perturbSystem:()=>{rt(1),r(e=>({_perturbCounter:e._perturbCounter+1}))}})),te=6e3,ke=({points:r,hueStart:e,hueEnd:s,scale:a=1,flatZ:o=!1,glowIntensity:n=.6})=>{const c=l.useRef(null),m=l.useRef(null),h=l.useRef(null),u=l.useRef(null),{posBuffer:p,colorBuffer:i,glowColorBuffer:f}=l.useMemo(()=>({posBuffer:new Float32Array(te*3),colorBuffer:new Float32Array(te*3),glowColorBuffer:new Float32Array(te*3)}),[]);W(()=>{if(!h.current||!u.current)return;const C=Math.min(r.length,te);if(C<2){h.current.setDrawRange(0,0),u.current.setDrawRange(0,0);return}const x=Math.max(0,r.length-te),S=a;for(let j=0;j<C;j++){const A=r[x+j],v=j*3;p[v]=A.x*S,p[v+1]=A.y*S,p[v+2]=o?0:A.z*S;const R=j/(C-1),g=R*R,z=e+(s-e)*R,L=.8+R*.2,E=.3+g*.55,M=(1-Math.abs(2*E-1))*L,N=(z%1+1)%1*6,D=M*(1-Math.abs(N%2-1)),q=E-M/2,H=Math.floor(N)%6;let _=0,$=0,I=0;switch(H){case 0:_=M,$=D;break;case 1:_=D,$=M;break;case 2:$=M,I=D;break;case 3:$=D,I=M;break;case 4:_=D,I=M;break;case 5:_=M,I=D;break}i[v]=(_+q)*g,i[v+1]=($+q)*g,i[v+2]=(I+q)*g;const G=g*n,F=1.5+R*.5;f[v]=(_+q)*G*F,f[v+1]=($+q)*G*F,f[v+2]=(I+q)*G*F}const y=h.current.getAttribute("position"),P=h.current.getAttribute("color");y.set(p.subarray(0,C*3)),P.set(i.subarray(0,C*3)),y.needsUpdate=!0,P.needsUpdate=!0,h.current.setDrawRange(0,C);const T=u.current.getAttribute("position"),k=u.current.getAttribute("color");T.set(p.subarray(0,C*3)),k.set(f.subarray(0,C*3)),T.needsUpdate=!0,k.needsUpdate=!0,u.current.setDrawRange(0,C)}),l.useEffect(()=>{!h.current||!u.current||(h.current.setAttribute("position",new Q(new Float32Array(te*3),3)),h.current.setAttribute("color",new Q(new Float32Array(te*3),3)),h.current.setDrawRange(0,0),u.current.setAttribute("position",new Q(new Float32Array(te*3),3)),u.current.setAttribute("color",new Q(new Float32Array(te*3),3)),u.current.setDrawRange(0,0))},[]);const d=l.useMemo(()=>new Ne({vertexColors:!0,transparent:!0,opacity:1,depthWrite:!1,blending:ne}),[]),b=l.useMemo(()=>new Ne({vertexColors:!0,transparent:!0,opacity:.5,depthWrite:!1,blending:ne}),[]);return t.jsxs(t.Fragment,{children:[t.jsxs("primitive",{object:new Fe,ref:c,children:[t.jsx("bufferGeometry",{ref:h}),t.jsx("primitive",{object:d,attach:"material"})]}),t.jsxs("primitive",{object:new Fe,ref:m,children:[t.jsx("bufferGeometry",{ref:u}),t.jsx("primitive",{object:b,attach:"material"})]})]})},Ae=({position:r,color:e,lightIntensity:s=.8,size:a=1,showPulse:o=!0})=>{const n=l.useRef(null),c=l.useRef(null),m=l.useRef(null),h=l.useRef(Math.random()*Math.PI*2),u=l.useMemo(()=>{const p=e.clone();return p.offsetHSL(0,.1,.2),p},[e]);return W(({clock:p})=>{const i=p.getElapsedTime();if(h.current+=.04,c.current){const f=1+Math.sin(i*3)*.15,d=.05*a*f;c.current.scale.setScalar(d/(.05*a)||1)}if(m.current){const f=1+Math.sin(i*3+Math.PI)*.2,d=m.current.material;d.opacity=.15+Math.sin(i*2.5)*.08;const b=.12*a*f;m.current.scale.setScalar(b/(.12*a)||1)}if(n.current&&o){const f=i*1.2%2,d=.05+f*.15*a;n.current.scale.set(d,d,1);const b=n.current.material;b.opacity=Math.max(0,.4*(1-f/2))}}),t.jsxs("group",{position:r,children:[s>0&&t.jsx("pointLight",{color:e,intensity:s*.4,distance:1.5*a,decay:2}),t.jsxs("mesh",{ref:m,children:[t.jsx("sphereGeometry",{args:[.12*a,16,16]}),t.jsx("meshBasicMaterial",{color:e,transparent:!0,opacity:.15,depthWrite:!1,blending:ne})]}),t.jsxs("mesh",{ref:c,children:[t.jsx("sphereGeometry",{args:[.05*a,16,16]}),t.jsx("meshBasicMaterial",{color:u,transparent:!0,opacity:.95})]}),o&&t.jsxs("mesh",{ref:n,rotation:[Math.PI/2,0,0],children:[t.jsx("ringGeometry",{args:[.8,1,32]}),t.jsx("meshBasicMaterial",{color:e,transparent:!0,opacity:.3,side:Ye,depthWrite:!1,blending:ne})]})]})},nt=({position:r=[0,0,0],scale:e=.1,initialCondition:s=[1,1,1],isSecondary:a=!1,lastPosRef:o})=>{const n=l.useRef(null),{isPlaying:c,speed:m,trailLength:h,lorenzParams:u,_resetCounter:p,colorTheme:i,showLyapunov:f,setLyapunovExponent:d,showPoincare:b}=B(),C=U[i],x=l.useMemo(()=>{const j=new O(...s);return new at(j,u)},[s[0],s[1],s[2],u.sigma,u.rho,u.beta]);l.useEffect(()=>{x.reset(new O(...s))},[p]),l.useEffect(()=>{x.updateParams(u)},[u,x]);const S=l.useRef(x);S.current=x,l.useEffect(()=>(a||Ee(x,"lorenz"),()=>{a||Ce(x)}),[x,a]);const y=l.useRef(0);W(()=>{if(!c)return;x.step(m*.5),x.trimTrail(h);const j=x.points;if(o&&j.length>0){const A=j[j.length-1];o.current=A.clone()}!a&&(f||b)&&(y.current++,y.current%30===0&&d(x.lyapunovExponent))});const P=a?C.trailHue2:C.trailHue1,T=P+.2,k=new X().setHSL(P+.15,1,.7);return t.jsxs("group",{ref:n,position:r,children:[t.jsx(ke,{points:x.points,hueStart:P,hueEnd:T,lineWidth:2.5,glowIntensity:.5,scale:e}),x.points.length>0&&(()=>{const j=x.points[x.points.length-1];return t.jsx(Ae,{position:[j.x*e,j.y*e,j.z*e],color:k,lightIntensity:a?.4:.8,size:.8,showPulse:!a})})()]})};class ot{points=[];position;params;dt=.01;perturbation=new O(1,0,0);lyapunovSum=0;lyapunovSteps=0;lyapunovExponent=0;RENORM_INTERVAL=10;stepsSinceRenorm=0;prevY=0;poincarePoints=[];MAX_POINCARE=5e3;constructor(e=new O(1,1,1),s){this.position=e.clone(),this.params=s,this.points=[this.position.clone()],this.prevY=e.y}derivatives(e,s,a){const{a:o,b:n,c}=this.params;return[-s-a,e+o*s,n+a*(e-c)]}jacobianApply(e,s,a,o,n,c){const{a:m,c:h}=this.params;return[-n-c,o+m*n,a*o+(e-h)*c]}step(e=1){const s=this.dt*e,{x:a,y:o,z:n}=this.position,[c,m,h]=this.derivatives(a,o,n),[u,p,i]=this.derivatives(a+.5*s*c,o+.5*s*m,n+.5*s*h),[f,d,b]=this.derivatives(a+.5*s*u,o+.5*s*p,n+.5*s*i),[C,x,S]=this.derivatives(a+s*f,o+s*d,n+s*b);this.position.x+=s/6*(c+2*u+2*f+C),this.position.y+=s/6*(m+2*p+2*d+x),this.position.z+=s/6*(h+2*i+2*b+S),(!isFinite(this.position.x)||!isFinite(this.position.y)||!isFinite(this.position.z)||Math.abs(this.position.x)>1e6)&&this.position.set(1,1,1),this.points.push(this.position.clone());const y=this.perturbation.x,P=this.perturbation.y,T=this.perturbation.z,[k,j,A]=this.jacobianApply(this.position.x,this.position.y,this.position.z,y,P,T);if(this.perturbation.x+=k*s,this.perturbation.y+=j*s,this.perturbation.z+=A*s,this.stepsSinceRenorm++,this.stepsSinceRenorm>=this.RENORM_INTERVAL){const v=this.perturbation.length();if(v>0&&isFinite(v)){this.lyapunovSum+=Math.log(v),this.lyapunovSteps++,this.perturbation.divideScalar(v);const R=this.lyapunovSteps*this.RENORM_INTERVAL*this.dt;this.lyapunovExponent=this.lyapunovSum/R}this.stepsSinceRenorm=0}return this.prevY<0&&this.position.y>=0&&this.points.length>100&&(this.poincarePoints.push([this.position.x,this.position.z]),this.poincarePoints.length>this.MAX_POINCARE&&this.poincarePoints.splice(0,this.poincarePoints.length-this.MAX_POINCARE)),this.prevY=this.position.y,this.position.clone()}reset(e=new O(1,1,1)){this.position=e.clone(),this.points=[this.position.clone()],this.perturbation.set(1,0,0),this.lyapunovSum=0,this.lyapunovSteps=0,this.lyapunovExponent=0,this.stepsSinceRenorm=0,this.prevY=e.y,this.poincarePoints=[]}updateParams(e){this.params={...this.params,...e}}trimTrail(e){this.points.length>e&&this.points.splice(0,this.points.length-e)}getSpeed(){if(this.points.length<2)return 0;const e=this.points[this.points.length-1],s=this.points[this.points.length-2];return e.distanceTo(s)}getParams(){return{...this.params}}perturb(e){this.position.x+=(Math.random()-.5)*e*2,this.position.y+=(Math.random()-.5)*e*2,this.position.z+=(Math.random()-.5)*e*2}getPosition(){return{x:this.position.x,y:this.position.y,z:this.position.z}}}const it=({position:r=[0,0,0],scale:e=.5,initialCondition:s=[1,1,1],isSecondary:a=!1,lastPosRef:o})=>{const n=l.useRef(null),{isPlaying:c,speed:m,trailLength:h,rosslerParams:u,_resetCounter:p,colorTheme:i,showLyapunov:f,setLyapunovExponent:d,showPoincare:b,currentSystem:C}=B(),x=U[i],S=l.useMemo(()=>{const j=new O(...s);return new ot(j,u)},[s[0],s[1],s[2],u.a,u.b,u.c]);l.useEffect(()=>{S.reset(new O(...s))},[p]),l.useEffect(()=>{S.updateParams(u)},[u,S]),l.useEffect(()=>(a||Ee(S,"rossler"),()=>{a||Ce(S)}),[S,a]);const y=l.useRef(0);W(()=>{if(!c)return;S.step(m*.5),S.trimTrail(h);const j=S.points;if(o&&j.length>0){const A=j[j.length-1];o.current=A.clone()}!a&&C==="rossler"&&(f||b)&&(y.current++,y.current%30===0&&d(S.lyapunovExponent))});const P=a?x.trailHue2:x.trailHue1,T=P+.25,k=new X().setHSL(P+.15,1,.8);return t.jsxs("group",{ref:n,position:r,children:[t.jsx(ke,{points:S.points,hueStart:P,hueEnd:T,lineWidth:2.5,glowIntensity:.5,scale:e}),S.points.length>0&&(()=>{const j=S.points[S.points.length-1];return t.jsx(Ae,{position:[j.x*e,j.y*e,j.z*e],color:k,lightIntensity:a?.5:1,size:1,showPulse:!a})})()]})};class lt{points=[];positions=[];state;params;dt=.005;pertState={theta1:1e-6,theta2:0,omega1:0,omega2:0};lyapunovSum=0;lyapunovSteps=0;lyapunovExponent=0;RENORM_INTERVAL=20;stepsSinceRenorm=0;prevTheta2=0;poincarePoints=[];MAX_POINCARE=5e3;constructor(e={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0},s){this.state={...e},this.params=s,this.prevTheta2=e.theta2;const a=this.calculatePositions();this.positions=[a],this.points=[new O(a.p2.x,a.p2.y,0)]}calculatePositions(){const{length1:e,length2:s}=this.params,{theta1:a,theta2:o}=this.state,n=new Le(e*Math.sin(a),-e*Math.cos(a)),c=new Le(n.x+s*Math.sin(o),n.y-s*Math.cos(o));return{p1:n,p2:c}}accelerations(e){const{mass1:s,mass2:a,length1:o,length2:n,gravity:c,damping:m}=this.params,{theta1:h,theta2:u,omega1:p,omega2:i}=e,f=s,d=a,b=o,C=n,x=c,S=Math.cos(h-u),y=Math.sin(h-u),P=Math.sin(h),T=Math.sin(u),k=(f+d)*b-d*b*S*S,j=C/b*k,A=-d*b*p*p*y*S+d*x*T*S+d*C*i*i*y-(f+d)*x*P,v=-d*C*i*i*y*S+(f+d)*x*P*S+(f+d)*b*p*p*y-(f+d)*x*T;let R=A/k,g=v/j;return R-=m*p,g-=m*i,{alpha1:R,alpha2:g}}stateDerivative(e){const{alpha1:s,alpha2:a}=this.accelerations(e);return{theta1:e.omega1,theta2:e.omega2,omega1:s,omega2:a}}addStates(e,s,a){return{theta1:e.theta1+s.theta1*a,theta2:e.theta2+s.theta2*a,omega1:e.omega1+s.omega1*a,omega2:e.omega2+s.omega2*a}}step(e=1){const s=this.dt*e,a=this.stateDerivative(this.state),o=this.stateDerivative(this.addStates(this.state,a,.5*s)),n=this.stateDerivative(this.addStates(this.state,o,.5*s)),c=this.stateDerivative(this.addStates(this.state,n,s));this.state.theta1+=s/6*(a.theta1+2*o.theta1+2*n.theta1+c.theta1),this.state.theta2+=s/6*(a.theta2+2*o.theta2+2*n.theta2+c.theta2),this.state.omega1+=s/6*(a.omega1+2*o.omega1+2*n.omega1+c.omega1),this.state.omega2+=s/6*(a.omega2+2*o.omega2+2*n.omega2+c.omega2),(!isFinite(this.state.theta1)||!isFinite(this.state.theta2)||!isFinite(this.state.omega1)||!isFinite(this.state.omega2)||Math.abs(this.state.omega1)>1e6||Math.abs(this.state.omega2)>1e6)&&(this.state={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0});const m=this.calculatePositions();this.positions.push(m),this.points.push(new O(m.p2.x,m.p2.y,0));const h=1e-7,u={theta1:this.state.theta1+this.pertState.theta1*h,theta2:this.state.theta2+this.pertState.theta2*h,omega1:this.state.omega1+this.pertState.omega1*h,omega2:this.state.omega2+this.pertState.omega2*h},p=this.stateDerivative(this.state),i=this.stateDerivative(u);if(this.pertState.theta1+=(i.theta1-p.theta1)/h*s,this.pertState.theta2+=(i.theta2-p.theta2)/h*s,this.pertState.omega1+=(i.omega1-p.omega1)/h*s,this.pertState.omega2+=(i.omega2-p.omega2)/h*s,this.stepsSinceRenorm++,this.stepsSinceRenorm>=this.RENORM_INTERVAL){const b=Math.sqrt(this.pertState.theta1**2+this.pertState.theta2**2+this.pertState.omega1**2+this.pertState.omega2**2);if(b>0&&isFinite(b)){this.lyapunovSum+=Math.log(b),this.lyapunovSteps++,this.pertState.theta1/=b,this.pertState.theta2/=b,this.pertState.omega1/=b,this.pertState.omega2/=b;const C=this.lyapunovSteps*this.RENORM_INTERVAL*this.dt;this.lyapunovExponent=this.lyapunovSum/C}this.stepsSinceRenorm=0}const f=(this.state.theta2%(2*Math.PI)+2*Math.PI)%(2*Math.PI);return(this.prevTheta2%(2*Math.PI)+2*Math.PI)%(2*Math.PI)>Math.PI&&f<=Math.PI&&f<1&&this.points.length>100&&(this.poincarePoints.push([this.state.theta1,this.state.omega1]),this.poincarePoints.length>this.MAX_POINCARE&&this.poincarePoints.splice(0,this.poincarePoints.length-this.MAX_POINCARE)),this.prevTheta2=this.state.theta2,new O(m.p2.x,m.p2.y,0)}reset(e={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0}){this.state={...e};const s=this.calculatePositions();this.positions=[s],this.points=[new O(s.p2.x,s.p2.y,0)],this.pertState={theta1:1e-6,theta2:0,omega1:0,omega2:0},this.lyapunovSum=0,this.lyapunovSteps=0,this.lyapunovExponent=0,this.stepsSinceRenorm=0,this.prevTheta2=e.theta2,this.poincarePoints=[]}updateParams(e){this.params={...this.params,...e}}trimTrail(e){if(this.points.length>e){const s=this.points.length-e;this.points.splice(0,s),this.positions.splice(0,s)}}getSpeed(){if(this.points.length<2)return 0;const e=this.points[this.points.length-1],s=this.points[this.points.length-2];return e.distanceTo(s)}getCurrentPositions(){return this.positions[this.positions.length-1]}getState(){return{...this.state}}perturb(e){this.state.theta1+=(Math.random()-.5)*e*.3,this.state.theta2+=(Math.random()-.5)*e*.3,this.state.omega1+=(Math.random()-.5)*e*3,this.state.omega2+=(Math.random()-.5)*e*3}}const ct=({position:r=[0,0,0],scale:e=1,initialCondition:s={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0},isSecondary:a=!1,lastPosRef:o})=>{const n=l.useRef(null),{isPlaying:c,speed:m,trailLength:h,doublePendulumParams:u,_resetCounter:p,colorTheme:i,showLyapunov:f,setLyapunovExponent:d,showPoincare:b,currentSystem:C}=B(),x=U[i],S=l.useMemo(()=>new lt(s,u),[s.theta1,s.theta2,s.omega1,s.omega2,u.mass1,u.mass2,u.length1,u.length2,u.gravity,u.damping]);l.useEffect(()=>{S.reset(s)},[p]),l.useEffect(()=>{S.updateParams(u)},[u,S]),l.useEffect(()=>(a||Ee(S,"doublePendulum"),()=>{a||Ce(S)}),[S,a]);const y=l.useRef(0);W(()=>{if(!c)return;S.step(m*2),S.trimTrail(h);const z=S.points;if(o&&z.length>0){const L=z[z.length-1];o.current=new O(L.x,L.y,0)}!a&&C==="doublePendulum"&&(f||b)&&(y.current++,y.current%30===0&&d(S.lyapunovExponent))});const P=S.positions.length>0?S.getCurrentPositions():{p1:{x:0,y:0},p2:{x:0,y:0}},T=a?x.trailHue2:x.trailHue1,k=T+.2,j=new X(x.textMuted),A=new X().setHSL(T,.8,.6),v=new X().setHSL(T+.1,.8,.7),R=[P.p1.x*e,P.p1.y*e,0],g=[P.p2.x*e,P.p2.y*e,0];return t.jsxs("group",{ref:n,position:r,children:[t.jsx(ke,{points:S.points,hueStart:T,hueEnd:k,lineWidth:1.8,glowIntensity:.4,scale:e,flatZ:!0}),t.jsxs("line",{children:[t.jsx("bufferGeometry",{children:t.jsx("bufferAttribute",{attach:"attributes-position",args:[new Float32Array([0,0,0,...R]),3]})}),t.jsx("lineBasicMaterial",{color:j,linewidth:2,transparent:!0,opacity:.6})]}),t.jsxs("line",{children:[t.jsx("bufferGeometry",{children:t.jsx("bufferAttribute",{attach:"attributes-position",args:[new Float32Array([...R,...g]),3]})}),t.jsx("lineBasicMaterial",{color:j,linewidth:2,transparent:!0,opacity:.6})]}),t.jsxs("mesh",{position:[0,0,0],children:[t.jsx("sphereGeometry",{args:[.03,12,12]}),t.jsx("meshBasicMaterial",{color:"#ffffff",transparent:!0,opacity:.7})]}),t.jsxs("mesh",{position:[R[0],R[1],R[2]],children:[t.jsx("sphereGeometry",{args:[.06*Math.sqrt(u.mass1),16,16]}),t.jsx("meshBasicMaterial",{color:A})]}),t.jsx(Ae,{position:[g[0],g[1],g[2]],color:v,lightIntensity:a?.3:.6,size:.8*Math.sqrt(u.mass2),showPulse:!a})]})},re=800,ve=80,ut=.02,ht=()=>{const r=l.useRef(null),{colorTheme:e}=B(),s=U[e],{positions:a,baseSizes:o,phases:n,speeds:c}=l.useMemo(()=>{const p=new Float32Array(re*3),i=new Float32Array(re),f=new Float32Array(re),d=new Float32Array(re);for(let b=0;b<re;b++)p[b*3]=(Math.random()-.5)*ve,p[b*3+1]=(Math.random()-.5)*ve,p[b*3+2]=(Math.random()-.5)*ve,i[b]=Math.random()*1.5+.3,f[b]=Math.random()*Math.PI*2,d[b]=.5+Math.random()*2.5;return{positions:p,baseSizes:i,phases:f,speeds:d}},[]),m=l.useMemo(()=>new Float32Array(re),[]),h=l.useRef(null),u=l.useMemo(()=>new X(s.starColor),[s.starColor]);return W(({clock:p})=>{if(!r.current)return;const i=p.getElapsedTime(),f=i*ut;r.current.rotation.y=f,r.current.rotation.x=f*.3;for(let d=0;d<re;d++){const b=.6+.4*Math.sin(i*c[d]+n[d]);m[d]=o[d]*b}h.current&&(h.current.set(m),h.current.needsUpdate=!0)}),t.jsxs("points",{ref:r,children:[t.jsxs("bufferGeometry",{children:[t.jsx("bufferAttribute",{attach:"attributes-position",args:[a,3]}),t.jsx("bufferAttribute",{ref:h,attach:"attributes-size",args:[new Float32Array(re),1]})]}),t.jsx("pointsMaterial",{color:u,size:.09,transparent:!0,opacity:.5,sizeAttenuation:!0,depthWrite:!1,blending:ne})]})},dt={lorenz:.1,rossler:.5,doublePendulum:1},Be=20,mt={lorenz:.8,rossler:4,doublePendulum:2},pt={lorenz:.4,rossler:2,doublePendulum:.5},ft=.025,gt=.04,yt=()=>{const{cinematicCamera:r,currentSystem:e,isPlaying:s}=B(),{camera:a}=Xe(),o=l.useRef(new O),n=l.useRef(new O),c=l.useRef(!1),m=l.useRef(!1),h=l.useRef(new O),u=l.useRef(new Ke),p=l.useRef(0);return W(()=>{if(r&&!m.current&&(h.current.copy(a.position),u.current.copy(a.rotation),p.current=0,m.current=!0),!r&&m.current){m.current=!1,c.current=!1;return}if(!r){c.current=!1;return}const i=K.system;if(!i?.points||i.points.length<Be+5)return;const f=i.points,d=dt[e]??.1,b=mt[e]??1,C=pt[e]??.5,x=f.length-1,S=Math.max(0,x-Be),y=f[x],P=f[S],T=new O().subVectors(y,P).normalize();T.lengthSq()<.001&&T.set(0,0,1);const k=e==="doublePendulum";let j,A;if(k){const z=new O(y.x*d,y.y*d,0);j=new O(z.x*.3,z.y*.3+.5,b),A=z}else{const z=new O(y.x*d,y.y*d,y.z*d),L=new O(0,1,0),E=new O().crossVectors(T,L);E.lengthSq()<.001&&E.set(1,0,0),E.normalize();const M=T.clone().multiplyScalar(-b*d).add(L.clone().multiplyScalar(C*d)).add(E.clone().multiplyScalar(.15*d));j=z.clone().add(M);const N=Math.min(x,f.length-1),D=f[N];A=new O(D.x*d,D.y*d,D.z*d)}c.current||(o.current.copy(a.position),n.current.copy(A),c.current=!0),p.current=Math.min(1,p.current+.008);const v=p.current,R=v*v*(3-2*v),g=s?ft+(1-R)*.1:.005;o.current.lerp(j,g),n.current.lerp(A,gt+(1-R)*.1),a.position.copy(o.current),a.lookAt(n.current)}),null},bt=[{params:{sigma:10,rho:28,beta:2.667},duration:5,transitionTime:4},{params:{sigma:10,rho:15,beta:2.667},duration:3,transitionTime:5},{params:{sigma:10,rho:24.06,beta:2.667},duration:4,transitionTime:4},{params:{sigma:10,rho:28,beta:2.667},duration:3,transitionTime:3},{params:{sigma:14,rho:35,beta:3},duration:4,transitionTime:5},{params:{sigma:10,rho:99.96,beta:2.667},duration:5,transitionTime:6},{params:{sigma:10,rho:45,beta:2.667},duration:3,transitionTime:4},{params:{sigma:10,rho:28,beta:2.667},duration:3,transitionTime:4}],xt=[{params:{a:.2,b:.2,c:3.5},duration:4,transitionTime:5},{params:{a:.2,b:.2,c:4},duration:3,transitionTime:4},{params:{a:.2,b:.2,c:5},duration:3,transitionTime:4},{params:{a:.2,b:.2,c:5.7},duration:4,transitionTime:3},{params:{a:.2,b:.2,c:8.5},duration:4,transitionTime:5},{params:{a:.3,b:.3,c:12},duration:5,transitionTime:5},{params:{a:.2,b:.2,c:5.7},duration:3,transitionTime:6}],vt=[{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},duration:5,transitionTime:4},{params:{mass1:1,mass2:3,length1:1,length2:1,gravity:9.81,damping:0},duration:4,transitionTime:5},{params:{mass1:2,mass2:1,length1:1.5,length2:.5,gravity:9.81,damping:0},duration:4,transitionTime:5},{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:15,damping:0},duration:4,transitionTime:4},{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:5,damping:.02},duration:5,transitionTime:5},{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},duration:3,transitionTime:4}],St={lorenz:bt,rossler:xt,doublePendulum:vt};function jt(r,e,s){const a={},o=s*s*(3-2*s);for(const n of Object.keys(r)){const c=r[n]??0,m=e[n]??c;a[n]=c+(m-c)*o}return a}const Pt=()=>{const{chaosAutopilot:r,currentSystem:e,setLorenzParams:s,setRosslerParams:a,setDoublePendulumParams:o,setCurrentPreset:n}=B(),c=l.useRef(0),m=l.useRef(0),h=l.useRef("dwell"),u=l.useRef(0);return l.useEffect(()=>{c.current=0,m.current=0,h.current="dwell",u.current=0},[r,e]),W((p,i)=>{if(!r)return;const f=St[e];if(!f||f.length===0)return;const d=m.current%f.length,b=(d+1)%f.length,C=f[d],x=f[b];if(u.current+=i,h.current==="dwell")u.current>=C.duration&&(h.current="transition",u.current=0);else{const S=Math.min(1,u.current/C.transitionTime),y=jt(C.params,x.params,S);switch(e){case"lorenz":s(y);break;case"rossler":a(y);break;case"doublePendulum":o(y);break}n(null),S>=1&&(m.current=b,h.current="dwell",u.current=0)}c.current+=i}),null},J=150,wt=2,De=50,Se=.96,Mt={lorenz:.1,rossler:.5,doublePendulum:1},Rt=()=>{const{isPlaying:r,currentSystem:e,colorTheme:s}=B(),a=U[s],o=l.useRef(null),n=l.useRef(0),c=l.useMemo(()=>({positions:new Float32Array(J*3),velocities:new Float32Array(J*3),lifetimes:new Float32Array(J),colors:new Float32Array(J*4),sizes:new Float32Array(J)}),[]),m=l.useMemo(()=>new Q(new Float32Array(J*3),3),[]),h=l.useMemo(()=>new Q(new Float32Array(J*4),4),[]),u=l.useMemo(()=>new Q(new Float32Array(J),1),[]),p=l.useMemo(()=>{const i=new X(a.accent);return{r:i.r,g:i.g,b:i.b}},[a.accent]);return l.useEffect(()=>{c.lifetimes.fill(0),n.current=0},[e,c]),W(()=>{if(!r||!o.current)return;const i=K.system;if(!i?.points||i.points.length<3)return;const f=i.points,d=Mt[e]??.1,b=f[f.length-1],C=f[f.length-3],x=(b.x-C.x)*d,S=(b.y-C.y)*d,y=(b.z-C.z)*d,P=Math.sqrt(x*x+S*S+y*y),T=Math.max(.01,P*2);for(let v=0;v<wt;v++){const R=n.current,g=R*3;c.positions[g]=b.x*d,c.positions[g+1]=b.y*d,c.positions[g+2]=e==="doublePendulum"?0:b.z*d,c.velocities[g]=(Math.random()-.5)*T-x*.3,c.velocities[g+1]=(Math.random()-.5)*T-S*.3,c.velocities[g+2]=e==="doublePendulum"?(Math.random()-.5)*.02:(Math.random()-.5)*T-y*.3,c.lifetimes[R]=De,c.sizes[R]=(.5+Math.random()*1)*d*.5,n.current=(n.current+1)%J}const k=m.array,j=h.array,A=u.array;for(let v=0;v<J;v++){const R=v*3,g=v*4;if(c.lifetimes[v]<=0){k[R]=0,k[R+1]=0,k[R+2]=-1e3,j[g+3]=0,A[v]=0;continue}c.lifetimes[v]--,c.positions[R]+=c.velocities[R]*.016,c.positions[R+1]+=c.velocities[R+1]*.016,c.positions[R+2]+=c.velocities[R+2]*.016,c.velocities[R]*=Se,c.velocities[R+1]*=Se,c.velocities[R+2]*=Se;const z=c.lifetimes[v]/De,L=z*z,E=.8+Math.sin(c.lifetimes[v]*.5+v*.7)*.2;k[R]=c.positions[R],k[R+1]=c.positions[R+1],k[R+2]=c.positions[R+2],j[g]=p.r*E,j[g+1]=p.g*E,j[g+2]=p.b*E,j[g+3]=L*E,A[v]=c.sizes[v]*(.3+z*.7)}m.needsUpdate=!0,h.needsUpdate=!0,u.needsUpdate=!0}),t.jsxs("points",{ref:o,children:[t.jsxs("bufferGeometry",{children:[t.jsx("primitive",{object:m,attach:"attributes-position"}),t.jsx("primitive",{object:h,attach:"attributes-color"}),t.jsx("primitive",{object:u,attach:"attributes-size"})]}),t.jsx("pointsMaterial",{vertexColors:!0,size:.04,transparent:!0,opacity:.9,depthWrite:!1,blending:ne,sizeAttenuation:!0})]})},Tt={lorenz:.1,rossler:.5,doublePendulum:1},Et=()=>{const{isPlaying:r,currentSystem:e,colorTheme:s,bloomEnabled:a}=B(),o=U[s],n=l.useRef(null),c=l.useRef(null),m=l.useRef(new O),h=l.useRef(0),u=l.useRef(0),p=l.useMemo(()=>new X(o.accent),[o.accent]),i=l.useMemo(()=>new X,[]),f=l.useMemo(()=>new X(1,1,1),[]);return W(()=>{if(!r||!n.current||!c.current)return;const d=K.system;if(!d?.points||d.points.length<3)return;const b=d.points,C=Tt[e]??.1,x=b[b.length-1],S=x.x*C,y=x.y*C,P=e==="doublePendulum"?.1:x.z*C,T=S-m.current.x,k=y-m.current.y,j=P-m.current.z,A=Math.sqrt(T*T+k*k+j*j);m.current.set(S,y,P),h.current+=(A-h.current)*.08;const v=a?.8:.3,R=Math.min(h.current*8,2),g=v+R;u.current+=(g-u.current)*.06,n.current.position.set(S,y,P),n.current.intensity=u.current,n.current.distance=3+h.current*10,c.current.position.set(S,y,P);const z=.03+h.current*.15;c.current.scale.setScalar(z);const L=Math.min(h.current*3,.6);i.copy(p).lerp(f,L),n.current.color.copy(i),c.current.material.color.copy(i)}),t.jsxs(t.Fragment,{children:[t.jsx("pointLight",{ref:n,intensity:.5,distance:5,decay:2,color:o.accent}),t.jsxs("mesh",{ref:c,children:[t.jsx("sphereGeometry",{args:[1,16,16]}),t.jsx("meshBasicMaterial",{color:o.accent,transparent:!0,opacity:.7,depthWrite:!1,blending:ne})]})]})},Y=200,Ct={lorenz:.1,rossler:.5,doublePendulum:1},kt=()=>{const{particleSwarm:r,isPlaying:e,speed:s,currentSystem:a,colorTheme:o,lorenzParams:n,rosslerParams:c,doublePendulumParams:m,_resetCounter:h}=B(),u=U[o],p=l.useRef(null),i=l.useMemo(()=>({systemState:new Float32Array(Y*4),prevX:new Float32Array(Y),prevY:new Float32Array(Y),prevZ:new Float32Array(Y),sizes:new Float32Array(Y),initialized:!1}),[]),f=l.useMemo(()=>new Q(new Float32Array(Y*3),3),[]),d=l.useMemo(()=>new Q(new Float32Array(Y*3),3),[]),b=l.useMemo(()=>new Q(new Float32Array(Y),1),[]),C=l.useMemo(()=>{const y=new X(u.accent);return{r:y.r,g:y.g,b:y.b}},[u.accent]),x=l.useMemo(()=>{const y=new X(u.accent2);return{r:y.r,g:y.g,b:y.b}},[u.accent2]),S=()=>{for(let y=0;y<Y;y++){const P=y*4;a==="doublePendulum"?(i.systemState[P]=Math.PI/2+(Math.random()-.5)*.5,i.systemState[P+1]=Math.PI/2+(Math.random()-.5)*.5,i.systemState[P+2]=(Math.random()-.5)*1,i.systemState[P+3]=(Math.random()-.5)*1):a==="lorenz"?(i.systemState[P]=1+(Math.random()-.5)*4,i.systemState[P+1]=1+(Math.random()-.5)*4,i.systemState[P+2]=1+(Math.random()-.5)*4):(i.systemState[P]=1+(Math.random()-.5)*3,i.systemState[P+1]=1+(Math.random()-.5)*3,i.systemState[P+2]=.5+Math.random()*2),i.prevX[y]=i.systemState[P],i.prevY[y]=i.systemState[P+1],i.prevZ[y]=i.systemState[P+2],i.sizes[y]=.025+Math.random()*.025}i.initialized=!0};return l.useEffect(()=>{r?S():i.initialized=!1},[r,a,h]),W(()=>{if(!r||!e||!p.current||!i.initialized)return;const y=Ct[a]??.1,P=.01*s*.5,T=f.array,k=d.array,j=b.array;if(a==="lorenz"){const{sigma:A,rho:v,beta:R}=n;for(let g=0;g<Y;g++){const z=g*4,L=g*3;let E=i.systemState[z],M=i.systemState[z+1],N=i.systemState[z+2];const D=A*(M-E),q=E*(v-N)-M,H=E*M-R*N;E+=D*P,M+=q*P,N+=H*P,(!isFinite(E)||!isFinite(M)||!isFinite(N)||Math.abs(E)>1e6)&&(E=1+(Math.random()-.5)*4,M=1+(Math.random()-.5)*4,N=1+(Math.random()-.5)*4),i.systemState[z]=E,i.systemState[z+1]=M,i.systemState[z+2]=N,T[L]=E*y,T[L+1]=M*y,T[L+2]=N*y;const _=E-i.prevX[g],$=M-i.prevY[g],I=N-i.prevZ[g],G=Math.sqrt(_*_+$*$+I*I),F=Math.min(1,G*.15);k[L]=C.r*(1-F)+x.r*F,k[L+1]=C.g*(1-F)+x.g*F,k[L+2]=C.b*(1-F)+x.b*F,j[g]=i.sizes[g]*(.6+F*.4),i.prevX[g]=E,i.prevY[g]=M,i.prevZ[g]=N}}else if(a==="rossler"){const{a:A,b:v,c:R}=c;for(let g=0;g<Y;g++){const z=g*4,L=g*3;let E=i.systemState[z],M=i.systemState[z+1],N=i.systemState[z+2];const D=-M-N,q=E+A*M,H=v+N*(E-R);E+=D*P,M+=q*P,N+=H*P,(!isFinite(E)||!isFinite(M)||!isFinite(N)||Math.abs(E)>1e6)&&(E=1+(Math.random()-.5)*3,M=1+(Math.random()-.5)*3,N=.5+Math.random()*2),i.systemState[z]=E,i.systemState[z+1]=M,i.systemState[z+2]=N,T[L]=E*y,T[L+1]=M*y,T[L+2]=N*y;const _=E-i.prevX[g],$=M-i.prevY[g],I=N-i.prevZ[g],G=Math.sqrt(_*_+$*$+I*I),F=Math.min(1,G*.1);k[L]=C.r*(1-F)+x.r*F,k[L+1]=C.g*(1-F)+x.g*F,k[L+2]=C.b*(1-F)+x.b*F,j[g]=i.sizes[g]*(.6+F*.4),i.prevX[g]=E,i.prevY[g]=M,i.prevZ[g]=N}}else{const{mass1:A,mass2:v,length1:R,length2:g,gravity:z,damping:L}=m,E=A,M=v,N=R,D=g,q=z;for(let H=0;H<Y;H++){const _=H*4,$=H*3;let I=i.systemState[_],G=i.systemState[_+1],F=i.systemState[_+2],V=i.systemState[_+3];const se=Math.cos(I-G),oe=Math.sin(I-G),me=Math.sin(I),ue=Math.sin(G),he=(E+M)*N-M*N*se*se,ie=D/N*he,xe=-M*N*F*F*oe*se+M*q*ue*se+M*D*V*V*oe-(E+M)*q*me,de=-M*D*V*V*oe*se+(E+M)*q*me*se+(E+M)*N*F*F*oe-(E+M)*q*ue;let pe=he!==0?xe/he:0,le=ie!==0?de/ie:0;pe-=L*F,le-=L*V,I+=F*P,G+=V*P,F+=pe*P,V+=le*P,(!isFinite(I)||!isFinite(F)||Math.abs(F)>1e6)&&(I=Math.PI/2+(Math.random()-.5)*.5,G=Math.PI/2+(Math.random()-.5)*.5,F=0,V=0),i.systemState[_]=I,i.systemState[_+1]=G,i.systemState[_+2]=F,i.systemState[_+3]=V;const fe=N*Math.sin(I)+D*Math.sin(G),ge=-N*Math.cos(I)-D*Math.cos(G);T[$]=fe*y,T[$+1]=ge*y,T[$+2]=0;const Z=Math.sqrt(F*F+V*V),ee=Math.min(1,Z*.15);k[$]=C.r*(1-ee)+x.r*ee,k[$+1]=C.g*(1-ee)+x.g*ee,k[$+2]=C.b*(1-ee)+x.b*ee,j[H]=i.sizes[H]*(.6+ee*.4),i.prevX[H]=fe,i.prevY[H]=ge,i.prevZ[H]=0}}f.needsUpdate=!0,d.needsUpdate=!0,b.needsUpdate=!0}),r?t.jsxs("points",{ref:p,children:[t.jsxs("bufferGeometry",{children:[t.jsx("primitive",{object:f,attach:"attributes-position"}),t.jsx("primitive",{object:d,attach:"attributes-color"}),t.jsx("primitive",{object:b,attach:"attributes-size"})]}),t.jsx("pointsMaterial",{vertexColors:!0,size:.04,transparent:!0,opacity:.75,depthWrite:!1,blending:ne,sizeAttenuation:!0})]}):null},_e={lorenz:{position:[10,10,10],fov:60},rossler:{position:[8,8,8],fov:60},doublePendulum:{position:[0,0,5],fov:50}},At=()=>{const{autoRotate:r,currentSystem:e,cinematicCamera:s}=B();return s?null:t.jsx(Qe,{enablePan:!0,enableZoom:!0,enableRotate:!0,autoRotate:r&&e!=="doublePendulum",autoRotateSpeed:2,maxPolarAngle:Math.PI,minDistance:2,maxDistance:20})},zt=({posA:r,posB:e})=>{const{setDivergence:s,sideBySideMode:a}=B(),o=l.useRef(0);return W(()=>{if(!a||(o.current++,o.current%6!==0))return;const n=r.current,c=e.current;n&&c&&s(n.distanceTo(c))}),null},je=({position:r=[0,0,0],initialCondition:e,colorHue:s=.6,isSecondary:a=!1,lastPosRef:o})=>{const{currentSystem:n}=B();switch(n){case"lorenz":return t.jsx(nt,{position:r,initialCondition:e||[1,1,1],colorHue:s,isSecondary:a,lastPosRef:o});case"rossler":return t.jsx(it,{position:r,initialCondition:e||[1,1,1],colorHue:s,isSecondary:a,lastPosRef:o});case"doublePendulum":return t.jsx(ct,{position:r,initialCondition:e||{theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0},colorHue:s,isSecondary:a,lastPosRef:o});default:return null}},Nt=()=>{const{bloomEnabled:r,bloomIntensity:e,isPlaying:s}=B(),a=l.useRef(null),o=l.useRef(e);return W(()=>{if(!r||!a.current)return;if(!s){a.current.intensity=e;return}const n=K.system;if(!n?.points||n.points.length<5){a.current.intensity=e;return}const c=n.points,m=c[c.length-1],h=c[c.length-4],u=m.x-h.x,p=m.y-h.y,i=m.z-h.z,f=Math.sqrt(u*u+p*p+i*i),d=1+Math.min(f*.02,.3),b=e*d;o.current+=(b-o.current)*.05,a.current.intensity=o.current}),r?t.jsx(et,{children:t.jsx(tt,{ref:a,intensity:e,luminanceThreshold:.1,luminanceSmoothing:.9,mipmapBlur:!0})}):null},Ft=()=>{const{sideBySideMode:r,currentSystem:e,initialOffset:s,colorTheme:a}=B(),o=U[a],n=l.useRef(null),c=l.useRef(null);return t.jsxs(t.Fragment,{children:[t.jsx("ambientLight",{intensity:.2}),t.jsx("directionalLight",{position:[10,10,5],intensity:.3}),t.jsx(ht,{}),e==="doublePendulum"&&t.jsx(Je,{args:[10,10],position:[0,-3,0],cellColor:"#222233",sectionColor:"#333355",fadeDistance:25,fadeStrength:1}),r?t.jsxs(t.Fragment,{children:[t.jsx(je,{position:[0,0,0],initialCondition:e==="doublePendulum"?{theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0}:[1,1,1],colorHue:o.trailHue1,isSecondary:!1,lastPosRef:n}),t.jsx(je,{position:[0,0,0],initialCondition:e==="doublePendulum"?{theta1:Math.PI/2+s,theta2:Math.PI/2,omega1:0,omega2:0}:[1+s,1,1],colorHue:o.trailHue2,isSecondary:!0,lastPosRef:c}),t.jsx(zt,{posA:n,posB:c})]}):t.jsx(je,{}),t.jsx(At,{}),t.jsx(yt,{}),t.jsx(Pt,{}),t.jsx(Rt,{}),t.jsx(Et,{}),t.jsx(kt,{}),t.jsx(Nt,{})]})};class Lt extends l.Component{state={hasError:!1,error:null};static getDerivedStateFromError(e){return{hasError:!0,error:e}}handleRetry=()=>{this.setState({hasError:!1,error:null})};render(){return this.state.hasError?t.jsxs("div",{style:{width:"100vw",height:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:"#000010",color:"#ccc",fontFamily:"system-ui, sans-serif",textAlign:"center",padding:"2rem"},children:[t.jsx("h2",{style:{color:"#ff6666",marginBottom:"1rem"},children:"âš ï¸ Rendering Error"}),t.jsx("p",{style:{maxWidth:"400px",lineHeight:1.6,marginBottom:"1rem"},children:"The 3D visualization encountered an error. This can happen if WebGL is not available or if GPU resources were exhausted."}),t.jsx("code",{style:{background:"rgba(255,255,255,0.05)",padding:"8px 16px",borderRadius:"6px",fontSize:"12px",color:"#ff9999",marginBottom:"1.5rem",maxWidth:"80vw",overflow:"auto"},children:this.state.error?.message||"Unknown error"}),t.jsx("button",{onClick:this.handleRetry,style:{padding:"12px 24px",background:"#88ccff",color:"#000",border:"none",borderRadius:"8px",fontSize:"14px",fontWeight:600,cursor:"pointer"},children:"ðŸ”„ Retry"})]}):this.props.children}}const It=()=>{const{currentSystem:r,colorTheme:e}=B(),s=U[e],a=_e[r]??_e.lorenz;return t.jsx(Lt,{children:t.jsx("div",{style:{width:"100vw",height:"100vh",background:s.bg},role:"img","aria-label":`3D visualization of ${r==="lorenz"?"Lorenz attractor":r==="rossler"?"RÃ¶ssler attractor":"double pendulum"} chaos system`,children:t.jsxs(Ze,{camera:{position:a.position,fov:a.fov},gl:{antialias:!0,alpha:!0,powerPreference:"high-performance",preserveDrawingBuffer:!0},children:[t.jsx("color",{attach:"background",args:[s.bg]}),t.jsx("fog",{attach:"fog",args:[s.bg,30,60]}),t.jsx(l.Suspense,{fallback:null,children:t.jsx(Ft,{})})]})})})},Bt={classic:"ðŸŒŒ Classic",neon:"ðŸ’œ Neon",blueprint:"ðŸ“ Blueprint",terminal:"ðŸ’» Terminal"},Dt={lorenz:"ðŸ¦‹ Lorenz",rossler:"ðŸŒ€ RÃ¶ssler",doublePendulum:"âš¡ Pendulum"},_t=()=>{const[r,e]=l.useState(!1),[s,a]=l.useState(!1);l.useEffect(()=>{const w=()=>a(window.innerWidth<=768);return w(),window.addEventListener("resize",w),()=>window.removeEventListener("resize",w)},[]);const{currentSystem:o,setCurrentSystem:n,isPlaying:c,setIsPlaying:m,speed:h,setSpeed:u,trailLength:p,setTrailLength:i,sideBySideMode:f,setSideBySideMode:d,initialOffset:b,setInitialOffset:C,autoRotate:x,setAutoRotate:S,currentPreset:y,setCurrentPreset:P,colorTheme:T,setColorTheme:k,lorenzParams:j,setLorenzParams:A,rosslerParams:v,setRosslerParams:R,doublePendulumParams:g,setDoublePendulumParams:z,resetSimulation:L,showLyapunov:E,setShowLyapunov:M,showBifurcation:N,setShowBifurcation:D,showPoincare:q,setShowPoincare:H,showParameterSpace:_,setShowParameterSpace:$,cinematicCamera:I,setCinematicCamera:G,chaosAutopilot:F,setChaosAutopilot:V,setStoryMode:se,bloomEnabled:oe,setBloomEnabled:me,bloomIntensity:ue,setBloomIntensity:he,audioEnabled:ie,setAudioEnabled:xe,audioVolume:de,setAudioVolume:pe,particleSwarm:le,setParticleSwarm:fe,perturbSystem:ge}=B(),Z=U[T],ee=w=>{const ye=Ie[o].find(Ve=>Ve.name===w);if(ye){switch(o){case"lorenz":A(ye.params);break;case"rossler":R(ye.params);break;case"doublePendulum":z(ye.params);break}P(w)}},Ge=w=>{n(w),P(null)},ze=w=>w>=.01?w.toFixed(3):w.toExponential(1),Ue=()=>{switch(o){case"lorenz":return t.jsxs("div",{className:"parameter-group",role:"group","aria-label":"Lorenz system parameters",children:[t.jsx("h4",{children:"Lorenz Parameters"}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"sigma-slider",children:["Ïƒ (sigma): ",j.sigma.toFixed(2)]}),t.jsx("input",{id:"sigma-slider",type:"range",min:"0.1",max:"30",step:"0.1",value:j.sigma,"aria-valuemin":.1,"aria-valuemax":30,"aria-valuenow":j.sigma,"aria-label":`Sigma: ${j.sigma.toFixed(2)}`,onChange:w=>A({sigma:parseFloat(w.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"rho-slider",children:["Ï (rho): ",j.rho.toFixed(2)]}),t.jsx("input",{id:"rho-slider",type:"range",min:"0.1",max:"50",step:"0.1",value:j.rho,"aria-valuemin":.1,"aria-valuemax":50,"aria-valuenow":j.rho,"aria-label":`Rho: ${j.rho.toFixed(2)}`,onChange:w=>A({rho:parseFloat(w.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"beta-slider",children:["Î² (beta): ",j.beta.toFixed(3)]}),t.jsx("input",{id:"beta-slider",type:"range",min:"0.1",max:"10",step:"0.01",value:j.beta,"aria-valuemin":.1,"aria-valuemax":10,"aria-valuenow":j.beta,"aria-label":`Beta: ${j.beta.toFixed(3)}`,onChange:w=>A({beta:parseFloat(w.target.value)})})]})]});case"rossler":return t.jsxs("div",{className:"parameter-group",role:"group","aria-label":"RÃ¶ssler system parameters",children:[t.jsx("h4",{children:"RÃ¶ssler Parameters"}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"a-slider",children:["a: ",v.a.toFixed(3)]}),t.jsx("input",{id:"a-slider",type:"range",min:"0.01",max:"1.0",step:"0.01",value:v.a,"aria-label":`Parameter a: ${v.a.toFixed(3)}`,onChange:w=>R({a:parseFloat(w.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"b-slider",children:["b: ",v.b.toFixed(3)]}),t.jsx("input",{id:"b-slider",type:"range",min:"0.01",max:"1.0",step:"0.01",value:v.b,"aria-label":`Parameter b: ${v.b.toFixed(3)}`,onChange:w=>R({b:parseFloat(w.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"c-slider",children:["c: ",v.c.toFixed(2)]}),t.jsx("input",{id:"c-slider",type:"range",min:"1.0",max:"20.0",step:"0.1",value:v.c,"aria-label":`Parameter c: ${v.c.toFixed(2)}`,onChange:w=>R({c:parseFloat(w.target.value)})})]})]});case"doublePendulum":return t.jsxs("div",{className:"parameter-group",role:"group","aria-label":"Double pendulum parameters",children:[t.jsx("h4",{children:"Pendulum Parameters"}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"mass1-slider",children:["Mass 1: ",g.mass1.toFixed(2)]}),t.jsx("input",{id:"mass1-slider",type:"range",min:"0.1",max:"5.0",step:"0.1",value:g.mass1,"aria-label":`Mass 1: ${g.mass1.toFixed(2)}`,onChange:w=>z({mass1:parseFloat(w.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"mass2-slider",children:["Mass 2: ",g.mass2.toFixed(2)]}),t.jsx("input",{id:"mass2-slider",type:"range",min:"0.1",max:"5.0",step:"0.1",value:g.mass2,"aria-label":`Mass 2: ${g.mass2.toFixed(2)}`,onChange:w=>z({mass2:parseFloat(w.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"len1-slider",children:["Length 1: ",g.length1.toFixed(2)]}),t.jsx("input",{id:"len1-slider",type:"range",min:"0.2",max:"2.0",step:"0.1",value:g.length1,"aria-label":`Length 1: ${g.length1.toFixed(2)}`,onChange:w=>z({length1:parseFloat(w.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"len2-slider",children:["Length 2: ",g.length2.toFixed(2)]}),t.jsx("input",{id:"len2-slider",type:"range",min:"0.2",max:"2.0",step:"0.1",value:g.length2,"aria-label":`Length 2: ${g.length2.toFixed(2)}`,onChange:w=>z({length2:parseFloat(w.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"gravity-slider",children:["Gravity: ",g.gravity.toFixed(2)]}),t.jsx("input",{id:"gravity-slider",type:"range",min:"1.0",max:"20.0",step:"0.1",value:g.gravity,"aria-label":`Gravity: ${g.gravity.toFixed(2)}`,onChange:w=>z({gravity:parseFloat(w.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"damping-slider",children:["Damping: ",g.damping.toFixed(3)]}),t.jsx("input",{id:"damping-slider",type:"range",min:"0.0",max:"0.2",step:"0.005",value:g.damping,"aria-label":`Damping: ${g.damping.toFixed(3)}`,onChange:w=>z({damping:parseFloat(w.target.value)})})]})]});default:return null}};return t.jsxs("aside",{className:`controls ${r?"collapsed":""} ${s?"mobile":""}`,role:"region","aria-label":"Simulation controls",style:{"--panel-bg":Z.panelBg,"--panel-border":Z.panelBorder,"--text-color":Z.text,"--text-muted":Z.textMuted,"--accent":Z.accent,"--accent2":Z.accent2,"--heading":Z.heading,"--param-color":Z.paramColor},children:[t.jsx("button",{className:"controls-toggle",onClick:()=>e(!r),"aria-label":r?"Show controls":"Hide controls","aria-expanded":!r,children:r?"âš™ï¸":"âœ•"}),!r&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{id:"system-heading",children:"Chaos System"}),t.jsx("div",{className:"system-tabs",role:"tablist","aria-labelledby":"system-heading",children:["lorenz","rossler","doublePendulum"].map(w=>t.jsx("button",{role:"tab","aria-selected":o===w,"aria-label":`Select ${w==="doublePendulum"?"Double Pendulum":w} system`,className:`system-tab ${o===w?"active":""}`,onClick:()=>Ge(w),children:Dt[w]},w))})]}),t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{children:"Simulation"}),t.jsxs("div",{className:"button-group",children:[t.jsx("button",{onClick:()=>m(!c),className:`play-button ${c?"playing":"paused"}`,"aria-label":c?"Pause simulation":"Play simulation",children:c?"â¸ Pause":"â–¶ Play"}),t.jsx("button",{onClick:L,className:"reset-button","aria-label":"Reset simulation",children:"ðŸ”„ Reset"})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"speed-slider",children:["Speed: ",h.toFixed(1),"x"]}),t.jsx("input",{id:"speed-slider",type:"range",min:"0.1",max:"5.0",step:"0.1",value:h,"aria-label":`Simulation speed: ${h.toFixed(1)}x`,onChange:w=>u(parseFloat(w.target.value))})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"trail-slider",children:["Trail: ",p,p>3e3&&t.jsx("span",{className:"warn",children:" âš ï¸ High"})]}),t.jsx("input",{id:"trail-slider",type:"range",min:"100",max:"5000",step:"100",value:p,"aria-label":`Trail length: ${p} points`,onChange:w=>i(parseInt(w.target.value))})]})]}),t.jsxs("div",{className:"control-section butterfly-section",children:[t.jsx("h3",{children:"ðŸ¦‹ Butterfly Effect"}),t.jsx("div",{className:"checkbox-group",children:t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:f,"aria-label":"Enable butterfly mode: show two systems with tiny initial difference",onChange:w=>{d(w.target.checked),w.target.checked&&L()}}),"Enable Butterfly Mode"]})}),f&&t.jsxs("div",{className:"slider-group offset-slider",children:[t.jsxs("label",{htmlFor:"offset-slider",children:["Initial Offset: ",t.jsx("span",{className:"offset-value",children:ze(b)})]}),t.jsx("input",{id:"offset-slider",type:"range",min:"-6",max:"-0.5",step:"0.1",value:Math.log10(b),"aria-label":`Initial offset between systems: ${ze(b)}`,onChange:w=>{C(Math.pow(10,parseFloat(w.target.value))),L()}}),t.jsxs("div",{className:"offset-labels","aria-hidden":"true",children:[t.jsx("span",{children:"Tiny"}),t.jsx("span",{children:"Large"})]})]})]}),t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{children:"View"}),o!=="doublePendulum"&&t.jsx("div",{className:"checkbox-group",children:t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:x,"aria-label":"Auto-rotate camera around the attractor",onChange:w=>S(w.target.checked)}),"Auto Rotate"]})}),t.jsx("div",{className:"checkbox-group",children:t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:oe,"aria-label":"Toggle bloom glow post-processing effect",onChange:w=>me(w.target.checked)}),"âœ¨ Bloom Glow"]})}),oe&&t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"bloom-intensity",children:["Bloom: ",ue.toFixed(1)]}),t.jsx("input",{id:"bloom-intensity",type:"range",min:"0.2",max:"4.0",step:"0.1",value:ue,"aria-label":`Bloom intensity: ${ue.toFixed(1)}`,onChange:w=>he(parseFloat(w.target.value))})]})]}),t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{children:"âœ¨ Experience"}),t.jsxs("div",{className:"experience-buttons",children:[t.jsx("button",{className:`experience-btn cinematic ${I?"active":""}`,onClick:()=>G(!I),"aria-pressed":I,"aria-label":"Toggle cinematic chase camera that follows the trail",children:"ðŸŽ¬ Chase Cam"}),t.jsx("button",{className:`experience-btn autopilot ${F?"active":""}`,onClick:()=>V(!F),"aria-pressed":F,"aria-label":"Toggle chaos autopilot that morphs parameters automatically",children:"ðŸ¤– Autopilot"}),t.jsx("button",{className:`experience-btn audio ${ie?"active":""}`,onClick:()=>xe(!ie),"aria-pressed":ie,"aria-label":"Toggle chaos sonification â€” hear the attractor as sound",children:"ðŸ”Š Sonify"}),t.jsx("button",{className:`experience-btn swarm ${le?"active":""}`,onClick:()=>fe(!le),"aria-pressed":le,"aria-label":"Toggle particle swarm â€” 200 particles trace the attractor simultaneously",children:"ðŸ¦ Particle Swarm"}),t.jsx("button",{className:"experience-btn perturb",onClick:ge,"aria-label":"Apply random perturbation â€” nudge the system to see chaos in action",children:"âš¡ Perturb"}),t.jsx("button",{className:"experience-btn story",onClick:()=>{se(!0),S(!0)},"aria-label":"Launch guided story mode tour",children:"ðŸ“– Story Mode"})]}),ie&&t.jsxs("div",{className:"audio-controls",children:[t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"audio-volume",children:["Volume: ",Math.round(de*100),"%"]}),t.jsx("input",{id:"audio-volume",type:"range",min:"0",max:"1",step:"0.05",value:de,"aria-label":`Audio volume: ${Math.round(de*100)}%`,onChange:w=>pe(parseFloat(w.target.value))})]}),t.jsx("div",{className:"autopilot-hint",children:"ðŸŽµ Listening to chaos â€” pitch follows position, volume follows velocity"})]}),F&&t.jsx("div",{className:"autopilot-hint",children:"Parameters are morphing through interesting regions..."}),I&&t.jsx("div",{className:"autopilot-hint",children:"Camera is following the trail head. Orbit controls disabled."}),le&&t.jsx("div",{className:"autopilot-hint",children:"ðŸ¦ 200 particles are swarming through the attractor..."})]}),t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{id:"theme-heading",children:"Theme"}),t.jsx("div",{className:"theme-grid",role:"radiogroup","aria-labelledby":"theme-heading",children:Object.keys(U).map(w=>t.jsx("button",{role:"radio","aria-checked":T===w,"aria-label":`${w} theme`,className:`theme-btn ${T===w?"active":""}`,onClick:()=>k(w),style:{"--tbg":U[w].bg,"--taccent":U[w].accent},children:Bt[w]},w))})]}),t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{children:"Presets"}),t.jsx("div",{className:"preset-chips",role:"group","aria-label":"Parameter presets",children:Ie[o].map(w=>t.jsx("button",{className:`preset-chip ${y===w.name?"active":""}`,onClick:()=>ee(w.name),"aria-label":`${w.name}: ${w.description}`,"aria-pressed":y===w.name,children:w.name},w.name))})]}),Ue(),o!=="doublePendulum"&&t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{children:"ðŸ”¬ Analysis"}),t.jsxs("div",{className:"analysis-buttons",children:[t.jsx("button",{className:`analysis-btn ${E?"active":""}`,onClick:()=>M(!E),"aria-pressed":E,"aria-label":"Toggle Lyapunov exponent indicator",children:"Î» Lyapunov"}),t.jsx("button",{className:`analysis-btn ${N?"active":""}`,onClick:()=>D(!N),"aria-pressed":N,"aria-label":"Toggle bifurcation diagram",children:"ðŸ“ˆ Bifurcation"}),t.jsx("button",{className:`analysis-btn ${q?"active":""}`,onClick:()=>H(!q),"aria-pressed":q,"aria-label":"Toggle PoincarÃ© section",children:"â—Ž PoincarÃ©"}),t.jsx("button",{className:`analysis-btn ${_?"active":""}`,onClick:()=>$(!_),"aria-pressed":_,"aria-label":"Toggle parameter space explorer",children:"ðŸ—ºï¸ Param Space"})]})]})]})]})},Ot={lorenz:{title:"Lorenz Attractor",description:"The Lorenz attractor is a set of chaotic solutions of the Lorenz system, discovered by Edward Lorenz in 1963. It arises from a simplified model of atmospheric convection.",equations:["dx/dt = Ïƒ(y - x)","dy/dt = x(Ï - z) - y","dz/dt = xy - Î²z"],whatMakesChaotic:'The system is chaotic because small changes in initial conditions lead to drastically different outcomes over time. This is the famous "butterfly effect" â€” a butterfly flapping its wings in Brazil could theoretically cause a tornado in Texas.',parameters:{"Ïƒ (sigma)":"Prandtl number â€” relates viscosity to thermal conductivity","Ï (rho)":"Rayleigh number â€” measures temperature difference","Î² (beta)":"Geometric factor related to the size of convection cells"}},rossler:{title:"RÃ¶ssler Attractor",description:"The RÃ¶ssler attractor is another chaotic system, developed by Otto RÃ¶ssler in 1976. It was designed to be simpler than the Lorenz system while still exhibiting chaotic behavior.",equations:["dx/dt = -y - z","dy/dt = x + ay","dz/dt = b + z(x - c)"],whatMakesChaotic:"The RÃ¶ssler system shows how even simple nonlinear equations can produce chaos. The attractor has a characteristic spiral structure that folds back on itself, creating sensitive dependence on initial conditions.",parameters:{a:"Controls the rate of expansion in the y direction",b:"Constant term that affects the z component",c:"Controls the folding and stretching of the attractor"}},doublePendulum:{title:"Double Pendulum",description:"A double pendulum consists of two pendulums attached end to end. Despite being a deterministic system governed by well-known physical laws, it exhibits chaotic motion.",equations:["Complex coupled differential equations","involving angles Î¸â‚, Î¸â‚‚ and their","angular velocities Ï‰â‚, Ï‰â‚‚"],whatMakesChaotic:"The chaos arises from the nonlinear coupling between the two pendulums. Small changes in the initial angles or velocities can lead to completely different trajectories. This demonstrates that chaos can emerge from simple, everyday systems.",parameters:{"Mass 1, Mass 2":"Masses of the first and second pendulum bobs","Length 1, Length 2":"Lengths of the first and second pendulum arms",Gravity:"Gravitational acceleration",Damping:"Energy loss due to friction (0 = no damping)"}}},$t=()=>{const{currentSystem:r,showInfoPanel:e,setShowInfoPanel:s}=B();if(!e)return t.jsx("button",{className:"info-toggle collapsed",onClick:()=>s(!0),"aria-label":"Show system information panel",children:"â„¹ï¸"});const a=Ot[r];return t.jsxs("aside",{className:"info-panel",role:"complementary","aria-label":"System information",children:[t.jsxs("div",{className:"info-header",children:[t.jsx("h2",{children:a.title}),t.jsx("button",{className:"info-close",onClick:()=>s(!1),"aria-label":"Close information panel",children:"âœ•"})]}),t.jsxs("div",{className:"info-content",children:[t.jsxs("section",{"aria-labelledby":"info-overview",children:[t.jsx("h3",{id:"info-overview",children:"Overview"}),t.jsx("p",{children:a.description})]}),t.jsxs("section",{"aria-labelledby":"info-equations",children:[t.jsx("h3",{id:"info-equations",children:"Equations"}),t.jsx("div",{className:"equations",role:"math","aria-label":"System equations",children:a.equations.map((o,n)=>t.jsx("div",{className:"equation",children:o},n))})]}),t.jsxs("section",{"aria-labelledby":"info-chaos",children:[t.jsx("h3",{id:"info-chaos",children:"What Makes It Chaotic?"}),t.jsx("p",{children:a.whatMakesChaotic})]}),t.jsxs("section",{"aria-labelledby":"info-params",children:[t.jsx("h3",{id:"info-params",children:"Parameters"}),t.jsx("dl",{className:"parameters",children:Object.entries(a.parameters).map(([o,n])=>t.jsxs("div",{className:"parameter",children:[t.jsx("dt",{children:t.jsx("strong",{children:o})}),t.jsx("dd",{children:n})]},o))})]}),t.jsxs("section",{"aria-labelledby":"info-tips",children:[t.jsx("h3",{id:"info-tips",children:"Tips"}),t.jsxs("ul",{children:[t.jsx("li",{children:"Try the side-by-side mode to see how small changes create big differences"}),t.jsx("li",{children:"Experiment with different presets to explore various behaviors"}),t.jsx("li",{children:"Adjust the trail length to see more or less of the trajectory"}),t.jsx("li",{children:"Use the speed control to slow down and observe the motion closely"})]})]})]})]})},ce=[{title:"Welcome to Chaos Lab! ðŸ¦‹",description:"Explore the beautiful world of chaos theory through interactive visualizations. Watch as simple equations create complex, unpredictable patterns."},{title:"Try Side-by-Side Mode",description:"Enable 'Butterfly Mode' to see the butterfly effect in action. Two systems with tiny differences will evolve completely differently!",highlight:"side-by-side"},{title:"Experiment with Parameters",description:"Adjust the sliders to see how small changes in parameters can dramatically alter the behavior. Try the preset configurations for interesting starting points.",highlight:"parameters"},{title:"Explore Different Systems",description:"Switch between Lorenz Attractor, RÃ¶ssler Attractor, and Double Pendulum to see different types of chaotic behavior.",highlight:"systems"},{title:"Hear the Chaos ðŸ”Š",description:"Press M or click 'Sonify' to hear the chaos as sound! The pitch follows the attractor's position and the volume pulses with its velocity. Best with headphones.",highlight:"audio"},{title:"Learn More",description:"Click the info button (â„¹ï¸) to learn about the mathematics and physics behind each system. Ready to explore chaos?",highlight:"info"}],qt=()=>{const[r,e]=l.useState(!1),[s,a]=l.useState(0),{setSideBySideMode:o,setShowInfoPanel:n}=B(),c=l.useRef(null);l.useEffect(()=>{localStorage.getItem("chaosLabTutorial")||e(!0)},[]),l.useEffect(()=>{r&&c.current&&c.current.focus()},[r,s]);const m=l.useCallback(()=>{localStorage.setItem("chaosLabTutorial","completed"),e(!1)},[]),h=l.useCallback(()=>{s<ce.length-1?a(s+1):m()},[s,m]),u=l.useCallback(()=>{switch(ce[s].highlight){case"side-by-side":o(!0);break;case"info":n(!0);break}h()},[s,h,o,n]),p=l.useCallback(d=>{d.key==="Escape"?m():(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),h())},[m,h]);if(!r)return null;const i=ce[s],f=s===ce.length-1;return t.jsx("div",{className:"quick-start-overlay",role:"dialog","aria-modal":"true","aria-label":"Quick start tutorial",onKeyDown:p,children:t.jsxs("div",{className:"quick-start-modal",ref:c,tabIndex:-1,children:[t.jsxs("div",{className:"quick-start-header",children:[t.jsx("h2",{id:"qs-title",children:i.title}),t.jsx("button",{className:"quick-start-close",onClick:m,"aria-label":"Close tutorial",children:"âœ•"})]}),t.jsxs("div",{className:"quick-start-content",children:[t.jsx("p",{id:"qs-desc",children:i.description}),t.jsx("div",{className:"quick-start-progress",role:"progressbar","aria-valuenow":s+1,"aria-valuemin":1,"aria-valuemax":ce.length,"aria-label":`Step ${s+1} of ${ce.length}`,children:ce.map((d,b)=>t.jsx("div",{className:`progress-dot ${b<=s?"active":""}`,"aria-hidden":"true"},b))})]}),t.jsxs("div",{className:"quick-start-actions",children:[t.jsx("button",{className:"quick-start-skip",onClick:m,children:"Skip Tutorial"}),t.jsx("button",{className:"quick-start-next",onClick:i.highlight?u:h,"aria-describedby":"qs-desc",children:f?"Let's Explore!":"Next"})]})]})})},Ht=()=>{const{sideBySideMode:r,divergence:e,colorTheme:s}=B(),a=U[s];if(!r)return null;const o=Math.log10(Math.max(e,1e-4)),n=Math.min(1,Math.max(0,(o+4)/6)),c=Math.round(n*100),m=(1-n)*120,h=e<.001?e.toExponential(2):e.toFixed(3);return t.jsxs("div",{className:"divergence-meter",role:"meter","aria-label":"Divergence between the two systems","aria-valuenow":n,"aria-valuemin":0,"aria-valuemax":1,"aria-valuetext":`Divergence: ${h}`,children:[t.jsx("div",{className:"divergence-label",style:{color:a.textMuted},children:"Divergence"}),t.jsx("div",{className:"divergence-bar-track",children:t.jsx("div",{className:"divergence-bar-fill",style:{width:`${c}%`,background:`hsl(${m}, 90%, 55%)`,boxShadow:`0 0 10px hsla(${m}, 90%, 55%, 0.5), 0 0 20px hsla(${m}, 90%, 55%, 0.2)`}})}),t.jsx("div",{className:"divergence-value",style:{color:`hsl(${m}, 80%, 65%)`,textShadow:`0 0 12px hsla(${m}, 90%, 55%, 0.4)`},children:h})]})},Gt=()=>{const{showLyapunov:r,lyapunovExponent:e,colorTheme:s}=B(),a=U[s],o=l.useRef("");if(!r)return null;const c=(Math.max(-2,Math.min(3,e))+2)/5,m=(1-c)*120,h=Math.min(100,Math.max(5,c*100)),u=e>.1?"Chaotic":e>-.05?"Edge of Chaos":"Stable",p=e>.1?"ðŸ”´":e>-.05?"ðŸŸ¡":"ðŸŸ¢",i=o.current!==u;return i&&(o.current=u),t.jsxs("div",{className:"lyapunov-indicator",role:"region","aria-label":`Lyapunov exponent indicator: system is ${u}`,style:{"--panel-bg":a.panelBg,"--panel-border":a.panelBorder,"--text":a.text,"--text-muted":a.textMuted,"--bar-hue":m},children:[t.jsxs("div",{className:"lyapunov-header",children:[t.jsx("span",{className:"lyapunov-label",children:"Î» (Lyapunov)"}),t.jsxs("span",{className:"lyapunov-status","aria-hidden":"true",children:[p," ",u]})]}),t.jsxs("div",{className:"lyapunov-value",style:{color:`hsl(${m}, 90%, 60%)`},children:["Î» = ",e.toFixed(3)]}),t.jsxs("div",{className:"lyapunov-bar-track",role:"meter","aria-valuenow":e,"aria-valuemin":-2,"aria-valuemax":3,"aria-label":"Lyapunov exponent",children:[t.jsx("div",{className:"lyapunov-bar-fill",style:{width:`${h}%`,background:`hsl(${m}, 85%, 50%)`,boxShadow:`0 0 10px hsla(${m}, 85%, 50%, 0.6)`}}),t.jsx("div",{className:"lyapunov-bar-zero","aria-hidden":"true"})]}),t.jsx("div",{className:"lyapunov-hint",children:"Measures how fast nearby paths diverge. Positive = chaos."}),i&&t.jsxs("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:["System is now ",u,", Lyapunov exponent: ",e.toFixed(2)]})]})},Ut=[{key:"Space",action:"Play / Pause simulation"},{key:"R",action:"Reset simulation"},{key:"1",action:"Switch to Lorenz attractor"},{key:"2",action:"Switch to RÃ¶ssler attractor"},{key:"3",action:"Switch to Double Pendulum"},{key:"S",action:"Toggle side-by-side (Butterfly) mode"},{key:"C",action:"Toggle cinematic chase camera"},{key:"A",action:"Toggle chaos autopilot"},{key:"M",action:"Toggle audio sonification"},{key:"B",action:"Toggle bloom glow effect"},{key:"G",action:"Toggle particle swarm mode"},{key:"X",action:"Perturb â€” random kick to the system"},{key:"T",action:"Cycle through color themes"},{key:"P",action:"Screenshot current view"},{key:"L",action:"Copy share link to clipboard"},{key:"H / ?",action:"Toggle this help overlay"},{key:"Esc",action:"Close open dialogs"}],Vt=({isVisible:r,onClose:e})=>{const s=l.useRef(null);return l.useEffect(()=>{r&&s.current?.focus()},[r]),l.useEffect(()=>{if(!r)return;const a=o=>{(o.key==="Escape"||o.key==="h"||o.key==="H"||o.key==="?")&&(o.preventDefault(),e())};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[r,e]),r?t.jsx("div",{className:"help-overlay",role:"dialog","aria-modal":"true","aria-label":"Keyboard shortcuts",onClick:e,children:t.jsxs("div",{className:"help-modal",ref:s,tabIndex:-1,onClick:a=>a.stopPropagation(),children:[t.jsxs("div",{className:"help-header",children:[t.jsx("h2",{children:"âŒ¨ï¸ Keyboard Shortcuts"}),t.jsx("button",{className:"help-close",onClick:e,"aria-label":"Close help",children:"âœ•"})]}),t.jsx("div",{className:"help-grid",children:Ut.map(({key:a,action:o})=>t.jsxs("div",{className:"help-row",children:[t.jsx("kbd",{className:"help-key",children:a}),t.jsx("span",{className:"help-action",children:o})]},a))}),t.jsxs("div",{className:"help-footer",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Mouse:"})," Drag to rotate Â· Scroll to zoom Â· Right-drag to pan"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Touch:"})," Drag to rotate Â· Pinch to zoom"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Right-click"})," canvas for quick actions"]})]})]})}):null},Wt=12e3,Pe=2e3,Yt=()=>{const{storyMode:r,setStoryMode:e,currentStoryIndex:s,setCurrentStoryIndex:a,setCurrentSystem:o,setLorenzParams:n,setRosslerParams:c,setDoublePendulumParams:m,setTrailLength:h,setSpeed:u,setSideBySideMode:p,setInitialOffset:i,setCurrentPreset:f,setAutoRotate:d,resetSimulation:b,colorTheme:C,setCinematicCamera:x,setParticleSwarm:S}=B(),y=U[C],P=l.useRef(null),[T,k]=l.useState(!1),[j,A]=l.useState(0),v=l.useCallback(E=>{const M=ae[E];if(M){switch(o(M.system),h(M.trailLength),u(M.speed),p(M.sideBySide),i(M.offset),f(null),d(!0),x(!M.sideBySide),S(M.name==="The Murmuration"),M.system){case"lorenz":n(M.params);break;case"rossler":c(M.params);break;case"doublePendulum":m(M.params);break}b()}},[o,n,c,m,h,u,p,i,f,d,x,S,b]),R=l.useCallback(()=>{k(!0),setTimeout(()=>{const E=(s+1)%ae.length;a(E),v(E),A(E),setTimeout(()=>k(!1),100)},Pe/2)},[s,a,v]),g=l.useCallback(()=>{k(!0),setTimeout(()=>{const E=(s-1+ae.length)%ae.length;a(E),v(E),A(E),setTimeout(()=>k(!1),100)},Pe/2)},[s,a,v]);l.useEffect(()=>{r&&(v(s),A(s))},[r]),l.useEffect(()=>{if(r)return P.current=setTimeout(R,Wt),()=>{P.current&&clearTimeout(P.current)}},[r,s,R]);const z=l.useCallback(()=>{e(!1),x(!1),S(!1),d(!1),P.current&&clearTimeout(P.current)},[e,x,S,d]);if(l.useEffect(()=>{if(!r)return;const E=M=>{M.key==="Escape"?z():M.key==="ArrowRight"||M.key===" "?(M.preventDefault(),R()):M.key==="ArrowLeft"&&(M.preventDefault(),g())};return window.addEventListener("keydown",E),()=>window.removeEventListener("keydown",E)},[r,R,g,z]),!r)return null;const L=ae[j];return L?t.jsxs("div",{className:`story-mode-overlay ${T?"transitioning":""}`,style:{"--story-accent":y.accent,"--story-bg":y.panelBg,"--story-text":y.text,"--story-border":y.panelBorder},children:[t.jsx("div",{className:"story-progress",children:ae.map((E,M)=>t.jsx("button",{className:`story-dot ${M===j?"active":""} ${M<j?"visited":""}`,onClick:()=>{k(!0),setTimeout(()=>{a(M),v(M),A(M),setTimeout(()=>k(!1),100)},Pe/2)},"aria-label":`Go to story ${M+1}: ${ae[M].name}`},M))}),t.jsxs("div",{className:"story-card",children:[t.jsx("div",{className:"story-emoji",children:L.emoji}),t.jsxs("div",{className:"story-text",children:[t.jsx("h2",{className:"story-title",children:L.name}),t.jsx("p",{className:"story-description",children:L.description})]}),t.jsxs("div",{className:"story-counter",children:[j+1," / ",ae.length]})]}),t.jsxs("div",{className:"story-nav",children:[t.jsx("button",{className:"story-nav-btn",onClick:g,"aria-label":"Previous story",children:"â†"}),t.jsx("button",{className:"story-nav-btn story-exit",onClick:z,"aria-label":"Exit story mode",children:"âœ• Exit"}),t.jsx("button",{className:"story-nav-btn",onClick:R,"aria-label":"Next story",children:"â†’"})]})]}):null},Oe={lorenz:{xRange:[-25,25],yRange:[-30,30],zRange:[0,55]},rossler:{xRange:[-15,15],yRange:[-15,15],zRange:[0,30]},doublePendulum:{xRange:[-3,3],yRange:[-3,3],zRange:[-1,1]}};function we(r,e,s,a,o){const n=Math.max(e,Math.min(s,r));return a+(n-e)/(s-e)*(o-a)}const be=[130.81,146.83,164.81,196,220,261.63,293.66,329.63,392,440,523.25,587.33,659.26];function $e(r){let e=be[0],s=Math.abs(r-e);for(let a=1;a<be.length;a++){const o=Math.abs(r-be[a]);o<s&&(s=o,e=be[a])}return e}const Xt=()=>{const{audioEnabled:r,audioVolume:e,currentSystem:s,isPlaying:a}=B(),o=l.useRef(null),n=l.useRef(null),c=l.useRef(null),m=l.useRef(null),h=l.useRef(null),u=l.useRef(null),p=l.useRef(null),i=l.useRef(null),f=l.useRef(0),d=l.useCallback(()=>{if(o.current)return;const x=new AudioContext;o.current=x;const S=x.createOscillator();S.type="sine",S.frequency.value=220,n.current=S;const y=x.createOscillator();y.type="triangle",y.frequency.value=220,y.detune.value=7,c.current=y;const P=x.createBiquadFilter();P.type="lowpass",P.frequency.value=800,P.Q.value=2,h.current=P;const T=x.createGain();T.gain.value=0,m.current=T;const k=x.createGain();k.gain.value=e,u.current=k;const j=x.createDelay(1);j.delayTime.value=.3;const A=x.createGain();A.gain.value=.25;const v=x.createGain();v.gain.value=.3,p.current=v,S.connect(P),y.connect(P),P.connect(T),T.connect(k),T.connect(j),j.connect(A),A.connect(j),j.connect(v),v.connect(k),k.connect(x.destination),S.start(),y.start()},[e]),b=l.useCallback(()=>{if(f.current&&(cancelAnimationFrame(f.current),f.current=0),n.current){try{n.current.stop()}catch{}n.current=null}if(c.current){try{c.current.stop()}catch{}c.current=null}o.current&&(o.current.close(),o.current=null),m.current=null,h.current=null,u.current=null,p.current=null,i.current=null},[]),C=l.useCallback(()=>{const x=o.current,S=n.current,y=c.current,P=m.current,T=h.current;if(!x||!S||!y||!P||!T)return;const k=K.system;if(!k?.points||k.points.length<5){P.gain.setTargetAtTime(0,x.currentTime,.1),f.current=requestAnimationFrame(C);return}const j=K.type||"lorenz",A=k.points,v=A[A.length-1],R=Oe[j]||Oe.lorenz,g=i.current||v,z=v.x-g.x,L=v.y-g.y,E=v.z-g.z,M=Math.sqrt(z*z+L*L+E*E);i.current={x:v.x,y:v.y,z:v.z};const N=x.currentTime,D=.08,q=we(v.x,R.xRange[0],R.xRange[1],100,600),H=$e(q);S.frequency.setTargetAtTime(H,N,D);const _=we(v.y,R.yRange[0],R.yRange[1],80,500),$=$e(_)*1.5;y.frequency.setTargetAtTime($,N,D*1.5);const I=we(v.z,R.zRange[0],R.zRange[1],200,2500);T.frequency.setTargetAtTime(I,N,D);const F=Math.min(1,M/(j==="doublePendulum"?2:15)),V=F*F*.4;P.gain.setTargetAtTime(V,N,D),f.current=requestAnimationFrame(C)},[]);return l.useEffect(()=>(r&&a?(d(),setTimeout(()=>{f.current=requestAnimationFrame(C)},100)):b(),()=>{b()}),[r,a,d,b,C]),l.useEffect(()=>{u.current&&o.current&&u.current.gain.setTargetAtTime(e,o.current.currentTime,.05)},[e]),l.useEffect(()=>{r&&m.current&&o.current&&(a||m.current.gain.setTargetAtTime(0,o.current.currentTime,.2))},[a,r]),l.useEffect(()=>{i.current=null},[s]),null};function Kt(){const{currentSystem:r}=B();return l.useCallback(()=>{const s=document.querySelector("canvas");if(s)try{const a=r==="doublePendulum"?"pendulum":r,o=new Date().toISOString().split("T")[0],n=`chaos-lab-${a}-${o}.png`;s.toBlob(c=>{if(!c)return;const m=URL.createObjectURL(c),h=document.createElement("a");h.href=m,h.download=n,document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(m)},"image/png")}catch(a){console.warn("Screenshot failed:",a)}},[r])}const Zt=new Set(["lorenz","rossler","doublePendulum"]),Jt=new Set(["classic","neon","blueprint","terminal"]);function He(){const r=B.getState(),e=new URLSearchParams;switch(e.set("sys",r.currentSystem),e.set("theme",r.colorTheme),e.set("speed",r.speed.toFixed(1)),e.set("trail",String(r.trailLength)),e.set("sbs",r.sideBySideMode?"1":"0"),r.sideBySideMode&&e.set("offset",r.initialOffset.toExponential(1)),r.bloomEnabled&&e.set("bloom",r.bloomIntensity.toFixed(1)),r.audioEnabled&&e.set("audio","1"),r.currentSystem){case"lorenz":e.set("sigma",r.lorenzParams.sigma.toFixed(2)),e.set("rho",r.lorenzParams.rho.toFixed(2)),e.set("beta",r.lorenzParams.beta.toFixed(3));break;case"rossler":e.set("a",r.rosslerParams.a.toFixed(3)),e.set("b",r.rosslerParams.b.toFixed(3)),e.set("c",r.rosslerParams.c.toFixed(2));break;case"doublePendulum":e.set("m1",r.doublePendulumParams.mass1.toFixed(2)),e.set("m2",r.doublePendulumParams.mass2.toFixed(2)),e.set("l1",r.doublePendulumParams.length1.toFixed(2)),e.set("l2",r.doublePendulumParams.length2.toFixed(2)),e.set("g",r.doublePendulumParams.gravity.toFixed(2)),e.set("damp",r.doublePendulumParams.damping.toFixed(3));break}return"#"+e.toString()}function Qt(r){if(!r||r.length<2)return!1;try{const e=new URLSearchParams(r.slice(1)),s=B.getState(),a=e.get("sys");if(a&&Zt.has(a))s.setCurrentSystem(a);else return!1;const o=e.get("theme");o&&Jt.has(o)&&s.setColorTheme(o);const n=parseFloat(e.get("speed")||"");n>0&&n<=5&&s.setSpeed(n);const c=parseInt(e.get("trail")||"");if(c>=100&&c<=5e3&&s.setTrailLength(c),e.get("sbs")==="1"){s.setSideBySideMode(!0);const u=parseFloat(e.get("offset")||"");u>0&&u<1&&s.setInitialOffset(u)}const h=parseFloat(e.get("bloom")||"");switch(h>0&&h<=4?(s.setBloomEnabled(!0),s.setBloomIntensity(h)):e.has("bloom")&&e.get("bloom")==="0"&&s.setBloomEnabled(!1),e.get("audio")==="1"&&s.setAudioEnabled(!0),a){case"lorenz":{const u=parseFloat(e.get("sigma")||""),p=parseFloat(e.get("rho")||""),i=parseFloat(e.get("beta")||"");u>0&&s.setLorenzParams({sigma:u}),p>0&&s.setLorenzParams({rho:p}),i>0&&s.setLorenzParams({beta:i});break}case"rossler":{const u=parseFloat(e.get("a")||""),p=parseFloat(e.get("b")||""),i=parseFloat(e.get("c")||"");u>0&&s.setRosslerParams({a:u}),p>0&&s.setRosslerParams({b:p}),i>0&&s.setRosslerParams({c:i});break}case"doublePendulum":{const u=parseFloat(e.get("m1")||""),p=parseFloat(e.get("m2")||""),i=parseFloat(e.get("l1")||""),f=parseFloat(e.get("l2")||""),d=parseFloat(e.get("g")||""),b=parseFloat(e.get("damp")||"");u>0&&s.setDoublePendulumParams({mass1:u}),p>0&&s.setDoublePendulumParams({mass2:p}),i>0&&s.setDoublePendulumParams({length1:i}),f>0&&s.setDoublePendulumParams({length2:f}),d>0&&s.setDoublePendulumParams({gravity:d}),b>=0&&s.setDoublePendulumParams({damping:b});break}}return!0}catch{return!1}}function qe(){return window.location.origin+window.location.pathname+He()}function es(){const r=l.useRef(!1);l.useEffect(()=>{r.current||(r.current=!0,window.location.hash&&Qt(window.location.hash))},[]);const{currentSystem:e,colorTheme:s,speed:a,trailLength:o,sideBySideMode:n,initialOffset:c,lorenzParams:m,rosslerParams:h,doublePendulumParams:u,bloomEnabled:p,bloomIntensity:i,audioEnabled:f}=B();l.useEffect(()=>{const d=setTimeout(()=>{window.history.replaceState(null,"",He())},500);return()=>clearTimeout(d)},[e,s,a,o,n,c,m,h,u,p,i,f])}const Me=["classic","neon","blueprint","terminal"],Re=["lorenz","rossler","doublePendulum"];function ts(r){const e=Kt();l.useEffect(()=>{const s=a=>{const o=a.target.tagName;if(o==="INPUT"||o==="TEXTAREA"||o==="SELECT"||a.ctrlKey||a.metaKey||a.altKey)return;const n=B.getState();switch(a.key){case" ":a.preventDefault(),n.setIsPlaying(!n.isPlaying);break;case"r":case"R":n.resetSimulation();break;case"1":n.setCurrentSystem(Re[0]),n.setCurrentPreset(null);break;case"2":n.setCurrentSystem(Re[1]),n.setCurrentPreset(null);break;case"3":n.setCurrentSystem(Re[2]),n.setCurrentPreset(null);break;case"s":case"S":n.setSideBySideMode(!n.sideBySideMode),n.sideBySideMode||n.resetSimulation();break;case"t":case"T":{const c=Me.indexOf(n.colorTheme),m=Me[(c+1)%Me.length];n.setColorTheme(m);break}case"h":case"H":case"?":r();break;case"p":case"P":e();break;case"l":case"L":try{navigator.clipboard.writeText(qe())}catch{window.prompt("Share this URL:",qe())}break;case"c":case"C":n.setCinematicCamera(!n.cinematicCamera);break;case"a":case"A":n.setChaosAutopilot(!n.chaosAutopilot);break;case"m":case"M":n.setAudioEnabled(!n.audioEnabled);break;case"b":case"B":n.setBloomEnabled(!n.bloomEnabled);break;case"g":case"G":n.setParticleSwarm(!n.particleSwarm);break;case"x":case"X":n.perturbSystem();break;case"Escape":n.storyMode?(n.setStoryMode(!1),n.setCinematicCamera(!1)):n.showBifurcation?n.setShowBifurcation(!1):n.showPoincare?n.setShowPoincare(!1):n.showParameterSpace?n.setShowParameterSpace(!1):n.cinematicCamera&&n.setCinematicCamera(!1);break}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[r,e])}const ss=l.lazy(()=>Te(()=>import("./BifurcationDiagram-DrE9rQq3.js"),__vite__mapDeps([0,1,2])).then(r=>({default:r.BifurcationDiagram}))),as=l.lazy(()=>Te(()=>import("./PoincareSection-s4wDGFf_.js"),__vite__mapDeps([3,1,4])).then(r=>({default:r.PoincareSection}))),rs=l.lazy(()=>Te(()=>import("./ParameterSpace-4LOxwncI.js"),__vite__mapDeps([5,1,6])).then(r=>({default:r.ParameterSpace})));function ns(){const r=B(e=>e.setIsPlaying);l.useEffect(()=>{const e=window.matchMedia("(prefers-reduced-motion: reduce)");e.matches&&r(!1);const s=a=>{a.matches&&r(!1)};return e.addEventListener("change",s),()=>e.removeEventListener("change",s)},[r])}function os(){const{colorTheme:r,currentSystem:e,_perturbCounter:s}=B(),a=U[r],[o,n]=l.useState(!1),[c,m]=l.useState(!1),[h,u]=l.useState(!0),[p,i]=l.useState(!1),f=l.useRef(e),[d,b]=l.useState(!1),[C,x]=l.useState(!1),S=l.useRef(s),y=l.useCallback(()=>n(T=>!T),[]);ns(),ts(y),es(),l.useEffect(()=>{const T=setTimeout(()=>m(!0),100),k=setTimeout(()=>i(!0),1200),j=setTimeout(()=>u(!1),6e3);return()=>{clearTimeout(T),clearTimeout(k),clearTimeout(j)}},[]),l.useEffect(()=>{if(f.current!==e){b(!0);const T=setTimeout(()=>b(!1),600);return f.current=e,()=>clearTimeout(T)}},[e]),l.useEffect(()=>{if(s>0&&s!==S.current){x(!0);const T=setTimeout(()=>x(!1),450);return S.current=s,()=>clearTimeout(T)}},[s]);const P=e==="lorenz"?"Lorenz Attractor":e==="rossler"?"RÃ¶ssler Attractor":"Double Pendulum";return t.jsxs("div",{className:`app ${c?"entered":"entering"} ${d?"system-transitioning":""} ${C?"perturbed":""}`,style:{"--bg":a.bg,"--text":a.text,"--accent":a.accent},children:[t.jsx("a",{href:"#controls-region",className:"skip-link",children:"Skip to controls"}),t.jsxs("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:["Now viewing: ",P]}),t.jsx("main",{className:d?"scene-crossfade":"",children:t.jsx(It,{})}),t.jsxs("div",{className:`ui-layer ${p?"visible":""}`,children:[t.jsx($t,{}),t.jsx("div",{id:"controls-region",children:t.jsx(_t,{})}),t.jsx(Ht,{}),t.jsx(Gt,{}),t.jsxs(l.Suspense,{fallback:null,children:[t.jsx(ss,{}),t.jsx(as,{}),t.jsx(rs,{})]})]}),t.jsx(Vt,{isVisible:o,onClose:y}),t.jsx(Yt,{}),t.jsx(qt,{}),t.jsx(Xt,{}),t.jsxs("div",{className:`title-overlay ${h?"visible":"faded"}`,"aria-hidden":"true",onMouseEnter:()=>u(!0),onMouseLeave:()=>u(!1),children:[t.jsx("h1",{children:"Chaos Lab"}),t.jsx("p",{children:"Interactive Chaos Theory Visualizer"})]}),t.jsx("div",{className:`instructions ${p?"visible":""}`,"aria-hidden":"true",children:t.jsx("p",{children:"Drag to explore Â· Scroll to dive deeper Â· Right-drag to drift"})})]})}st.createRoot(document.getElementById("root")).render(t.jsx(l.StrictMode,{children:t.jsx(os,{})}));export{U as T,K as s,B as u};
