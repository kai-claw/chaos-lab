const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/BifurcationDiagram-CD28wd6-.js","assets/three-vendor-B6kbYGeM.js","assets/BifurcationDiagram-7MOkXOt8.css","assets/PoincareSection-D4ZmqAVA.js","assets/PoincareSection-Bu5ajD9c.css","assets/ParameterSpace-Bv7wZJMU.js","assets/ParameterSpace-U0tBLzM4.css"])))=>i.map(i=>d[i]);
import{V as F,U as he,S as H,D as Nt,a as jt,b as It,c as Dt,W as te,L as we,M as Ut,C as Q,N as Ee,F as Ft,B as me,E as ke,d as pt,e as ft,f as qe,O as kt,g as Lt,h as Se,i as ve,j as le,k as Ot,l as pe,m as I,n as mt,T as gt,R as vt,P as Ht,A as Gt,o as Vt,p as re,q as Ke,r as h,u as Le,H as Wt,s as q,t as $t,v as i,w as qt,x as Kt,y as U,z as Xt,G as Xe,I as de,J as Ze,K as Zt,Q as Yt,X as Qt,Y as Jt,_ as Oe,Z as es}from"./three-vendor-B6kbYGeM.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}})();var Ce=1/1e3,ts=1e3,ss=class{constructor(){this.startTime=performance.now(),this.previousTime=0,this.currentTime=0,this._delta=0,this._elapsed=0,this._fixedDelta=1e3/60,this.timescale=1,this.useFixedDelta=!1,this._autoReset=!1}get autoReset(){return this._autoReset}set autoReset(e){typeof document<"u"&&document.hidden!==void 0&&(e?document.addEventListener("visibilitychange",this):document.removeEventListener("visibilitychange",this),this._autoReset=e)}get delta(){return this._delta*Ce}get fixedDelta(){return this._fixedDelta*Ce}set fixedDelta(e){this._fixedDelta=e*ts}get elapsed(){return this._elapsed*Ce}update(e){this.useFixedDelta?this._delta=this.fixedDelta:(this.previousTime=this.currentTime,this.currentTime=(e!==void 0?e:performance.now())-this.startTime,this._delta=this.currentTime-this.previousTime),this._delta*=this.timescale,this._elapsed+=this._delta}reset(){this._delta=0,this._elapsed=0,this.currentTime=performance.now()-this.startTime}getDelta(){return this.delta}getElapsed(){return this.elapsed}handleEvent(e){document.hidden||(this.currentTime=performance.now()-this.startTime)}dispose(){this.autoReset=!1}},rs=(()=>{const e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new Float32Array([0,0,2,0,0,2]),s=new Vt;return s.setAttribute("position",new re(e,3)),s.setAttribute("uv",new re(t,2)),s})(),W=class Ue{static get fullscreenGeometry(){return rs}constructor(t="Pass",s=new qe,r=new kt){this.name=t,this.renderer=null,this.scene=s,this.camera=r,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}get renderToScreen(){return!this.rtt}set renderToScreen(t){if(this.rtt===t){const s=this.fullscreenMaterial;s!==null&&(s.needsUpdate=!0),this.rtt=!t}}set mainScene(t){}set mainCamera(t){}setRenderer(t){this.renderer=t}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}get fullscreenMaterial(){return this.screen!==null?this.screen.material:null}set fullscreenMaterial(t){let s=this.screen;s!==null?s.material=t:(s=new Lt(Ue.fullscreenGeometry,t),s.frustumCulled=!1,this.scene===null&&(this.scene=new qe),this.scene.add(s),this.screen=s)}getFullscreenMaterial(){return this.fullscreenMaterial}setFullscreenMaterial(t){this.fullscreenMaterial=t}getDepthTexture(){return null}setDepthTexture(t,s=me){}render(t,s,r,n,a){throw new Error("Render method not implemented!")}setSize(t,s){}initialize(t,s,r){}dispose(){for(const t of Object.keys(this)){const s=this[t];(s instanceof te||s instanceof mt||s instanceof gt||s instanceof Ue)&&this[t].dispose()}this.fullscreenMaterial!==null&&this.fullscreenMaterial.dispose()}},is=class extends W{constructor(){super("ClearMaskPass",null,null),this.needsSwap=!1}render(e,t,s,r,n){const a=e.state.buffers.stencil;a.setLocked(!1),a.setTest(!1)}},ns=`#ifdef COLOR_WRITE
#include <common>
#include <dithering_pars_fragment>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#endif
#ifdef DEPTH_WRITE
#include <packing>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
return unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
return texture2D(depthBuffer,uv).r;
#endif
}
#endif
#ifdef USE_WEIGHTS
uniform vec4 channelWeights;
#endif
uniform float opacity;varying vec2 vUv;void main(){
#ifdef COLOR_WRITE
vec4 texel=texture2D(inputBuffer,vUv);
#ifdef USE_WEIGHTS
texel*=channelWeights;
#endif
gl_FragColor=opacity*texel;
#ifdef COLOR_SPACE_CONVERSION
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
#else
gl_FragColor=vec4(0.0);
#endif
#ifdef DEPTH_WRITE
gl_FragDepth=readDepth(vUv);
#endif
}`,bt="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}",xt=class extends le{constructor(){super({name:"CopyMaterial",defines:{COLOR_SPACE_CONVERSION:"1",DEPTH_PACKING:"0",COLOR_WRITE:"1"},uniforms:{inputBuffer:new I(null),depthBuffer:new I(null),channelWeights:new I(null),opacity:new I(1)},blending:pe,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:ns,vertexShader:bt}),this.depthFunc=Gt}get inputBuffer(){return this.uniforms.inputBuffer.value}set inputBuffer(e){const t=e!==null;this.colorWrite!==t&&(t?this.defines.COLOR_WRITE=!0:delete this.defines.COLOR_WRITE,this.colorWrite=t,this.needsUpdate=!0),this.uniforms.inputBuffer.value=e}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(e){const t=e!==null;this.depthWrite!==t&&(t?this.defines.DEPTH_WRITE=!0:delete this.defines.DEPTH_WRITE,this.depthTest=t,this.depthWrite=t,this.needsUpdate=!0),this.uniforms.depthBuffer.value=e}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}get colorSpaceConversion(){return this.defines.COLOR_SPACE_CONVERSION!==void 0}set colorSpaceConversion(e){this.colorSpaceConversion!==e&&(e?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get channelWeights(){return this.uniforms.channelWeights.value}set channelWeights(e){e!==null?(this.defines.USE_WEIGHTS="1",this.uniforms.channelWeights.value=e):delete this.defines.USE_WEIGHTS,this.needsUpdate=!0}setInputBuffer(e){this.uniforms.inputBuffer.value=e}getOpacity(e){return this.uniforms.opacity.value}setOpacity(e){this.uniforms.opacity.value=e}},as=class extends W{constructor(e,t=!0){super("CopyPass"),this.fullscreenMaterial=new xt,this.needsSwap=!1,this.renderTarget=e,e===void 0&&(this.renderTarget=new te(1,1,{minFilter:we,magFilter:we,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="CopyPass.Target"),this.autoResize=t}get resize(){return this.autoResize}set resize(e){this.autoResize=e}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}setAutoResizeEnabled(e){this.autoResize=e}render(e,t,s,r,n){this.fullscreenMaterial.inputBuffer=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){this.autoResize&&this.renderTarget.setSize(e,t)}initialize(e,t,s){s!==void 0&&(this.renderTarget.texture.type=s,s!==he?this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1":e!==null&&e.outputColorSpace===H&&(this.renderTarget.texture.colorSpace=H))}},Ye=new Q,yt=class extends W{constructor(e=!0,t=!0,s=!1){super("ClearPass",null,null),this.needsSwap=!1,this.color=e,this.depth=t,this.stencil=s,this.overrideClearColor=null,this.overrideClearAlpha=-1}setClearFlags(e,t,s){this.color=e,this.depth=t,this.stencil=s}getOverrideClearColor(){return this.overrideClearColor}setOverrideClearColor(e){this.overrideClearColor=e}getOverrideClearAlpha(){return this.overrideClearAlpha}setOverrideClearAlpha(e){this.overrideClearAlpha=e}render(e,t,s,r,n){const a=this.overrideClearColor,o=this.overrideClearAlpha,c=e.getClearAlpha(),l=a!==null,u=o>=0;l?(e.getClearColor(Ye),e.setClearColor(a,u?o:c)):u&&e.setClearAlpha(o),e.setRenderTarget(this.renderToScreen?null:t),e.clear(this.color,this.depth,this.stencil),l?e.setClearColor(Ye,c):u&&e.setClearAlpha(c)}},os=class extends W{constructor(e,t){super("MaskPass",e,t),this.needsSwap=!1,this.clearPass=new yt(!1,!1,!0),this.inverse=!1}set mainScene(e){this.scene=e}set mainCamera(e){this.camera=e}get inverted(){return this.inverse}set inverted(e){this.inverse=e}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getClearPass(){return this.clearPass}isInverted(){return this.inverted}setInverted(e){this.inverted=e}render(e,t,s,r,n){const a=e.getContext(),o=e.state.buffers,c=this.scene,l=this.camera,u=this.clearPass,f=this.inverted?0:1,p=1-f;o.color.setMask(!1),o.depth.setMask(!1),o.color.setLocked(!0),o.depth.setLocked(!0),o.stencil.setTest(!0),o.stencil.setOp(a.REPLACE,a.REPLACE,a.REPLACE),o.stencil.setFunc(a.ALWAYS,f,4294967295),o.stencil.setClear(p),o.stencil.setLocked(!0),this.clearPass.enabled&&(this.renderToScreen?u.render(e,null):(u.render(e,t),u.render(e,s))),this.renderToScreen?(e.setRenderTarget(null),e.render(c,l)):(e.setRenderTarget(t),e.render(c,l),e.setRenderTarget(s),e.render(c,l)),o.color.setLocked(!1),o.depth.setLocked(!1),o.stencil.setLocked(!1),o.stencil.setFunc(a.EQUAL,1,4294967295),o.stencil.setOp(a.KEEP,a.KEEP,a.KEEP),o.stencil.setLocked(!0)}},ls=class{constructor(e=null,{depthBuffer:t=!0,stencilBuffer:s=!1,multisampling:r=0,frameBufferType:n}={}){this.renderer=null,this.inputBuffer=this.createBuffer(t,s,n,r),this.outputBuffer=this.inputBuffer.clone(),this.copyPass=new as,this.depthTexture=null,this.passes=[],this.timer=new ss,this.autoRenderToScreen=!0,this.setRenderer(e)}get multisampling(){return this.inputBuffer.samples||0}set multisampling(e){const t=this.inputBuffer,s=this.multisampling;s>0&&e>0?(this.inputBuffer.samples=e,this.outputBuffer.samples=e,this.inputBuffer.dispose(),this.outputBuffer.dispose()):s!==e&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(t.depthBuffer,t.stencilBuffer,t.texture.type,e),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}getTimer(){return this.timer}getRenderer(){return this.renderer}setRenderer(e){if(this.renderer=e,e!==null){const t=e.getSize(new F),s=e.getContext().getContextAttributes().alpha,r=this.inputBuffer.texture.type;r===he&&e.outputColorSpace===H&&(this.inputBuffer.texture.colorSpace=H,this.outputBuffer.texture.colorSpace=H,this.inputBuffer.dispose(),this.outputBuffer.dispose()),e.autoClear=!1,this.setSize(t.width,t.height);for(const n of this.passes)n.initialize(e,s,r)}}replaceRenderer(e,t=!0){const s=this.renderer,r=s.domElement.parentNode;return this.setRenderer(e),t&&r!==null&&(r.removeChild(s.domElement),r.appendChild(e.domElement)),s}createDepthTexture(){const e=this.depthTexture=new Nt;return this.inputBuffer.depthTexture=e,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(e.format=jt,e.type=It):e.type=Dt,e}deleteDepthTexture(){if(this.depthTexture!==null){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();for(const e of this.passes)e.setDepthTexture(null)}}createBuffer(e,t,s,r){const n=this.renderer,a=n===null?new F:n.getDrawingBufferSize(new F),o={minFilter:we,magFilter:we,stencilBuffer:t,depthBuffer:e,type:s},c=new te(a.width,a.height,o);return r>0&&(c.samples=r),s===he&&n!==null&&n.outputColorSpace===H&&(c.texture.colorSpace=H),c.texture.name="EffectComposer.Buffer",c.texture.generateMipmaps=!1,c}setMainScene(e){for(const t of this.passes)t.mainScene=e}setMainCamera(e){for(const t of this.passes)t.mainCamera=e}addPass(e,t){const s=this.passes,r=this.renderer,n=r.getDrawingBufferSize(new F),a=r.getContext().getContextAttributes().alpha,o=this.inputBuffer.texture.type;if(e.setRenderer(r),e.setSize(n.width,n.height),e.initialize(r,a,o),this.autoRenderToScreen&&(s.length>0&&(s[s.length-1].renderToScreen=!1),e.renderToScreen&&(this.autoRenderToScreen=!1)),t!==void 0?s.splice(t,0,e):s.push(e),this.autoRenderToScreen&&(s[s.length-1].renderToScreen=!0),e.needsDepthTexture||this.depthTexture!==null)if(this.depthTexture===null){const c=this.createDepthTexture();for(e of s)e.setDepthTexture(c)}else e.setDepthTexture(this.depthTexture)}removePass(e){const t=this.passes,s=t.indexOf(e);if(s!==-1&&t.splice(s,1).length>0){if(this.depthTexture!==null){const a=(c,l)=>c||l.needsDepthTexture;t.reduce(a,!1)||(e.getDepthTexture()===this.depthTexture&&e.setDepthTexture(null),this.deleteDepthTexture())}this.autoRenderToScreen&&s===t.length&&(e.renderToScreen=!1,t.length>0&&(t[t.length-1].renderToScreen=!0))}}removeAllPasses(){const e=this.passes;this.deleteDepthTexture(),e.length>0&&(this.autoRenderToScreen&&(e[e.length-1].renderToScreen=!1),this.passes=[])}render(e){const t=this.renderer,s=this.copyPass;let r=this.inputBuffer,n=this.outputBuffer,a=!1,o,c,l;e===void 0&&(this.timer.update(),e=this.timer.getDelta());for(const u of this.passes)u.enabled&&(u.render(t,r,n,e,a),u.needsSwap&&(a&&(s.renderToScreen=u.renderToScreen,o=t.getContext(),c=t.state.buffers.stencil,c.setFunc(o.NOTEQUAL,1,4294967295),s.render(t,r,n,e,a),c.setFunc(o.EQUAL,1,4294967295)),l=r,r=n,n=l),u instanceof os?a=!0:u instanceof is&&(a=!1))}setSize(e,t,s){const r=this.renderer,n=r.getSize(new F);(e===void 0||t===void 0)&&(e=n.width,t=n.height),(n.width!==e||n.height!==t)&&r.setSize(e,t,s);const a=r.getDrawingBufferSize(new F);this.inputBuffer.setSize(a.width,a.height),this.outputBuffer.setSize(a.width,a.height);for(const o of this.passes)o.setSize(a.width,a.height)}reset(){this.dispose(),this.autoRenderToScreen=!0}dispose(){for(const e of this.passes)e.dispose();this.passes=[],this.inputBuffer!==null&&this.inputBuffer.dispose(),this.outputBuffer!==null&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose(),this.timer.dispose(),W.fullscreenGeometry.dispose()}},ue={NONE:0,DEPTH:1,CONVOLUTION:2},j={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},cs=class{constructor(){this.shaderParts=new Map([[j.FRAGMENT_HEAD,null],[j.FRAGMENT_MAIN_UV,null],[j.FRAGMENT_MAIN_IMAGE,null],[j.VERTEX_HEAD,null],[j.VERTEX_MAIN_SUPPORT,null]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.extensions=new Set,this.attributes=ue.NONE,this.varyings=new Set,this.uvTransformation=!1,this.readDepth=!1,this.colorSpace=pt}},_e=!1,Qe=class{constructor(e=null){this.originalMaterials=new Map,this.material=null,this.materials=null,this.materialsBackSide=null,this.materialsDoubleSide=null,this.materialsFlatShaded=null,this.materialsFlatShadedBackSide=null,this.materialsFlatShadedDoubleSide=null,this.setMaterial(e),this.meshCount=0,this.replaceMaterial=t=>{if(t.isMesh){let s;if(t.material.flatShading)switch(t.material.side){case ve:s=this.materialsFlatShadedDoubleSide;break;case Se:s=this.materialsFlatShadedBackSide;break;default:s=this.materialsFlatShaded;break}else switch(t.material.side){case ve:s=this.materialsDoubleSide;break;case Se:s=this.materialsBackSide;break;default:s=this.materials;break}this.originalMaterials.set(t,t.material),t.isSkinnedMesh?t.material=s[2]:t.isInstancedMesh?t.material=s[1]:t.material=s[0],++this.meshCount}}}cloneMaterial(e){if(!(e instanceof le))return e.clone();const t=e.uniforms,s=new Map;for(const n in t){const a=t[n].value;a.isRenderTargetTexture&&(t[n].value=null,s.set(n,a))}const r=e.clone();for(const n of s)t[n[0]].value=n[1],r.uniforms[n[0]].value=n[1];return r}setMaterial(e){if(this.disposeMaterials(),this.material=e,e!==null){const t=this.materials=[this.cloneMaterial(e),this.cloneMaterial(e),this.cloneMaterial(e)];for(const s of t)s.uniforms=Object.assign({},e.uniforms),s.side=Ot;t[2].skinning=!0,this.materialsBackSide=t.map(s=>{const r=this.cloneMaterial(s);return r.uniforms=Object.assign({},e.uniforms),r.side=Se,r}),this.materialsDoubleSide=t.map(s=>{const r=this.cloneMaterial(s);return r.uniforms=Object.assign({},e.uniforms),r.side=ve,r}),this.materialsFlatShaded=t.map(s=>{const r=this.cloneMaterial(s);return r.uniforms=Object.assign({},e.uniforms),r.flatShading=!0,r}),this.materialsFlatShadedBackSide=t.map(s=>{const r=this.cloneMaterial(s);return r.uniforms=Object.assign({},e.uniforms),r.flatShading=!0,r.side=Se,r}),this.materialsFlatShadedDoubleSide=t.map(s=>{const r=this.cloneMaterial(s);return r.uniforms=Object.assign({},e.uniforms),r.flatShading=!0,r.side=ve,r})}}render(e,t,s){const r=e.shadowMap.enabled;if(e.shadowMap.enabled=!1,_e){const n=this.originalMaterials;this.meshCount=0,t.traverse(this.replaceMaterial),e.render(t,s);for(const a of n)a[0].material=a[1];this.meshCount!==n.size&&n.clear()}else{const n=t.overrideMaterial;t.overrideMaterial=this.material,e.render(t,s),t.overrideMaterial=n}e.shadowMap.enabled=r}disposeMaterials(){if(this.material!==null){const e=this.materials.concat(this.materialsBackSide).concat(this.materialsDoubleSide).concat(this.materialsFlatShaded).concat(this.materialsFlatShadedBackSide).concat(this.materialsFlatShadedDoubleSide);for(const t of e)t.dispose()}}dispose(){this.originalMaterials.clear(),this.disposeMaterials()}static get workaroundEnabled(){return _e}static set workaroundEnabled(e){_e=e}},ne=-1,G=class extends ke{constructor(e,t=ne,s=ne,r=1){super(),this.resizable=e,this.baseSize=new F(1,1),this.preferredSize=new F(t,s),this.target=this.preferredSize,this.s=r,this.effectiveSize=new F,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){const e=this.baseSize,t=this.preferredSize,s=this.effectiveSize,r=this.scale;t.width!==ne?s.width=t.width:t.height!==ne?s.width=Math.round(t.height*(e.width/Math.max(e.height,1))):s.width=Math.round(e.width*r),t.height!==ne?s.height=t.height:t.width!==ne?s.height=Math.round(t.width/Math.max(e.width/Math.max(e.height,1),1)):s.height=Math.round(e.height*r)}get width(){return this.effectiveSize.width}set width(e){this.preferredWidth=e}get height(){return this.effectiveSize.height}set height(e){this.preferredHeight=e}getWidth(){return this.width}getHeight(){return this.height}get scale(){return this.s}set scale(e){this.s!==e&&(this.s=e,this.preferredSize.setScalar(ne),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getScale(){return this.scale}setScale(e){this.scale=e}get baseWidth(){return this.baseSize.width}set baseWidth(e){this.baseSize.width!==e&&(this.baseSize.width=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseWidth(){return this.baseWidth}setBaseWidth(e){this.baseWidth=e}get baseHeight(){return this.baseSize.height}set baseHeight(e){this.baseSize.height!==e&&(this.baseSize.height=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseHeight(){return this.baseHeight}setBaseHeight(e){this.baseHeight=e}setBaseSize(e,t){(this.baseSize.width!==e||this.baseSize.height!==t)&&(this.baseSize.set(e,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}get preferredWidth(){return this.preferredSize.width}set preferredWidth(e){this.preferredSize.width!==e&&(this.preferredSize.width=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredWidth(){return this.preferredWidth}setPreferredWidth(e){this.preferredWidth=e}get preferredHeight(){return this.preferredSize.height}set preferredHeight(e){this.preferredSize.height!==e&&(this.preferredSize.height=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredHeight(){return this.preferredHeight}setPreferredHeight(e){this.preferredHeight=e}setPreferredSize(e,t){(this.preferredSize.width!==e||this.preferredSize.height!==t)&&(this.preferredSize.set(e,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}copy(e){this.s=e.scale,this.baseSize.set(e.baseWidth,e.baseHeight),this.preferredSize.set(e.preferredWidth,e.preferredHeight),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height)}static get AUTO_SIZE(){return ne}},N={ADD:0,ALPHA:1,AVERAGE:2,COLOR:3,COLOR_BURN:4,COLOR_DODGE:5,DARKEN:6,DIFFERENCE:7,DIVIDE:8,DST:9,EXCLUSION:10,HARD_LIGHT:11,HARD_MIX:12,HUE:13,INVERT:14,INVERT_RGB:15,LIGHTEN:16,LINEAR_BURN:17,LINEAR_DODGE:18,LINEAR_LIGHT:19,LUMINOSITY:20,MULTIPLY:21,NEGATION:22,NORMAL:23,OVERLAY:24,PIN_LIGHT:25,REFLECT:26,SATURATION:27,SCREEN:28,SOFT_LIGHT:29,SRC:30,SUBTRACT:31,VIVID_LIGHT:32},us="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",hs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,src.a*opacity);}",ds="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=(dst.rgb+src.rgb)*0.5;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",ps="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.xy,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",fs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=mix(step(0.0,b)*(1.0-min(vec3(1.0),(1.0-a)/max(b,1e-9))),vec3(1.0),step(1.0,a));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",ms="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=step(0.0,a)*mix(min(vec3(1.0),a/max(1.0-b,1e-9)),vec3(1.0),step(1.0,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",gs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",vs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=abs(dst.rgb-src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",bs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb/max(src.rgb,1e-9);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",xs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-2.0*dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",ys="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb,1.0);vec3 b=min(src.rgb,1.0);vec3 c=mix(2.0*a*b,1.0-2.0*(1.0-a)*(1.0-b),step(0.5,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ss="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=step(1.0,dst.rgb+src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ts="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.x,a.yz));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",ws="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Es="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=src.rgb*max(1.0-dst.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Rs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ms="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ps="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb+src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Cs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(2.0*src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",_s="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.xy,b.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Bs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",As="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-abs(1.0-dst.rgb-src.rgb),0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",zs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,opacity);}",Ns="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=2.0*src.rgb*dst.rgb;vec3 b=1.0-2.0*(1.0-src.rgb)*(1.0-dst.rgb);vec3 c=mix(a,b,step(0.5,dst.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",js="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 c=mix(mix(src2,dst.rgb,step(0.5*dst.rgb,src.rgb)),max(src2-1.0,vec3(0.0)),step(dst.rgb,src2-1.0));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Is="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb*dst.rgb/max(1.0-src.rgb,1e-9),1.0);vec3 c=mix(a,src.rgb,step(1.0,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ds="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.x,b.y,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Us="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-min(dst.rgb*src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Fs="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 d=dst.rgb+(src2-1.0);vec3 w=step(0.5,src.rgb);vec3 a=dst.rgb-(1.0-src2)*dst.rgb*(1.0-dst.rgb);vec3 b=mix(d*(sqrt(dst.rgb)-dst.rgb),d*dst.rgb*((16.0*dst.rgb-12.0)*dst.rgb+3.0),w*(1.0-step(0.25,dst.rgb)));vec3 c=mix(a,b,w);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",ks="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return src;}",Ls="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Os="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=mix(max(1.0-min((1.0-dst.rgb)/(2.0*src.rgb),1.0),0.0),min(dst.rgb/(2.0*(1.0-src.rgb)),1.0),step(0.5,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Hs=new Map([[N.ADD,us],[N.ALPHA,hs],[N.AVERAGE,ds],[N.COLOR,ps],[N.COLOR_BURN,fs],[N.COLOR_DODGE,ms],[N.DARKEN,gs],[N.DIFFERENCE,vs],[N.DIVIDE,bs],[N.DST,null],[N.EXCLUSION,xs],[N.HARD_LIGHT,ys],[N.HARD_MIX,Ss],[N.HUE,Ts],[N.INVERT,ws],[N.INVERT_RGB,Es],[N.LIGHTEN,Rs],[N.LINEAR_BURN,Ms],[N.LINEAR_DODGE,Ps],[N.LINEAR_LIGHT,Cs],[N.LUMINOSITY,_s],[N.MULTIPLY,Bs],[N.NEGATION,As],[N.NORMAL,zs],[N.OVERLAY,Ns],[N.PIN_LIGHT,js],[N.REFLECT,Is],[N.SATURATION,Ds],[N.SCREEN,Us],[N.SOFT_LIGHT,Fs],[N.SRC,ks],[N.SUBTRACT,Ls],[N.VIVID_LIGHT,Os]]),Gs=class extends ke{constructor(e,t=1){super(),this._blendFunction=e,this.opacity=new I(t)}getOpacity(){return this.opacity.value}setOpacity(e){this.opacity.value=e}get blendFunction(){return this._blendFunction}set blendFunction(e){this._blendFunction=e,this.dispatchEvent({type:"change"})}getBlendFunction(){return this.blendFunction}setBlendFunction(e){this.blendFunction=e}getShaderCode(){return Hs.get(this.blendFunction)}},Fe=class extends ke{constructor(e,t,{attributes:s=ue.NONE,blendFunction:r=N.NORMAL,defines:n=new Map,uniforms:a=new Map,extensions:o=null,vertexShader:c=null}={}){super(),this.name=e,this.renderer=null,this.attributes=s,this.fragmentShader=t,this.vertexShader=c,this.defines=n,this.uniforms=a,this.extensions=o,this.blendMode=new Gs(r),this.blendMode.addEventListener("change",l=>this.setChanged()),this._inputColorSpace=pt,this._outputColorSpace=ft}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(e){this._inputColorSpace=e,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e,this.setChanged()}set mainScene(e){}set mainCamera(e){}getName(){return this.name}setRenderer(e){this.renderer=e}getDefines(){return this.defines}getUniforms(){return this.uniforms}getExtensions(){return this.extensions}getBlendMode(){return this.blendMode}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e,this.setChanged()}getFragmentShader(){return this.fragmentShader}setFragmentShader(e){this.fragmentShader=e,this.setChanged()}getVertexShader(){return this.vertexShader}setVertexShader(e){this.vertexShader=e,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}setDepthTexture(e,t=me){}update(e,t,s){}setSize(e,t){}initialize(e,t,s){}dispose(){for(const e of Object.keys(this)){const t=this[e];(t instanceof te||t instanceof mt||t instanceof gt||t instanceof W)&&this[e].dispose()}}},He={MEDIUM:2,LARGE:3},Vs=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;
#include <colorspace_fragment>
}`,Ws="uniform vec4 texelSize;uniform float kernel;uniform float scale;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize.xy*vec2(kernel)+texelSize.zw)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}",$s=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],qs=class extends le{constructor(e=new Ke){super({name:"KawaseBlurMaterial",uniforms:{inputBuffer:new I(null),texelSize:new I(new Ke),scale:new I(1),kernel:new I(0)},blending:pe,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Vs,vertexShader:Ws}),this.setTexelSize(e.x,e.y),this.kernelSize=He.MEDIUM}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.inputBuffer=e}get kernelSequence(){return $s[this.kernelSize]}get scale(){return this.uniforms.scale.value}set scale(e){this.uniforms.scale.value=e}getScale(){return this.uniforms.scale.value}setScale(e){this.uniforms.scale.value=e}getKernel(){return null}get kernel(){return this.uniforms.kernel.value}set kernel(e){this.uniforms.kernel.value=e}setKernel(e){this.kernel=e}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t,e*.5,t*.5)}setSize(e,t){const s=1/e,r=1/t;this.uniforms.texelSize.value.set(s,r,s*.5,r*.5)}},Ks=class extends W{constructor({kernelSize:e=He.MEDIUM,resolutionScale:t=.5,width:s=G.AUTO_SIZE,height:r=G.AUTO_SIZE,resolutionX:n=s,resolutionY:a=r}={}){super("KawaseBlurPass"),this.renderTargetA=new te(1,1,{depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B";const o=this.resolution=new G(this,n,a,t);o.addEventListener("change",c=>this.setSize(o.baseWidth,o.baseHeight)),this._blurMaterial=new qs,this._blurMaterial.kernelSize=e,this.copyMaterial=new xt}getResolution(){return this.resolution}get blurMaterial(){return this._blurMaterial}set blurMaterial(e){this._blurMaterial=e}get dithering(){return this.copyMaterial.dithering}set dithering(e){this.copyMaterial.dithering=e}get kernelSize(){return this.blurMaterial.kernelSize}set kernelSize(e){this.blurMaterial.kernelSize=e}get width(){return this.resolution.width}set width(e){this.resolution.preferredWidth=e}get height(){return this.resolution.height}set height(e){this.resolution.preferredHeight=e}get scale(){return this.blurMaterial.scale}set scale(e){this.blurMaterial.scale=e}getScale(){return this.blurMaterial.scale}setScale(e){this.blurMaterial.scale=e}getKernelSize(){return this.kernelSize}setKernelSize(e){this.kernelSize=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,s,r,n){const a=this.scene,o=this.camera,c=this.renderTargetA,l=this.renderTargetB,u=this.blurMaterial,f=u.kernelSequence;let p=t;this.fullscreenMaterial=u;for(let m=0,d=f.length;m<d;++m){const v=(m&1)===0?c:l;u.kernel=f[m],u.inputBuffer=p.texture,e.setRenderTarget(v),e.render(a,o),p=v}this.fullscreenMaterial=this.copyMaterial,this.copyMaterial.inputBuffer=p.texture,e.setRenderTarget(this.renderToScreen?null:s),e.render(a,o)}setSize(e,t){const s=this.resolution;s.setBaseSize(e,t);const r=s.width,n=s.height;this.renderTargetA.setSize(r,n),this.renderTargetB.setSize(r,n),this.blurMaterial.setSize(e,t)}initialize(e,t,s){s!==void 0&&(this.renderTargetA.texture.type=s,this.renderTargetB.texture.type=s,s!==he?(this.blurMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.copyMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1"):e!==null&&e.outputColorSpace===H&&(this.renderTargetA.texture.colorSpace=H,this.renderTargetB.texture.colorSpace=H))}static get AUTO_SIZE(){return G.AUTO_SIZE}},Xs=`#include <common>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#ifdef RANGE
uniform vec2 range;
#elif defined(THRESHOLD)
uniform float threshold;uniform float smoothing;
#endif
varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=luminance(texel.rgb);float mask=1.0;
#ifdef RANGE
float low=step(range.x,l);float high=step(l,range.y);mask=low*high;
#elif defined(THRESHOLD)
mask=smoothstep(threshold,threshold+smoothing,l);
#endif
#ifdef COLOR
gl_FragColor=texel*mask;
#else
gl_FragColor=vec4(l*mask);
#endif
}`,Zs=class extends le{constructor(e=!1,t=null){super({name:"LuminanceMaterial",defines:{THREE_REVISION:vt.replace(/\D+/g,"")},uniforms:{inputBuffer:new I(null),threshold:new I(0),smoothing:new I(1),range:new I(null)},blending:pe,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Xs,vertexShader:bt}),this.colorOutput=e,this.luminanceRange=t}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}get threshold(){return this.uniforms.threshold.value}set threshold(e){this.smoothing>0||e>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.threshold.value=e}getThreshold(){return this.threshold}setThreshold(e){this.threshold=e}get smoothing(){return this.uniforms.smoothing.value}set smoothing(e){this.threshold>0||e>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.smoothing.value=e}getSmoothingFactor(){return this.smoothing}setSmoothingFactor(e){this.smoothing=e}get useThreshold(){return this.threshold>0||this.smoothing>0}set useThreshold(e){}get colorOutput(){return this.defines.COLOR!==void 0}set colorOutput(e){e?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}isColorOutputEnabled(e){return this.colorOutput}setColorOutputEnabled(e){this.colorOutput=e}get useRange(){return this.luminanceRange!==null}set useRange(e){this.luminanceRange=null}get luminanceRange(){return this.uniforms.range.value}set luminanceRange(e){e!==null?this.defines.RANGE="1":delete this.defines.RANGE,this.uniforms.range.value=e,this.needsUpdate=!0}getLuminanceRange(){return this.luminanceRange}setLuminanceRange(e){this.luminanceRange=e}},Ys=class extends W{constructor({renderTarget:e,luminanceRange:t,colorOutput:s,resolutionScale:r=1,width:n=G.AUTO_SIZE,height:a=G.AUTO_SIZE,resolutionX:o=n,resolutionY:c=a}={}){super("LuminancePass"),this.fullscreenMaterial=new Zs(s,t),this.needsSwap=!1,this.renderTarget=e,this.renderTarget===void 0&&(this.renderTarget=new te(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="LuminancePass.Target");const l=this.resolution=new G(this,o,c,r);l.addEventListener("change",u=>this.setSize(l.baseWidth,l.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}render(e,t,s,r,n){const a=this.fullscreenMaterial;a.inputBuffer=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const s=this.resolution;s.setBaseSize(e,t),this.renderTarget.setSize(s.width,s.height)}initialize(e,t,s){s!==void 0&&s!==he&&(this.renderTarget.texture.type=s,this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},Qs=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#define WEIGHT_INNER 0.125
#define WEIGHT_OUTER 0.0555555
varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;float clampToBorder(const in vec2 uv){return float(uv.s>=0.0&&uv.s<=1.0&&uv.t>=0.0&&uv.t<=1.0);}void main(){vec4 c=vec4(0.0);vec4 w=WEIGHT_INNER*vec4(clampToBorder(vUv00),clampToBorder(vUv01),clampToBorder(vUv02),clampToBorder(vUv03));c+=w.x*texture2D(inputBuffer,vUv00);c+=w.y*texture2D(inputBuffer,vUv01);c+=w.z*texture2D(inputBuffer,vUv02);c+=w.w*texture2D(inputBuffer,vUv03);w=WEIGHT_OUTER*vec4(clampToBorder(vUv04),clampToBorder(vUv05),clampToBorder(vUv06),clampToBorder(vUv07));c+=w.x*texture2D(inputBuffer,vUv04);c+=w.y*texture2D(inputBuffer,vUv05);c+=w.z*texture2D(inputBuffer,vUv06);c+=w.w*texture2D(inputBuffer,vUv07);w=WEIGHT_OUTER*vec4(clampToBorder(vUv08),clampToBorder(vUv09),clampToBorder(vUv10),clampToBorder(vUv11));c+=w.x*texture2D(inputBuffer,vUv08);c+=w.y*texture2D(inputBuffer,vUv09);c+=w.z*texture2D(inputBuffer,vUv10);c+=w.w*texture2D(inputBuffer,vUv11);c+=WEIGHT_OUTER*texture2D(inputBuffer,vUv);gl_FragColor=c;
#include <colorspace_fragment>
}`,Js="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;void main(){vUv=position.xy*0.5+0.5;vUv00=vUv+texelSize*vec2(-1.0,1.0);vUv01=vUv+texelSize*vec2(1.0,1.0);vUv02=vUv+texelSize*vec2(-1.0,-1.0);vUv03=vUv+texelSize*vec2(1.0,-1.0);vUv04=vUv+texelSize*vec2(-2.0,2.0);vUv05=vUv+texelSize*vec2(0.0,2.0);vUv06=vUv+texelSize*vec2(2.0,2.0);vUv07=vUv+texelSize*vec2(-2.0,0.0);vUv08=vUv+texelSize*vec2(2.0,0.0);vUv09=vUv+texelSize*vec2(-2.0,-2.0);vUv10=vUv+texelSize*vec2(0.0,-2.0);vUv11=vUv+texelSize*vec2(2.0,-2.0);gl_Position=vec4(position.xy,1.0,1.0);}",er=class extends le{constructor(){super({name:"DownsamplingMaterial",uniforms:{inputBuffer:new I(null),texelSize:new I(new F)},blending:pe,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Qs,vertexShader:Js})}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},tr=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;uniform mediump sampler2D supportBuffer;
#else
uniform lowp sampler2D inputBuffer;uniform lowp sampler2D supportBuffer;
#endif
uniform float radius;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vec4 c=vec4(0.0);c+=texture2D(inputBuffer,vUv0)*0.0625;c+=texture2D(inputBuffer,vUv1)*0.125;c+=texture2D(inputBuffer,vUv2)*0.0625;c+=texture2D(inputBuffer,vUv3)*0.125;c+=texture2D(inputBuffer,vUv)*0.25;c+=texture2D(inputBuffer,vUv4)*0.125;c+=texture2D(inputBuffer,vUv5)*0.0625;c+=texture2D(inputBuffer,vUv6)*0.125;c+=texture2D(inputBuffer,vUv7)*0.0625;vec4 baseColor=texture2D(supportBuffer,vUv);gl_FragColor=mix(baseColor,c,radius);
#include <colorspace_fragment>
}`,sr="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,1.0);vUv1=vUv+texelSize*vec2(0.0,1.0);vUv2=vUv+texelSize*vec2(1.0,1.0);vUv3=vUv+texelSize*vec2(-1.0,0.0);vUv4=vUv+texelSize*vec2(1.0,0.0);vUv5=vUv+texelSize*vec2(-1.0,-1.0);vUv6=vUv+texelSize*vec2(0.0,-1.0);vUv7=vUv+texelSize*vec2(1.0,-1.0);gl_Position=vec4(position.xy,1.0,1.0);}",rr=class extends le{constructor(){super({name:"UpsamplingMaterial",uniforms:{inputBuffer:new I(null),supportBuffer:new I(null),texelSize:new I(new F),radius:new I(.85)},blending:pe,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:tr,vertexShader:sr})}set inputBuffer(e){this.uniforms.inputBuffer.value=e}set supportBuffer(e){this.uniforms.supportBuffer.value=e}get radius(){return this.uniforms.radius.value}set radius(e){this.uniforms.radius.value=e}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},ir=class extends W{constructor(){super("MipmapBlurPass"),this.needsSwap=!1,this.renderTarget=new te(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Upsampling.Mipmap0",this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],this.downsamplingMaterial=new er,this.upsamplingMaterial=new rr,this.resolution=new F}get texture(){return this.renderTarget.texture}get levels(){return this.downsamplingMipmaps.length}set levels(e){if(this.levels!==e){const t=this.renderTarget;this.dispose(),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[];for(let s=0;s<e;++s){const r=t.clone();r.texture.name="Downsampling.Mipmap"+s,this.downsamplingMipmaps.push(r)}this.upsamplingMipmaps.push(t);for(let s=1,r=e-1;s<r;++s){const n=t.clone();n.texture.name="Upsampling.Mipmap"+s,this.upsamplingMipmaps.push(n)}this.setSize(this.resolution.x,this.resolution.y)}}get radius(){return this.upsamplingMaterial.radius}set radius(e){this.upsamplingMaterial.radius=e}render(e,t,s,r,n){const{scene:a,camera:o}=this,{downsamplingMaterial:c,upsamplingMaterial:l}=this,{downsamplingMipmaps:u,upsamplingMipmaps:f}=this;let p=t;this.fullscreenMaterial=c;for(let m=0,d=u.length;m<d;++m){const v=u[m];c.setSize(p.width,p.height),c.inputBuffer=p.texture,e.setRenderTarget(v),e.render(a,o),p=v}this.fullscreenMaterial=l;for(let m=f.length-1;m>=0;--m){const d=f[m];l.setSize(p.width,p.height),l.inputBuffer=p.texture,l.supportBuffer=u[m].texture,e.setRenderTarget(d),e.render(a,o),p=d}}setSize(e,t){const s=this.resolution;s.set(e,t);let r=s.width,n=s.height;for(let a=0,o=this.downsamplingMipmaps.length;a<o;++a)r=Math.round(r*.5),n=Math.round(n*.5),this.downsamplingMipmaps[a].setSize(r,n),a<this.upsamplingMipmaps.length&&this.upsamplingMipmaps[a].setSize(r,n)}initialize(e,t,s){if(s!==void 0){const r=this.downsamplingMipmaps.concat(this.upsamplingMipmaps);for(const n of r)n.texture.type=s;if(s!==he)this.downsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.upsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1";else if(e!==null&&e.outputColorSpace===H)for(const n of r)n.texture.colorSpace=H}}dispose(){super.dispose();for(const e of this.downsamplingMipmaps.concat(this.upsamplingMipmaps))e.dispose()}},nr=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D map;
#else
uniform lowp sampler2D map;
#endif
uniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){outputColor=texture2D(map,uv)*intensity;}`,ar=class extends Fe{constructor({blendFunction:e=N.SCREEN,luminanceThreshold:t=1,luminanceSmoothing:s=.03,mipmapBlur:r=!0,intensity:n=1,radius:a=.85,levels:o=8,kernelSize:c=He.LARGE,resolutionScale:l=.5,width:u=G.AUTO_SIZE,height:f=G.AUTO_SIZE,resolutionX:p=u,resolutionY:m=f}={}){super("BloomEffect",nr,{blendFunction:e,uniforms:new Map([["map",new I(null)],["intensity",new I(n)]])}),this.renderTarget=new te(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Bloom.Target",this.blurPass=new Ks({kernelSize:c}),this.luminancePass=new Ys({colorOutput:!0}),this.luminanceMaterial.threshold=t,this.luminanceMaterial.smoothing=s,this.mipmapBlurPass=new ir,this.mipmapBlurPass.enabled=r,this.mipmapBlurPass.radius=a,this.mipmapBlurPass.levels=o,this.uniforms.get("map").value=r?this.mipmapBlurPass.texture:this.renderTarget.texture;const d=this.resolution=new G(this,p,m,l);d.addEventListener("change",v=>this.setSize(d.baseWidth,d.baseHeight))}get texture(){return this.mipmapBlurPass.enabled?this.mipmapBlurPass.texture:this.renderTarget.texture}getTexture(){return this.texture}getResolution(){return this.resolution}getBlurPass(){return this.blurPass}getLuminancePass(){return this.luminancePass}get luminanceMaterial(){return this.luminancePass.fullscreenMaterial}getLuminanceMaterial(){return this.luminancePass.fullscreenMaterial}get width(){return this.resolution.width}set width(e){this.resolution.preferredWidth=e}get height(){return this.resolution.height}set height(e){this.resolution.preferredHeight=e}get dithering(){return this.blurPass.dithering}set dithering(e){this.blurPass.dithering=e}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(e){this.blurPass.kernelSize=e}get distinction(){return console.warn(this.name,"distinction was removed"),1}set distinction(e){console.warn(this.name,"distinction was removed")}get intensity(){return this.uniforms.get("intensity").value}set intensity(e){this.uniforms.get("intensity").value=e}getIntensity(){return this.intensity}setIntensity(e){this.intensity=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}update(e,t,s){const r=this.renderTarget,n=this.luminancePass;n.enabled?(n.render(e,t),this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(e,n.renderTarget):this.blurPass.render(e,n.renderTarget,r)):this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(e,t):this.blurPass.render(e,t,r)}setSize(e,t){const s=this.resolution;s.setBaseSize(e,t),this.renderTarget.setSize(s.width,s.height),this.blurPass.resolution.copy(s),this.luminancePass.setSize(e,t),this.mipmapBlurPass.setSize(e,t)}initialize(e,t,s){this.blurPass.initialize(e,t,s),this.luminancePass.initialize(e,t,s),this.mipmapBlurPass.initialize(e,t,s),s!==void 0&&(this.renderTarget.texture.type=s,e!==null&&e.outputColorSpace===H&&(this.renderTarget.texture.colorSpace=H))}},St=class extends W{constructor(e,t,s=null){super("RenderPass",e,t),this.needsSwap=!1,this.clearPass=new yt,this.overrideMaterialManager=s===null?null:new Qe(s),this.ignoreBackground=!1,this.skipShadowMapUpdate=!1,this.selection=null}set mainScene(e){this.scene=e}set mainCamera(e){this.camera=e}get renderToScreen(){return super.renderToScreen}set renderToScreen(e){super.renderToScreen=e,this.clearPass.renderToScreen=e}get overrideMaterial(){const e=this.overrideMaterialManager;return e!==null?e.material:null}set overrideMaterial(e){const t=this.overrideMaterialManager;e!==null?t!==null?t.setMaterial(e):this.overrideMaterialManager=new Qe(e):t!==null&&(t.dispose(),this.overrideMaterialManager=null)}getOverrideMaterial(){return this.overrideMaterial}setOverrideMaterial(e){this.overrideMaterial=e}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getSelection(){return this.selection}setSelection(e){this.selection=e}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(e){this.ignoreBackground=e}isShadowMapDisabled(){return this.skipShadowMapUpdate}setShadowMapDisabled(e){this.skipShadowMapUpdate=e}getClearPass(){return this.clearPass}render(e,t,s,r,n){const a=this.scene,o=this.camera,c=this.selection,l=o.layers.mask,u=a.background,f=e.shadowMap.autoUpdate,p=this.renderToScreen?null:t;c!==null&&o.layers.set(c.getLayer()),this.skipShadowMapUpdate&&(e.shadowMap.autoUpdate=!1),(this.ignoreBackground||this.clearPass.overrideClearColor!==null)&&(a.background=null),this.clearPass.enabled&&this.clearPass.render(e,t),e.setRenderTarget(p),this.overrideMaterialManager!==null?this.overrideMaterialManager.render(e,a,o):e.render(a,o),o.layers.mask=l,a.background=u,e.shadowMap.autoUpdate=f}},or=`#include <packing>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
#ifdef DOWNSAMPLE_NORMALS
uniform lowp sampler2D normalBuffer;
#endif
varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
return unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
return texture2D(depthBuffer,uv).r;
#endif
}int findBestDepth(const in float samples[4]){float c=(samples[0]+samples[1]+samples[2]+samples[3])*0.25;float distances[4];distances[0]=abs(c-samples[0]);distances[1]=abs(c-samples[1]);distances[2]=abs(c-samples[2]);distances[3]=abs(c-samples[3]);float maxDistance=max(max(distances[0],distances[1]),max(distances[2],distances[3]));int remaining[3];int rejected[3];int i,j,k;for(i=0,j=0,k=0;i<4;++i){if(distances[i]<maxDistance){remaining[j++]=i;}else{rejected[k++]=i;}}for(;j<3;++j){remaining[j]=rejected[--k];}vec3 s=vec3(samples[remaining[0]],samples[remaining[1]],samples[remaining[2]]);c=(s.x+s.y+s.z)/3.0;distances[0]=abs(c-s.x);distances[1]=abs(c-s.y);distances[2]=abs(c-s.z);float minDistance=min(distances[0],min(distances[1],distances[2]));for(i=0;i<3;++i){if(distances[i]==minDistance){break;}}return remaining[i];}void main(){float d[4];d[0]=readDepth(vUv0);d[1]=readDepth(vUv1);d[2]=readDepth(vUv2);d[3]=readDepth(vUv3);int index=findBestDepth(d);
#ifdef DOWNSAMPLE_NORMALS
vec3 n[4];n[0]=texture2D(normalBuffer,vUv0).rgb;n[1]=texture2D(normalBuffer,vUv1).rgb;n[2]=texture2D(normalBuffer,vUv2).rgb;n[3]=texture2D(normalBuffer,vUv3).rgb;
#else
vec3 n[4];n[0]=vec3(0.0);n[1]=vec3(0.0);n[2]=vec3(0.0);n[3]=vec3(0.0);
#endif
gl_FragColor=vec4(n[index],d[index]);}`,lr="uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=uv;vUv1=vec2(uv.x,uv.y+texelSize.y);vUv2=vec2(uv.x+texelSize.x,uv.y);vUv3=uv+texelSize;gl_Position=vec4(position.xy,1.0,1.0);}",cr=class extends le{constructor(){super({name:"DepthDownsamplingMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new I(null),normalBuffer:new I(null),texelSize:new I(new F)},blending:pe,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:or,vertexShader:lr})}set depthBuffer(e){this.uniforms.depthBuffer.value=e}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=me){this.depthBuffer=e,this.depthPacking=t}set normalBuffer(e){this.uniforms.normalBuffer.value=e,e!==null?this.defines.DOWNSAMPLE_NORMALS="1":delete this.defines.DOWNSAMPLE_NORMALS,this.needsUpdate=!0}setNormalBuffer(e){this.normalBuffer=e}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},ur=class extends W{constructor({normalBuffer:e=null,resolutionScale:t=.5,width:s=G.AUTO_SIZE,height:r=G.AUTO_SIZE,resolutionX:n=s,resolutionY:a=r}={}){super("DepthDownsamplingPass");const o=new cr;o.normalBuffer=e,this.fullscreenMaterial=o,this.needsDepthTexture=!0,this.needsSwap=!1,this.renderTarget=new te(1,1,{minFilter:Ee,magFilter:Ee,depthBuffer:!1,type:Ft}),this.renderTarget.texture.name="DepthDownsamplingPass.Target",this.renderTarget.texture.generateMipmaps=!1;const c=this.resolution=new G(this,n,a,t);c.addEventListener("change",l=>this.setSize(c.baseWidth,c.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}setDepthTexture(e,t=me){this.fullscreenMaterial.depthBuffer=e,this.fullscreenMaterial.depthPacking=t}render(e,t,s,r,n){e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const s=this.resolution;s.setBaseSize(e,t),this.renderTarget.setSize(s.width,s.height),this.fullscreenMaterial.setSize(e,t)}initialize(e,t,s){const r=e.getContext();if(!(r.getExtension("EXT_color_buffer_float")||r.getExtension("EXT_color_buffer_half_float")))throw new Error("Rendering to float texture is not supported.")}},hr=`#include <common>
#include <packing>
#include <dithering_pars_fragment>
#define packFloatToRGBA(v) packDepthToRGBA(v)
#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#if DEPTH_PACKING == 3201
uniform lowp sampler2D depthBuffer;
#elif defined(GL_FRAGMENT_PRECISION_HIGH)
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;vec4 sRGBToLinear(const in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
float depth=unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
float depth=texture2D(depthBuffer,uv).r;
#endif
#if defined(USE_LOGARITHMIC_DEPTH_BUFFER) || defined(LOG_DEPTH)
float d=pow(2.0,depth*log2(cameraFar+1.0))-1.0;float a=cameraFar/(cameraFar-cameraNear);float b=cameraFar*cameraNear/(cameraNear-cameraFar);depth=a+b/d;
#elif defined(USE_REVERSED_DEPTH_BUFFER)
depth=1.0-depth;
#endif
return depth;}float getViewZ(const in float depth){
#ifdef PERSPECTIVE_CAMERA
return perspectiveDepthToViewZ(depth,cameraNear,cameraFar);
#else
return orthographicDepthToViewZ(depth,cameraNear,cameraFar);
#endif
}vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}FRAGMENT_HEAD void main(){FRAGMENT_MAIN_UV vec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);gl_FragColor=color0;
#ifdef ENCODE_OUTPUT
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
}`,dr="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}",pr=class extends le{constructor(e,t,s,r,n=!1){super({name:"EffectMaterial",defines:{THREE_REVISION:vt.replace(/\D+/g,""),DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new I(null),depthBuffer:new I(null),resolution:new I(new F),texelSize:new I(new F),cameraNear:new I(.3),cameraFar:new I(1e3),aspect:new I(1),time:new I(0)},blending:pe,toneMapped:!1,depthWrite:!1,depthTest:!1,dithering:n}),e&&this.setShaderParts(e),t&&this.setDefines(t),s&&this.setUniforms(s),this.copyCameraSettings(r)}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(e){this.uniforms.depthBuffer.value=e}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=me){this.depthBuffer=e,this.depthPacking=t}setShaderData(e){this.setShaderParts(e.shaderParts),this.setDefines(e.defines),this.setUniforms(e.uniforms),this.setExtensions(e.extensions)}setShaderParts(e){return this.fragmentShader=hr.replace(j.FRAGMENT_HEAD,e.get(j.FRAGMENT_HEAD)||"").replace(j.FRAGMENT_MAIN_UV,e.get(j.FRAGMENT_MAIN_UV)||"").replace(j.FRAGMENT_MAIN_IMAGE,e.get(j.FRAGMENT_MAIN_IMAGE)||""),this.vertexShader=dr.replace(j.VERTEX_HEAD,e.get(j.VERTEX_HEAD)||"").replace(j.VERTEX_MAIN_SUPPORT,e.get(j.VERTEX_MAIN_SUPPORT)||""),this.needsUpdate=!0,this}setDefines(e){for(const t of e.entries())this.defines[t[0]]=t[1];return this.needsUpdate=!0,this}setUniforms(e){for(const t of e.entries())this.uniforms[t[0]]=t[1];return this}setExtensions(e){this.extensions={};for(const t of e)this.extensions[t]=!0;return this}get encodeOutput(){return this.defines.ENCODE_OUTPUT!==void 0}set encodeOutput(e){this.encodeOutput!==e&&(e?this.defines.ENCODE_OUTPUT="1":delete this.defines.ENCODE_OUTPUT,this.needsUpdate=!0)}isOutputEncodingEnabled(e){return this.encodeOutput}setOutputEncodingEnabled(e){this.encodeOutput=e}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}setDeltaTime(e){this.uniforms.time.value+=e}adoptCameraSettings(e){this.copyCameraSettings(e)}copyCameraSettings(e){e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof Ht?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(e,t){const s=this.uniforms;s.resolution.value.set(e,t),s.texelSize.value.set(1/e,1/t),s.aspect.value=e/t}static get Section(){return j}};function Je(e,t,s){for(const r of t){const n="$1"+e+r.charAt(0).toUpperCase()+r.slice(1),a=new RegExp("([^\\.])(\\b"+r+"\\b)","g");for(const o of s.entries())o[1]!==null&&s.set(o[0],o[1].replace(a,n))}}function fr(e,t,s){let r=t.getFragmentShader(),n=t.getVertexShader();const a=r!==void 0&&/mainImage/.test(r),o=r!==void 0&&/mainUv/.test(r);if(s.attributes|=t.getAttributes(),r===void 0)throw new Error(`Missing fragment shader (${t.name})`);if(o&&(s.attributes&ue.CONVOLUTION)!==0)throw new Error(`Effects that transform UVs are incompatible with convolution effects (${t.name})`);if(!a&&!o)throw new Error(`Could not find mainImage or mainUv function (${t.name})`);{const c=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,l=s.shaderParts;let u=l.get(j.FRAGMENT_HEAD)||"",f=l.get(j.FRAGMENT_MAIN_UV)||"",p=l.get(j.FRAGMENT_MAIN_IMAGE)||"",m=l.get(j.VERTEX_HEAD)||"",d=l.get(j.VERTEX_MAIN_SUPPORT)||"";const v=new Set,M=new Set;if(o&&(f+=`	${e}MainUv(UV);
`,s.uvTransformation=!0),n!==null&&/mainSupport/.test(n)){const x=/mainSupport *\([\w\s]*?uv\s*?\)/.test(n);d+=`	${e}MainSupport(`,d+=x?`vUv);
`:`);
`;for(const R of n.matchAll(/(?:varying\s+\w+\s+([\S\s]*?);)/g))for(const P of R[1].split(/\s*,\s*/))s.varyings.add(P),v.add(P),M.add(P);for(const R of n.matchAll(c))M.add(R[1])}for(const x of r.matchAll(c))M.add(x[1]);for(const x of t.defines.keys())M.add(x.replace(/\([\w\s,]*\)/g,""));for(const x of t.uniforms.keys())M.add(x);M.delete("while"),M.delete("for"),M.delete("if"),t.uniforms.forEach((x,R)=>s.uniforms.set(e+R.charAt(0).toUpperCase()+R.slice(1),x)),t.defines.forEach((x,R)=>s.defines.set(e+R.charAt(0).toUpperCase()+R.slice(1),x));const y=new Map([["fragment",r],["vertex",n]]);Je(e,M,s.defines),Je(e,M,y),r=y.get("fragment"),n=y.get("vertex");const b=t.blendMode;if(s.blendModes.set(b.blendFunction,b),a){t.inputColorSpace!==null&&t.inputColorSpace!==s.colorSpace&&(p+=t.inputColorSpace===H?`color0 = sRGBTransferOETF(color0);
	`:`color0 = sRGBToLinear(color0);
	`),t.outputColorSpace!==ft?s.colorSpace=t.outputColorSpace:t.inputColorSpace!==null&&(s.colorSpace=t.inputColorSpace);const x=/MainImage *\([\w\s,]*?depth[\w\s,]*?\)/;p+=`${e}MainImage(color0, UV, `,(s.attributes&ue.DEPTH)!==0&&x.test(r)&&(p+="depth, ",s.readDepth=!0),p+=`color1);
	`;const R=e+"BlendOpacity";s.uniforms.set(R,b.opacity),p+=`color0 = blend${b.blendFunction}(color0, color1, ${R});

	`,u+=`uniform float ${R};

`}if(u+=r+`
`,n!==null&&(m+=n+`
`),l.set(j.FRAGMENT_HEAD,u),l.set(j.FRAGMENT_MAIN_UV,f),l.set(j.FRAGMENT_MAIN_IMAGE,p),l.set(j.VERTEX_HEAD,m),l.set(j.VERTEX_MAIN_SUPPORT,d),t.extensions!==null)for(const x of t.extensions)s.extensions.add(x)}}var mr=class extends W{constructor(e,...t){super("EffectPass"),this.fullscreenMaterial=new pr(null,null,null,e),this.listener=s=>this.handleEvent(s),this.effects=[],this.setEffects(t),this.skipRendering=!1,this.minTime=1,this.maxTime=Number.POSITIVE_INFINITY,this.timeScale=1}set mainScene(e){for(const t of this.effects)t.mainScene=e}set mainCamera(e){this.fullscreenMaterial.copyCameraSettings(e);for(const t of this.effects)t.mainCamera=e}get encodeOutput(){return this.fullscreenMaterial.encodeOutput}set encodeOutput(e){this.fullscreenMaterial.encodeOutput=e}get dithering(){return this.fullscreenMaterial.dithering}set dithering(e){const t=this.fullscreenMaterial;t.dithering=e,t.needsUpdate=!0}setEffects(e){for(const t of this.effects)t.removeEventListener("change",this.listener);this.effects=e.sort((t,s)=>s.attributes-t.attributes);for(const t of this.effects)t.addEventListener("change",this.listener)}updateMaterial(){const e=new cs;let t=0;for(const o of this.effects)if(o.blendMode.blendFunction===N.DST)e.attributes|=o.getAttributes()&ue.DEPTH;else{if((e.attributes&o.getAttributes()&ue.CONVOLUTION)!==0)throw new Error(`Convolution effects cannot be merged (${o.name})`);fr("e"+t++,o,e)}let s=e.shaderParts.get(j.FRAGMENT_HEAD),r=e.shaderParts.get(j.FRAGMENT_MAIN_IMAGE),n=e.shaderParts.get(j.FRAGMENT_MAIN_UV);const a=/\bblend\b/g;for(const o of e.blendModes.values())s+=o.getShaderCode().replace(a,`blend${o.blendFunction}`)+`
`;(e.attributes&ue.DEPTH)!==0?(e.readDepth&&(r=`float depth = readDepth(UV);

	`+r),this.needsDepthTexture=this.getDepthTexture()===null):this.needsDepthTexture=!1,e.colorSpace===H&&(r+=`color0 = sRGBToLinear(color0);
	`),e.uvTransformation?(n=`vec2 transformedUv = vUv;
`+n,e.defines.set("UV","transformedUv")):e.defines.set("UV","vUv"),e.shaderParts.set(j.FRAGMENT_HEAD,s),e.shaderParts.set(j.FRAGMENT_MAIN_IMAGE,r),e.shaderParts.set(j.FRAGMENT_MAIN_UV,n);for(const[o,c]of e.shaderParts)c!==null&&e.shaderParts.set(o,c.trim().replace(/^#/,`
#`));this.skipRendering=t===0,this.needsSwap=!this.skipRendering,this.fullscreenMaterial.setShaderData(e)}recompile(){this.updateMaterial()}getDepthTexture(){return this.fullscreenMaterial.depthBuffer}setDepthTexture(e,t=me){this.fullscreenMaterial.depthBuffer=e,this.fullscreenMaterial.depthPacking=t;for(const s of this.effects)s.setDepthTexture(e,t)}render(e,t,s,r,n){for(const a of this.effects)a.update(e,t,r);if(!this.skipRendering||this.renderToScreen){const a=this.fullscreenMaterial;a.inputBuffer=t.texture,a.time+=r*this.timeScale,e.setRenderTarget(this.renderToScreen?null:s),e.render(this.scene,this.camera)}}setSize(e,t){this.fullscreenMaterial.setSize(e,t);for(const s of this.effects)s.setSize(e,t)}initialize(e,t,s){this.renderer=e;for(const r of this.effects)r.initialize(e,t,s);this.updateMaterial(),s!==void 0&&s!==he&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}dispose(){super.dispose();for(const e of this.effects)e.removeEventListener("change",this.listener),e.dispose()}handleEvent(e){e.type==="change"&&this.recompile()}},gr=class extends W{constructor(e,t,{renderTarget:s,resolutionScale:r=1,width:n=G.AUTO_SIZE,height:a=G.AUTO_SIZE,resolutionX:o=n,resolutionY:c=a}={}){super("NormalPass"),this.needsSwap=!1,this.renderPass=new St(e,t,new Ut);const l=this.renderPass;l.ignoreBackground=!0,l.skipShadowMapUpdate=!0;const u=l.getClearPass();u.overrideClearColor=new Q(7829503),u.overrideClearAlpha=1,this.renderTarget=s,this.renderTarget===void 0&&(this.renderTarget=new te(1,1,{minFilter:Ee,magFilter:Ee}),this.renderTarget.texture.name="NormalPass.Target");const f=this.resolution=new G(this,o,c,r);f.addEventListener("change",p=>this.setSize(f.baseWidth,f.baseHeight))}set mainScene(e){this.renderPass.mainScene=e}set mainCamera(e){this.renderPass.mainCamera=e}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,s,r,n){const a=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,a,a)}setSize(e,t){const s=this.resolution;s.setBaseSize(e,t),this.renderTarget.setSize(s.width,s.height)}};function be(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}new F;new F;function Tt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Z=function e(t,s,r){var n=this;Tt(this,e),be(this,"dot2",function(a,o){return n.x*a+n.y*o}),be(this,"dot3",function(a,o,c){return n.x*a+n.y*o+n.z*c}),this.x=t,this.y=s,this.z=r},vr=[new Z(1,1,0),new Z(-1,1,0),new Z(1,-1,0),new Z(-1,-1,0),new Z(1,0,1),new Z(-1,0,1),new Z(1,0,-1),new Z(-1,0,-1),new Z(0,1,1),new Z(0,-1,1),new Z(0,1,-1),new Z(0,-1,-1)],et=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],tt=new Array(512),st=new Array(512),br=function(t){t>0&&t<1&&(t*=65536),t=Math.floor(t),t<256&&(t|=t<<8);for(var s=0;s<256;s++){var r;s&1?r=et[s]^t&255:r=et[s]^t>>8&255,tt[s]=tt[s+256]=r,st[s]=st[s+256]=vr[r%12]}};br(0);function xr(e){if(typeof e=="number")e=Math.abs(e);else if(typeof e=="string"){var t=e;e=0;for(var s=0;s<t.length;s++)e=(e+(s+1)*(t.charCodeAt(s)%96))%2147483647}return e===0&&(e=311),e}function rt(e){var t=xr(e);return function(){var s=t*48271%2147483647;return t=s,s/2147483647}}var yr=function e(t){var s=this;Tt(this,e),be(this,"seed",0),be(this,"init",function(r){s.seed=r,s.value=rt(r)}),be(this,"value",rt(this.seed)),this.init(t)};new yr(Math.random());const Sr=h.createContext(null),it=e=>(e.getAttributes()&2)===2,Tr=h.memo(h.forwardRef(({children:e,camera:t,scene:s,resolutionScale:r,enabled:n=!0,renderPriority:a=1,autoClear:o=!0,depthBuffer:c,enableNormalPass:l,stencilBuffer:u,multisampling:f=8,frameBufferType:p=Wt},m)=>{const{gl:d,scene:v,camera:M,size:y}=Le(),b=s||v,x=t||M,[R,P,C]=h.useMemo(()=>{const g=new ls(d,{depthBuffer:c,stencilBuffer:u,multisampling:f,frameBufferType:p});g.addPass(new St(b,x));let w=null,E=null;return l&&(E=new gr(b,x),E.enabled=!1,g.addPass(E),r!==void 0&&(w=new ur({normalBuffer:E.texture,resolutionScale:r}),w.enabled=!1,g.addPass(w))),[g,E,w]},[x,d,c,u,f,p,b,l,r]);h.useEffect(()=>R?.setSize(y.width,y.height),[R,y]),q((g,w)=>{if(n){const E=d.autoClear;d.autoClear=o,u&&!o&&d.clearStencil(),R.render(w),d.autoClear=E}},n?a:0);const T=h.useRef(null);h.useLayoutEffect(()=>{const g=[],w=T.current.__r3f;if(w&&R){const E=w.children;for(let A=0;A<E.length;A++){const z=E[A].object;if(z instanceof Fe){const _=[z];if(!it(z)){let k=null;for(;(k=E[A+1]?.object)instanceof Fe&&!it(k);)_.push(k),A++}const O=new mr(x,..._);g.push(O)}else z instanceof W&&g.push(z)}for(const A of g)R?.addPass(A);P&&(P.enabled=!0),C&&(C.enabled=!0)}return()=>{for(const E of g)R?.removePass(E);P&&(P.enabled=!1),C&&(C.enabled=!1)}},[R,e,x,P,C]),h.useEffect(()=>{const g=d.toneMapping;return d.toneMapping=$t,()=>{d.toneMapping=g}},[d]);const B=h.useMemo(()=>({composer:R,normalPass:P,downSamplingPass:C,resolutionScale:r,camera:x,scene:b}),[R,P,C,r,x,b]);return h.useImperativeHandle(m,()=>R,[R]),i.jsx(Sr.Provider,{value:B,children:i.jsx("group",{ref:T,children:e})})}));let wr=0;const nt=new WeakMap,Er=(e,t)=>function({blendFunction:s=t?.blendFunction,opacity:r=t?.opacity,...n}){let a=nt.get(e);if(!a){const l=`@react-three/postprocessing/${e.name}-${wr++}`;qt({[l]:e}),nt.set(e,a=l)}const o=Le(l=>l.camera),c=Kt.useMemo(()=>[...t?.args??[],...n.args??[{...t,...n}]],[JSON.stringify(n)]);return i.jsx(a,{camera:o,"blendMode-blendFunction":s,"blendMode-opacity-value":r,...n,args:c})},Rr=Er(ar,{blendFunction:0});class Mr{points=[];position;params;dt=.01;perturbation=new U(1,0,0);lyapunovSum=0;lyapunovSteps=0;lyapunovExponent=0;RENORM_INTERVAL=10;stepsSinceRenorm=0;prevZ=0;prevDz=0;poincarePoints=[];MAX_POINCARE=5e3;constructor(t=new U(1,1,1),s){this.position=t.clone(),this.params=s,this.points=[this.position.clone()],this.prevZ=t.z}derivatives(t,s,r){const{sigma:n,rho:a,beta:o}=this.params;return[n*(s-t),t*(a-r)-s,t*s-o*r]}jacobianApply(t,s,r,n,a,o){const{sigma:c,rho:l,beta:u}=this.params;return[c*(a-n),(l-r)*n-a-t*o,s*n+t*a-u*o]}step(t=1){const s=this.dt*t,{x:r,y:n,z:a}=this.position,[o,c,l]=this.derivatives(r,n,a),[u,f,p]=this.derivatives(r+.5*s*o,n+.5*s*c,a+.5*s*l),[m,d,v]=this.derivatives(r+.5*s*u,n+.5*s*f,a+.5*s*p),[M,y,b]=this.derivatives(r+s*m,n+s*d,a+s*v);this.position.x+=s/6*(o+2*u+2*m+M),this.position.y+=s/6*(c+2*f+2*d+y),this.position.z+=s/6*(l+2*p+2*v+b),(!isFinite(this.position.x)||!isFinite(this.position.y)||!isFinite(this.position.z)||Math.abs(this.position.x)>1e6)&&this.position.set(1,1,1),this.points.push(this.position.clone());const x=this.perturbation.x,R=this.perturbation.y,P=this.perturbation.z,[C,T,B]=this.jacobianApply(this.position.x,this.position.y,this.position.z,x,R,P);if(this.perturbation.x+=C*s,this.perturbation.y+=T*s,this.perturbation.z+=B*s,this.stepsSinceRenorm++,this.stepsSinceRenorm>=this.RENORM_INTERVAL){const w=this.perturbation.length();if(w>0&&isFinite(w)){this.lyapunovSum+=Math.log(w),this.lyapunovSteps++,this.perturbation.divideScalar(w);const E=this.lyapunovSteps*this.RENORM_INTERVAL*this.dt;this.lyapunovExponent=this.lyapunovSum/E}this.stepsSinceRenorm=0}const g=this.position.z-this.prevZ;return this.prevDz>0&&g<=0&&this.points.length>100&&(this.poincarePoints.push([this.position.x,this.position.y]),this.poincarePoints.length>this.MAX_POINCARE&&this.poincarePoints.splice(0,this.poincarePoints.length-this.MAX_POINCARE)),this.prevDz=g,this.prevZ=this.position.z,this.position.clone()}reset(t=new U(1,1,1)){this.position=t.clone(),this.points=[this.position.clone()],this.perturbation.set(1,0,0),this.lyapunovSum=0,this.lyapunovSteps=0,this.lyapunovExponent=0,this.stepsSinceRenorm=0,this.prevZ=t.z,this.prevDz=0,this.poincarePoints=[]}updateParams(t){this.params={...this.params,...t}}trimTrail(t){this.points.length>t&&this.points.splice(0,this.points.length-t)}getSpeed(){if(this.points.length<2)return 0;const t=this.points[this.points.length-1],s=this.points[this.points.length-2];return t.distanceTo(s)}getParams(){return{...this.params}}}const V={classic:{bg:"#000010",bgRgb:"0,0,16",panelBg:"rgba(20, 20, 25, 0.95)",panelBorder:"rgba(255, 255, 255, 0.1)",text:"#cccccc",textMuted:"rgba(255,255,255,0.6)",accent:"#88ccff",accent2:"#aaffaa",heading:"#88ccff",paramColor:"#ffcc88",trailHue1:.55,trailHue2:.85,starColor:"#ffffff"},neon:{bg:"#000000",bgRgb:"0,0,0",panelBg:"rgba(10, 0, 20, 0.95)",panelBorder:"rgba(255, 0, 255, 0.25)",text:"#e0e0e0",textMuted:"rgba(255,255,255,0.5)",accent:"#ff00ff",accent2:"#00ffff",heading:"#ff44ff",paramColor:"#ffff00",trailHue1:.83,trailHue2:.5,starColor:"#ff88ff"},blueprint:{bg:"#0a1628",bgRgb:"10,22,40",panelBg:"rgba(15, 30, 60, 0.95)",panelBorder:"rgba(100, 160, 255, 0.3)",text:"#c0d8f0",textMuted:"rgba(192,216,240,0.6)",accent:"#4488ff",accent2:"#88bbff",heading:"#6699ff",paramColor:"#aaccff",trailHue1:.6,trailHue2:.58,starColor:"#4488ff"},terminal:{bg:"#000a00",bgRgb:"0,10,0",panelBg:"rgba(0, 15, 0, 0.95)",panelBorder:"rgba(0, 255, 0, 0.2)",text:"#00dd00",textMuted:"rgba(0,220,0,0.5)",accent:"#00ff00",accent2:"#88ff88",heading:"#00ff00",paramColor:"#44ff44",trailHue1:.33,trailHue2:.28,starColor:"#00ff00"}},ae=[{name:"The Butterfly Effect",emoji:"",description:"Two nearly identical universes diverge into completely different futures",system:"lorenz",params:{sigma:10,rho:28,beta:8/3},trailLength:2e3,speed:1,sideBySide:!0,offset:1e-6},{name:"The Strange Attractor",emoji:"",description:"The iconic Lorenz butterfly  a shape that never repeats, yet never escapes",system:"lorenz",params:{sigma:10,rho:28,beta:8/3},trailLength:4e3,speed:1.5,sideBySide:!1,offset:.001},{name:"Edge of Order",emoji:"",description:"Right at the boundary where predictable behavior gives way to chaos",system:"lorenz",params:{sigma:10,rho:24.5,beta:8/3},trailLength:3e3,speed:.8,sideBySide:!1,offset:.001},{name:"The Spiral",emoji:"",description:"The Rssler attractor  simplicity breeds complexity in this elegant spiral",system:"rossler",params:{a:.2,b:.2,c:5.7},trailLength:3500,speed:1.2,sideBySide:!1,offset:.001},{name:"Period Doubling",emoji:"",description:"Watch the Rssler system trace a period-2 orbit  the route to chaos begins",system:"rossler",params:{a:.2,b:.2,c:3.5},trailLength:3e3,speed:1,sideBySide:!1,offset:.001},{name:"The Pendulum",emoji:"",description:"A simple double pendulum  deterministic laws, unpredictable motion",system:"doublePendulum",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},trailLength:2e3,speed:1,sideBySide:!1,offset:.001},{name:"Dual Pendulums",emoji:"",description:"Two pendulums, almost identical  watch them dance apart",system:"doublePendulum",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},trailLength:1500,speed:1,sideBySide:!0,offset:1e-4}],D=Xt(e=>({currentSystem:"lorenz",setCurrentSystem:t=>e({currentSystem:t}),isPlaying:!0,setIsPlaying:t=>e({isPlaying:t}),speed:1,setSpeed:t=>e({speed:t}),trailLength:2e3,setTrailLength:t=>e({trailLength:t}),sideBySideMode:!1,setSideBySideMode:t=>e({sideBySideMode:t}),initialOffset:.001,setInitialOffset:t=>e({initialOffset:t}),divergence:0,setDivergence:t=>e({divergence:t}),colorTheme:"classic",setColorTheme:t=>e({colorTheme:t}),lorenzParams:{sigma:10,rho:28,beta:8/3},setLorenzParams:t=>e(s=>({lorenzParams:{...s.lorenzParams,...t}})),rosslerParams:{a:.2,b:.2,c:5.7},setRosslerParams:t=>e(s=>({rosslerParams:{...s.rosslerParams,...t}})),doublePendulumParams:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},setDoublePendulumParams:t=>e(s=>({doublePendulumParams:{...s.doublePendulumParams,...t}})),currentPreset:null,setCurrentPreset:t=>e({currentPreset:t}),showInfoPanel:!0,setShowInfoPanel:t=>e({showInfoPanel:t}),autoRotate:!0,setAutoRotate:t=>e({autoRotate:t}),_resetCounter:0,resetSimulation:()=>{e(t=>({_resetCounter:t._resetCounter+1,isPlaying:!1})),setTimeout(()=>e({isPlaying:!0}),100)},showPerformanceWarning:!1,setShowPerformanceWarning:t=>e({showPerformanceWarning:t}),showLyapunov:!1,setShowLyapunov:t=>e({showLyapunov:t}),lyapunovExponent:0,setLyapunovExponent:t=>e({lyapunovExponent:t}),showBifurcation:!1,setShowBifurcation:t=>e({showBifurcation:t}),showPoincare:!1,setShowPoincare:t=>e({showPoincare:t}),showParameterSpace:!1,setShowParameterSpace:t=>e({showParameterSpace:t}),cinematicCamera:!1,setCinematicCamera:t=>e({cinematicCamera:t}),chaosAutopilot:!1,setChaosAutopilot:t=>e({chaosAutopilot:t}),storyMode:!1,setStoryMode:t=>e({storyMode:t}),currentStoryIndex:0,setCurrentStoryIndex:t=>e({currentStoryIndex:t}),bloomEnabled:!0,setBloomEnabled:t=>e({bloomEnabled:t}),bloomIntensity:1.5,setBloomIntensity:t=>e({bloomIntensity:t}),audioEnabled:!1,setAudioEnabled:t=>e({audioEnabled:t}),audioVolume:.3,setAudioVolume:t=>e({audioVolume:t})})),at={lorenz:[{name:"Classic Lorenz",description:"The original butterfly attractor",params:{sigma:10,rho:28,beta:8/3}},{name:"Edge of Chaos",description:"Parameters at the edge between order and chaos",params:{sigma:10,rho:24,beta:8/3}},{name:"Strange Attractor",description:"Different parameter set creating unique patterns",params:{sigma:12,rho:30,beta:2.5}}],rossler:[{name:"Classic Rssler",description:"The standard Rssler attractor parameters",params:{a:.2,b:.2,c:5.7}},{name:"Spiral Focus",description:"Creates tighter spiral patterns",params:{a:.1,b:.1,c:4}},{name:"Period Doubling",description:"Shows period-doubling route to chaos",params:{a:.15,b:.2,c:10}}],doublePendulum:[{name:"Equal Masses",description:"Two pendulums with equal mass and length",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0}},{name:"Heavy Bottom",description:"Bottom pendulum twice as heavy",params:{mass1:1,mass2:2,length1:1,length2:1,gravity:9.81,damping:0}},{name:"With Damping",description:"Small damping showing energy dissipation",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:.05}}]},se=6e3,Ge=({points:e,hueStart:t,hueEnd:s,scale:r=1,flatZ:n=!1,glowIntensity:a=.6})=>{const o=h.useRef(null),c=h.useRef(null),l=h.useRef(null),u=h.useRef(null),{posBuffer:f,colorBuffer:p,glowColorBuffer:m}=h.useMemo(()=>({posBuffer:new Float32Array(se*3),colorBuffer:new Float32Array(se*3),glowColorBuffer:new Float32Array(se*3)}),[]);q(()=>{if(!l.current||!u.current)return;const M=Math.min(e.length,se);if(M<2){l.current.setDrawRange(0,0),u.current.setDrawRange(0,0);return}const y=Math.max(0,e.length-se),b=r;for(let T=0;T<M;T++){const B=e[y+T],g=T*3;f[g]=B.x*b,f[g+1]=B.y*b,f[g+2]=n?0:B.z*b;const w=T/(M-1),E=w*w,A=t+(s-t)*w,z=.8+w*.2,_=.3+E*.55,O=(1-Math.abs(2*_-1))*z,k=(A%1+1)%1*6,L=O*(1-Math.abs(k%2-1)),K=_-O/2,ge=Math.floor(k)%6;let X=0,J=0,$=0;switch(ge){case 0:X=O,J=L;break;case 1:X=L,J=O;break;case 2:J=O,$=L;break;case 3:J=L,$=O;break;case 4:X=L,$=O;break;case 5:X=O,$=L;break}p[g]=(X+K)*E,p[g+1]=(J+K)*E,p[g+2]=($+K)*E;const fe=E*a,Y=1.5+w*.5;m[g]=(X+K)*fe*Y,m[g+1]=(J+K)*fe*Y,m[g+2]=($+K)*fe*Y}const x=l.current.getAttribute("position"),R=l.current.getAttribute("color");x.set(f.subarray(0,M*3)),R.set(p.subarray(0,M*3)),x.needsUpdate=!0,R.needsUpdate=!0,l.current.setDrawRange(0,M);const P=u.current.getAttribute("position"),C=u.current.getAttribute("color");P.set(f.subarray(0,M*3)),C.set(m.subarray(0,M*3)),P.needsUpdate=!0,C.needsUpdate=!0,u.current.setDrawRange(0,M)}),h.useEffect(()=>{!l.current||!u.current||(l.current.setAttribute("position",new re(new Float32Array(se*3),3)),l.current.setAttribute("color",new re(new Float32Array(se*3),3)),l.current.setDrawRange(0,0),u.current.setAttribute("position",new re(new Float32Array(se*3),3)),u.current.setAttribute("color",new re(new Float32Array(se*3),3)),u.current.setDrawRange(0,0))},[]);const d=h.useMemo(()=>new Xe({vertexColors:!0,transparent:!0,opacity:1,depthWrite:!1,blending:de}),[]),v=h.useMemo(()=>new Xe({vertexColors:!0,transparent:!0,opacity:.5,depthWrite:!1,blending:de}),[]);return i.jsxs(i.Fragment,{children:[i.jsxs("primitive",{object:new Ze,ref:o,children:[i.jsx("bufferGeometry",{ref:l}),i.jsx("primitive",{object:d,attach:"material"})]}),i.jsxs("primitive",{object:new Ze,ref:c,children:[i.jsx("bufferGeometry",{ref:u}),i.jsx("primitive",{object:v,attach:"material"})]})]})},Ve=({position:e,color:t,lightIntensity:s=.8,size:r=1,showPulse:n=!0})=>{const a=h.useRef(null),o=h.useRef(null),c=h.useRef(null),l=h.useRef(Math.random()*Math.PI*2),u=h.useMemo(()=>{const f=t.clone();return f.offsetHSL(0,.1,.2),f},[t]);return q(({clock:f})=>{const p=f.getElapsedTime();if(l.current+=.04,o.current){const m=1+Math.sin(p*3)*.15,d=.05*r*m;o.current.scale.setScalar(d/(.05*r)||1)}if(c.current){const m=1+Math.sin(p*3+Math.PI)*.2,d=c.current.material;d.opacity=.15+Math.sin(p*2.5)*.08;const v=.12*r*m;c.current.scale.setScalar(v/(.12*r)||1)}if(a.current&&n){const m=p*1.2%2,d=.05+m*.15*r;a.current.scale.set(d,d,1);const v=a.current.material;v.opacity=Math.max(0,.4*(1-m/2))}}),i.jsxs("group",{position:e,children:[s>0&&i.jsx("pointLight",{color:t,intensity:s*.4,distance:1.5*r,decay:2}),i.jsxs("mesh",{ref:c,children:[i.jsx("sphereGeometry",{args:[.12*r,16,16]}),i.jsx("meshBasicMaterial",{color:t,transparent:!0,opacity:.15,depthWrite:!1,blending:de})]}),i.jsxs("mesh",{ref:o,children:[i.jsx("sphereGeometry",{args:[.05*r,16,16]}),i.jsx("meshBasicMaterial",{color:u,transparent:!0,opacity:.95})]}),n&&i.jsxs("mesh",{ref:a,rotation:[Math.PI/2,0,0],children:[i.jsx("ringGeometry",{args:[.8,1,32]}),i.jsx("meshBasicMaterial",{color:t,transparent:!0,opacity:.3,side:ve,depthWrite:!1,blending:de})]})]})},Pr=({position:e=[0,0,0],scale:t=.1,initialCondition:s=[1,1,1],isSecondary:r=!1,lastPosRef:n})=>{const a=h.useRef(null),{isPlaying:o,speed:c,trailLength:l,lorenzParams:u,_resetCounter:f,colorTheme:p,showLyapunov:m,setLyapunovExponent:d,showPoincare:v}=D(),M=V[p],y=h.useMemo(()=>{const T=new U(...s);return new Mr(T,u)},[s[0],s[1],s[2],u.sigma,u.rho,u.beta]);h.useEffect(()=>{y.reset(new U(...s))},[f]),h.useEffect(()=>{y.updateParams(u)},[u,y]);const b=h.useRef(y);b.current=y,h.useEffect(()=>(r||(window.__chaosLabSystem=y,window.__chaosLabSystemType="lorenz"),()=>{!r&&window.__chaosLabSystem===y&&(window.__chaosLabSystem=null)}),[y,r]);const x=h.useRef(0);q(()=>{if(!o)return;y.step(c*.5),y.trimTrail(l);const T=y.points;if(n&&T.length>0){const B=T[T.length-1];n.current=B.clone()}!r&&(m||v)&&(x.current++,x.current%30===0&&d(y.lyapunovExponent))});const R=r?M.trailHue2:M.trailHue1,P=R+.2,C=new Q().setHSL(R+.15,1,.7);return i.jsxs("group",{ref:a,position:e,children:[i.jsx(Ge,{points:y.points,hueStart:R,hueEnd:P,lineWidth:2.5,glowIntensity:.5,scale:t}),y.points.length>0&&(()=>{const T=y.points[y.points.length-1];return i.jsx(Ve,{position:[T.x*t,T.y*t,T.z*t],color:C,lightIntensity:r?.4:.8,size:.8,showPulse:!r})})()]})};class Cr{points=[];position;params;dt=.01;perturbation=new U(1,0,0);lyapunovSum=0;lyapunovSteps=0;lyapunovExponent=0;RENORM_INTERVAL=10;stepsSinceRenorm=0;prevY=0;poincarePoints=[];MAX_POINCARE=5e3;constructor(t=new U(1,1,1),s){this.position=t.clone(),this.params=s,this.points=[this.position.clone()],this.prevY=t.y}derivatives(t,s,r){const{a:n,b:a,c:o}=this.params;return[-s-r,t+n*s,a+r*(t-o)]}jacobianApply(t,s,r,n,a,o){const{a:c,c:l}=this.params;return[-a-o,n+c*a,r*n+(t-l)*o]}step(t=1){const s=this.dt*t,{x:r,y:n,z:a}=this.position,[o,c,l]=this.derivatives(r,n,a),[u,f,p]=this.derivatives(r+.5*s*o,n+.5*s*c,a+.5*s*l),[m,d,v]=this.derivatives(r+.5*s*u,n+.5*s*f,a+.5*s*p),[M,y,b]=this.derivatives(r+s*m,n+s*d,a+s*v);this.position.x+=s/6*(o+2*u+2*m+M),this.position.y+=s/6*(c+2*f+2*d+y),this.position.z+=s/6*(l+2*p+2*v+b),(!isFinite(this.position.x)||!isFinite(this.position.y)||!isFinite(this.position.z)||Math.abs(this.position.x)>1e6)&&this.position.set(1,1,1),this.points.push(this.position.clone());const x=this.perturbation.x,R=this.perturbation.y,P=this.perturbation.z,[C,T,B]=this.jacobianApply(this.position.x,this.position.y,this.position.z,x,R,P);if(this.perturbation.x+=C*s,this.perturbation.y+=T*s,this.perturbation.z+=B*s,this.stepsSinceRenorm++,this.stepsSinceRenorm>=this.RENORM_INTERVAL){const g=this.perturbation.length();if(g>0&&isFinite(g)){this.lyapunovSum+=Math.log(g),this.lyapunovSteps++,this.perturbation.divideScalar(g);const w=this.lyapunovSteps*this.RENORM_INTERVAL*this.dt;this.lyapunovExponent=this.lyapunovSum/w}this.stepsSinceRenorm=0}return this.prevY<0&&this.position.y>=0&&this.points.length>100&&(this.poincarePoints.push([this.position.x,this.position.z]),this.poincarePoints.length>this.MAX_POINCARE&&this.poincarePoints.splice(0,this.poincarePoints.length-this.MAX_POINCARE)),this.prevY=this.position.y,this.position.clone()}reset(t=new U(1,1,1)){this.position=t.clone(),this.points=[this.position.clone()],this.perturbation.set(1,0,0),this.lyapunovSum=0,this.lyapunovSteps=0,this.lyapunovExponent=0,this.stepsSinceRenorm=0,this.prevY=t.y,this.poincarePoints=[]}updateParams(t){this.params={...this.params,...t}}trimTrail(t){this.points.length>t&&this.points.splice(0,this.points.length-t)}getSpeed(){if(this.points.length<2)return 0;const t=this.points[this.points.length-1],s=this.points[this.points.length-2];return t.distanceTo(s)}getParams(){return{...this.params}}}const _r=({position:e=[0,0,0],scale:t=.5,initialCondition:s=[1,1,1],isSecondary:r=!1,lastPosRef:n})=>{const a=h.useRef(null),{isPlaying:o,speed:c,trailLength:l,rosslerParams:u,_resetCounter:f,colorTheme:p,showLyapunov:m,setLyapunovExponent:d,showPoincare:v,currentSystem:M}=D(),y=V[p],b=h.useMemo(()=>{const T=new U(...s);return new Cr(T,u)},[s[0],s[1],s[2],u.a,u.b,u.c]);h.useEffect(()=>{b.reset(new U(...s))},[f]),h.useEffect(()=>{b.updateParams(u)},[u,b]),h.useEffect(()=>(r||(window.__chaosLabSystem=b,window.__chaosLabSystemType="rossler"),()=>{!r&&window.__chaosLabSystem===b&&(window.__chaosLabSystem=null)}),[b,r]);const x=h.useRef(0);q(()=>{if(!o)return;b.step(c*.5),b.trimTrail(l);const T=b.points;if(n&&T.length>0){const B=T[T.length-1];n.current=B.clone()}!r&&M==="rossler"&&(m||v)&&(x.current++,x.current%30===0&&d(b.lyapunovExponent))});const R=r?y.trailHue2:y.trailHue1,P=R+.25,C=new Q().setHSL(R+.15,1,.8);return i.jsxs("group",{ref:a,position:e,children:[i.jsx(Ge,{points:b.points,hueStart:R,hueEnd:P,lineWidth:2.5,glowIntensity:.5,scale:t}),b.points.length>0&&(()=>{const T=b.points[b.points.length-1];return i.jsx(Ve,{position:[T.x*t,T.y*t,T.z*t],color:C,lightIntensity:r?.5:1,size:1,showPulse:!r})})()]})};class Br{points=[];positions=[];state;params;dt=.005;pertState={theta1:1e-6,theta2:0,omega1:0,omega2:0};lyapunovSum=0;lyapunovSteps=0;lyapunovExponent=0;RENORM_INTERVAL=20;stepsSinceRenorm=0;prevTheta2=0;poincarePoints=[];MAX_POINCARE=5e3;constructor(t={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0},s){this.state={...t},this.params=s,this.prevTheta2=t.theta2;const r=this.calculatePositions();this.positions=[r],this.points=[new U(r.p2.x,r.p2.y,0)]}calculatePositions(){const{length1:t,length2:s}=this.params,{theta1:r,theta2:n}=this.state,a=new F(t*Math.sin(r),-t*Math.cos(r)),o=new F(a.x+s*Math.sin(n),a.y-s*Math.cos(n));return{p1:a,p2:o}}accelerations(t){const{mass1:s,mass2:r,length1:n,length2:a,gravity:o,damping:c}=this.params,{theta1:l,theta2:u,omega1:f,omega2:p}=t,m=s,d=r,v=n,M=a,y=o,b=Math.cos(l-u),x=Math.sin(l-u),R=Math.sin(l),P=Math.sin(u),C=(m+d)*v-d*v*b*b,T=M/v*C,B=-d*v*f*f*x*b+d*y*P*b+d*M*p*p*x-(m+d)*y*R,g=-d*M*p*p*x*b+(m+d)*y*R*b+(m+d)*v*f*f*x-(m+d)*y*P;let w=B/C,E=g/T;return w-=c*f,E-=c*p,{alpha1:w,alpha2:E}}stateDerivative(t){const{alpha1:s,alpha2:r}=this.accelerations(t);return{theta1:t.omega1,theta2:t.omega2,omega1:s,omega2:r}}addStates(t,s,r){return{theta1:t.theta1+s.theta1*r,theta2:t.theta2+s.theta2*r,omega1:t.omega1+s.omega1*r,omega2:t.omega2+s.omega2*r}}step(t=1){const s=this.dt*t,r=this.stateDerivative(this.state),n=this.stateDerivative(this.addStates(this.state,r,.5*s)),a=this.stateDerivative(this.addStates(this.state,n,.5*s)),o=this.stateDerivative(this.addStates(this.state,a,s));this.state.theta1+=s/6*(r.theta1+2*n.theta1+2*a.theta1+o.theta1),this.state.theta2+=s/6*(r.theta2+2*n.theta2+2*a.theta2+o.theta2),this.state.omega1+=s/6*(r.omega1+2*n.omega1+2*a.omega1+o.omega1),this.state.omega2+=s/6*(r.omega2+2*n.omega2+2*a.omega2+o.omega2),(!isFinite(this.state.theta1)||!isFinite(this.state.theta2)||!isFinite(this.state.omega1)||!isFinite(this.state.omega2)||Math.abs(this.state.omega1)>1e6||Math.abs(this.state.omega2)>1e6)&&(this.state={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0});const c=this.calculatePositions();this.positions.push(c),this.points.push(new U(c.p2.x,c.p2.y,0));const l=1e-7,u={theta1:this.state.theta1+this.pertState.theta1*l,theta2:this.state.theta2+this.pertState.theta2*l,omega1:this.state.omega1+this.pertState.omega1*l,omega2:this.state.omega2+this.pertState.omega2*l},f=this.stateDerivative(this.state),p=this.stateDerivative(u);if(this.pertState.theta1+=(p.theta1-f.theta1)/l*s,this.pertState.theta2+=(p.theta2-f.theta2)/l*s,this.pertState.omega1+=(p.omega1-f.omega1)/l*s,this.pertState.omega2+=(p.omega2-f.omega2)/l*s,this.stepsSinceRenorm++,this.stepsSinceRenorm>=this.RENORM_INTERVAL){const v=Math.sqrt(this.pertState.theta1**2+this.pertState.theta2**2+this.pertState.omega1**2+this.pertState.omega2**2);if(v>0&&isFinite(v)){this.lyapunovSum+=Math.log(v),this.lyapunovSteps++,this.pertState.theta1/=v,this.pertState.theta2/=v,this.pertState.omega1/=v,this.pertState.omega2/=v;const M=this.lyapunovSteps*this.RENORM_INTERVAL*this.dt;this.lyapunovExponent=this.lyapunovSum/M}this.stepsSinceRenorm=0}const m=(this.state.theta2%(2*Math.PI)+2*Math.PI)%(2*Math.PI);return(this.prevTheta2%(2*Math.PI)+2*Math.PI)%(2*Math.PI)>Math.PI&&m<=Math.PI&&m<1&&this.points.length>100&&(this.poincarePoints.push([this.state.theta1,this.state.omega1]),this.poincarePoints.length>this.MAX_POINCARE&&this.poincarePoints.splice(0,this.poincarePoints.length-this.MAX_POINCARE)),this.prevTheta2=this.state.theta2,new U(c.p2.x,c.p2.y,0)}reset(t={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0}){this.state={...t};const s=this.calculatePositions();this.positions=[s],this.points=[new U(s.p2.x,s.p2.y,0)],this.pertState={theta1:1e-6,theta2:0,omega1:0,omega2:0},this.lyapunovSum=0,this.lyapunovSteps=0,this.lyapunovExponent=0,this.stepsSinceRenorm=0,this.prevTheta2=t.theta2,this.poincarePoints=[]}updateParams(t){this.params={...this.params,...t}}trimTrail(t){if(this.points.length>t){const s=this.points.length-t;this.points.splice(0,s),this.positions.splice(0,s)}}getSpeed(){if(this.points.length<2)return 0;const t=this.points[this.points.length-1],s=this.points[this.points.length-2];return t.distanceTo(s)}getCurrentPositions(){return this.positions[this.positions.length-1]}getState(){return{...this.state}}}const Ar=({position:e=[0,0,0],scale:t=1,initialCondition:s={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0},isSecondary:r=!1,lastPosRef:n})=>{const a=h.useRef(null),{isPlaying:o,speed:c,trailLength:l,doublePendulumParams:u,_resetCounter:f,colorTheme:p,showLyapunov:m,setLyapunovExponent:d,showPoincare:v,currentSystem:M}=D(),y=V[p],b=h.useMemo(()=>new Br(s,u),[s.theta1,s.theta2,s.omega1,s.omega2,u.mass1,u.mass2,u.length1,u.length2,u.gravity,u.damping]);h.useEffect(()=>{b.reset(s)},[f]),h.useEffect(()=>{b.updateParams(u)},[u,b]),h.useEffect(()=>(r||(window.__chaosLabSystem=b,window.__chaosLabSystemType="doublePendulum"),()=>{!r&&window.__chaosLabSystem===b&&(window.__chaosLabSystem=null)}),[b,r]);const x=h.useRef(0);q(()=>{if(!o)return;b.step(c*2),b.trimTrail(l);const A=b.points;if(n&&A.length>0){const z=A[A.length-1];n.current=new U(z.x,z.y,0)}!r&&M==="doublePendulum"&&(m||v)&&(x.current++,x.current%30===0&&d(b.lyapunovExponent))});const R=b.positions.length>0?b.getCurrentPositions():{p1:{x:0,y:0},p2:{x:0,y:0}},P=r?y.trailHue2:y.trailHue1,C=P+.2,T=new Q(y.textMuted),B=new Q().setHSL(P,.8,.6),g=new Q().setHSL(P+.1,.8,.7),w=[R.p1.x*t,R.p1.y*t,0],E=[R.p2.x*t,R.p2.y*t,0];return i.jsxs("group",{ref:a,position:e,children:[i.jsx(Ge,{points:b.points,hueStart:P,hueEnd:C,lineWidth:1.8,glowIntensity:.4,scale:t,flatZ:!0}),i.jsxs("line",{children:[i.jsx("bufferGeometry",{children:i.jsx("bufferAttribute",{attach:"attributes-position",args:[new Float32Array([0,0,0,...w]),3]})}),i.jsx("lineBasicMaterial",{color:T,linewidth:2,transparent:!0,opacity:.6})]}),i.jsxs("line",{children:[i.jsx("bufferGeometry",{children:i.jsx("bufferAttribute",{attach:"attributes-position",args:[new Float32Array([...w,...E]),3]})}),i.jsx("lineBasicMaterial",{color:T,linewidth:2,transparent:!0,opacity:.6})]}),i.jsxs("mesh",{position:[0,0,0],children:[i.jsx("sphereGeometry",{args:[.03,12,12]}),i.jsx("meshBasicMaterial",{color:"#ffffff",transparent:!0,opacity:.7})]}),i.jsxs("mesh",{position:[w[0],w[1],w[2]],children:[i.jsx("sphereGeometry",{args:[.06*Math.sqrt(u.mass1),16,16]}),i.jsx("meshBasicMaterial",{color:B})]}),i.jsx(Ve,{position:[E[0],E[1],E[2]],color:g,lightIntensity:r?.3:.6,size:.8*Math.sqrt(u.mass2),showPulse:!r})]})},oe=800,Be=80,zr=.02,Nr=()=>{const e=h.useRef(null),{colorTheme:t}=D(),s=V[t],{positions:r,baseSizes:n,phases:a,speeds:o}=h.useMemo(()=>{const f=new Float32Array(oe*3),p=new Float32Array(oe),m=new Float32Array(oe),d=new Float32Array(oe);for(let v=0;v<oe;v++)f[v*3]=(Math.random()-.5)*Be,f[v*3+1]=(Math.random()-.5)*Be,f[v*3+2]=(Math.random()-.5)*Be,p[v]=Math.random()*1.5+.3,m[v]=Math.random()*Math.PI*2,d[v]=.5+Math.random()*2.5;return{positions:f,baseSizes:p,phases:m,speeds:d}},[]),c=h.useMemo(()=>new Float32Array(oe),[]),l=h.useRef(null),u=h.useMemo(()=>new Q(s.starColor),[s.starColor]);return q(({clock:f})=>{if(!e.current)return;const p=f.getElapsedTime(),m=p*zr;e.current.rotation.y=m,e.current.rotation.x=m*.3;for(let d=0;d<oe;d++){const v=.6+.4*Math.sin(p*o[d]+a[d]);c[d]=n[d]*v}l.current&&(l.current.set(c),l.current.needsUpdate=!0)}),i.jsxs("points",{ref:e,children:[i.jsxs("bufferGeometry",{children:[i.jsx("bufferAttribute",{attach:"attributes-position",args:[r,3]}),i.jsx("bufferAttribute",{ref:l,attach:"attributes-size",args:[new Float32Array(oe),1]})]}),i.jsx("pointsMaterial",{color:u,size:.09,transparent:!0,opacity:.5,sizeAttenuation:!0,depthWrite:!1,blending:de})]})},jr={lorenz:.1,rossler:.5,doublePendulum:1},ot=20,Ir={lorenz:.8,rossler:4,doublePendulum:2},Dr={lorenz:.4,rossler:2,doublePendulum:.5},Ur=.025,Fr=.04,kr=()=>{const{cinematicCamera:e,currentSystem:t,isPlaying:s}=D(),{camera:r}=Le(),n=h.useRef(new U),a=h.useRef(new U),o=h.useRef(!1),c=h.useRef(!1),l=h.useRef(new U),u=h.useRef(new Zt),f=h.useRef(0);return q(()=>{if(e&&!c.current&&(l.current.copy(r.position),u.current.copy(r.rotation),f.current=0,c.current=!0),!e&&c.current){c.current=!1,o.current=!1;return}if(!e){o.current=!1;return}const p=window.__chaosLabSystem;if(!p?.points||p.points.length<ot+5)return;const m=p.points,d=jr[t]??.1,v=Ir[t]??1,M=Dr[t]??.5,y=m.length-1,b=Math.max(0,y-ot),x=m[y],R=m[b],P=new U().subVectors(x,R).normalize();P.lengthSq()<.001&&P.set(0,0,1);const C=t==="doublePendulum";let T,B;if(C){const A=new U(x.x*d,x.y*d,0);T=new U(A.x*.3,A.y*.3+.5,v),B=A}else{const A=new U(x.x*d,x.y*d,x.z*d),z=new U(0,1,0),_=new U().crossVectors(P,z);_.lengthSq()<.001&&_.set(1,0,0),_.normalize();const O=P.clone().multiplyScalar(-v*d).add(z.clone().multiplyScalar(M*d)).add(_.clone().multiplyScalar(.15*d));T=A.clone().add(O);const k=Math.min(y,m.length-1),L=m[k];B=new U(L.x*d,L.y*d,L.z*d)}o.current||(n.current.copy(r.position),a.current.copy(B),o.current=!0),f.current=Math.min(1,f.current+.008);const g=f.current,w=g*g*(3-2*g),E=s?Ur+(1-w)*.1:.005;n.current.lerp(T,E),a.current.lerp(B,Fr+(1-w)*.1),r.position.copy(n.current),r.lookAt(a.current)}),null},Lr=[{params:{sigma:10,rho:28,beta:2.667},duration:5,transitionTime:4},{params:{sigma:10,rho:15,beta:2.667},duration:3,transitionTime:5},{params:{sigma:10,rho:24.06,beta:2.667},duration:4,transitionTime:4},{params:{sigma:10,rho:28,beta:2.667},duration:3,transitionTime:3},{params:{sigma:14,rho:35,beta:3},duration:4,transitionTime:5},{params:{sigma:10,rho:99.96,beta:2.667},duration:5,transitionTime:6},{params:{sigma:10,rho:45,beta:2.667},duration:3,transitionTime:4},{params:{sigma:10,rho:28,beta:2.667},duration:3,transitionTime:4}],Or=[{params:{a:.2,b:.2,c:3.5},duration:4,transitionTime:5},{params:{a:.2,b:.2,c:4},duration:3,transitionTime:4},{params:{a:.2,b:.2,c:5},duration:3,transitionTime:4},{params:{a:.2,b:.2,c:5.7},duration:4,transitionTime:3},{params:{a:.2,b:.2,c:8.5},duration:4,transitionTime:5},{params:{a:.3,b:.3,c:12},duration:5,transitionTime:5},{params:{a:.2,b:.2,c:5.7},duration:3,transitionTime:6}],Hr=[{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},duration:5,transitionTime:4},{params:{mass1:1,mass2:3,length1:1,length2:1,gravity:9.81,damping:0},duration:4,transitionTime:5},{params:{mass1:2,mass2:1,length1:1.5,length2:.5,gravity:9.81,damping:0},duration:4,transitionTime:5},{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:15,damping:0},duration:4,transitionTime:4},{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:5,damping:.02},duration:5,transitionTime:5},{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},duration:3,transitionTime:4}],Gr={lorenz:Lr,rossler:Or,doublePendulum:Hr};function Vr(e,t,s){const r={},n=s*s*(3-2*s);for(const a of Object.keys(e)){const o=e[a]??0,c=t[a]??o;r[a]=o+(c-o)*n}return r}const Wr=()=>{const{chaosAutopilot:e,currentSystem:t,setLorenzParams:s,setRosslerParams:r,setDoublePendulumParams:n,setCurrentPreset:a}=D(),o=h.useRef(0),c=h.useRef(0),l=h.useRef("dwell"),u=h.useRef(0);return h.useEffect(()=>{o.current=0,c.current=0,l.current="dwell",u.current=0},[e,t]),q((f,p)=>{if(!e)return;const m=Gr[t];if(!m||m.length===0)return;const d=c.current%m.length,v=(d+1)%m.length,M=m[d],y=m[v];if(u.current+=p,l.current==="dwell")u.current>=M.duration&&(l.current="transition",u.current=0);else{const b=Math.min(1,u.current/M.transitionTime),x=Vr(M.params,y.params,b);switch(t){case"lorenz":s(x);break;case"rossler":r(x);break;case"doublePendulum":n(x);break}a(null),b>=1&&(c.current=v,l.current="dwell",u.current=0)}o.current+=p}),null},ee=150,$r=2,lt=50,Ae=.96,qr={lorenz:.1,rossler:.5,doublePendulum:1},Kr=()=>{const{isPlaying:e,currentSystem:t,colorTheme:s}=D(),r=V[s],n=h.useRef(null),a=h.useRef(0),o=h.useMemo(()=>({positions:new Float32Array(ee*3),velocities:new Float32Array(ee*3),lifetimes:new Float32Array(ee),colors:new Float32Array(ee*4),sizes:new Float32Array(ee)}),[]),c=h.useMemo(()=>new re(new Float32Array(ee*3),3),[]),l=h.useMemo(()=>new re(new Float32Array(ee*4),4),[]),u=h.useMemo(()=>new re(new Float32Array(ee),1),[]),f=h.useMemo(()=>{const p=new Q(r.accent);return{r:p.r,g:p.g,b:p.b}},[r.accent]);return h.useEffect(()=>{o.lifetimes.fill(0),a.current=0},[t,o]),q(()=>{if(!e||!n.current)return;const p=window.__chaosLabSystem;if(!p?.points||p.points.length<3)return;const m=p.points,d=qr[t]??.1,v=m[m.length-1],M=m[m.length-3],y=(v.x-M.x)*d,b=(v.y-M.y)*d,x=(v.z-M.z)*d,R=Math.sqrt(y*y+b*b+x*x),P=Math.max(.01,R*2);for(let g=0;g<$r;g++){const w=a.current,E=w*3;o.positions[E]=v.x*d,o.positions[E+1]=v.y*d,o.positions[E+2]=t==="doublePendulum"?0:v.z*d,o.velocities[E]=(Math.random()-.5)*P-y*.3,o.velocities[E+1]=(Math.random()-.5)*P-b*.3,o.velocities[E+2]=t==="doublePendulum"?(Math.random()-.5)*.02:(Math.random()-.5)*P-x*.3,o.lifetimes[w]=lt,o.sizes[w]=(.5+Math.random()*1)*d*.5,a.current=(a.current+1)%ee}const C=c.array,T=l.array,B=u.array;for(let g=0;g<ee;g++){const w=g*3,E=g*4;if(o.lifetimes[g]<=0){C[w]=0,C[w+1]=0,C[w+2]=-1e3,T[E+3]=0,B[g]=0;continue}o.lifetimes[g]--,o.positions[w]+=o.velocities[w]*.016,o.positions[w+1]+=o.velocities[w+1]*.016,o.positions[w+2]+=o.velocities[w+2]*.016,o.velocities[w]*=Ae,o.velocities[w+1]*=Ae,o.velocities[w+2]*=Ae;const A=o.lifetimes[g]/lt,z=A*A,_=.8+Math.sin(o.lifetimes[g]*.5+g*.7)*.2;C[w]=o.positions[w],C[w+1]=o.positions[w+1],C[w+2]=o.positions[w+2],T[E]=f.r*_,T[E+1]=f.g*_,T[E+2]=f.b*_,T[E+3]=z*_,B[g]=o.sizes[g]*(.3+A*.7)}c.needsUpdate=!0,l.needsUpdate=!0,u.needsUpdate=!0}),i.jsxs("points",{ref:n,children:[i.jsxs("bufferGeometry",{children:[i.jsx("primitive",{object:c,attach:"attributes-position"}),i.jsx("primitive",{object:l,attach:"attributes-color"}),i.jsx("primitive",{object:u,attach:"attributes-size"})]}),i.jsx("pointsMaterial",{vertexColors:!0,size:.04,transparent:!0,opacity:.9,depthWrite:!1,blending:de,sizeAttenuation:!0})]})},Xr={lorenz:.1,rossler:.5,doublePendulum:1},Zr=()=>{const{isPlaying:e,currentSystem:t,colorTheme:s,bloomEnabled:r}=D(),n=V[s],a=h.useRef(null),o=h.useRef(null),c=h.useRef(new U),l=h.useRef(0),u=h.useRef(0);return q(()=>{if(!e||!a.current||!o.current)return;const f=window.__chaosLabSystem;if(!f?.points||f.points.length<3)return;const p=f.points,m=Xr[t]??.1,d=p[p.length-1],v=d.x*m,M=d.y*m,y=t==="doublePendulum"?.1:d.z*m,b=v-c.current.x,x=M-c.current.y,R=y-c.current.z,P=Math.sqrt(b*b+x*x+R*R);c.current.set(v,M,y),l.current+=(P-l.current)*.08;const C=r?.8:.3,T=Math.min(l.current*8,2),B=C+T;u.current+=(B-u.current)*.06,a.current.position.set(v,M,y),a.current.intensity=u.current,a.current.distance=3+l.current*10,o.current.position.set(v,M,y);const g=.03+l.current*.15;o.current.scale.setScalar(g);const w=new Q(n.accent),E=new Q(1,1,1),A=Math.min(l.current*3,.6),z=w.lerp(E,A);a.current.color.copy(z),o.current.material.color.copy(z)}),i.jsxs(i.Fragment,{children:[i.jsx("pointLight",{ref:a,intensity:.5,distance:5,decay:2,color:n.accent}),i.jsxs("mesh",{ref:o,children:[i.jsx("sphereGeometry",{args:[1,16,16]}),i.jsx("meshBasicMaterial",{color:n.accent,transparent:!0,opacity:.7,depthWrite:!1,blending:de})]})]})},ct={lorenz:{position:[10,10,10],fov:60},rossler:{position:[8,8,8],fov:60},doublePendulum:{position:[0,0,5],fov:50}},Yr=()=>{const{autoRotate:e,currentSystem:t,cinematicCamera:s}=D();return s?null:i.jsx(Jt,{enablePan:!0,enableZoom:!0,enableRotate:!0,autoRotate:e&&t!=="doublePendulum",autoRotateSpeed:2,maxPolarAngle:Math.PI,minDistance:2,maxDistance:20})},Qr=({posA:e,posB:t})=>{const{setDivergence:s,sideBySideMode:r}=D(),n=h.useRef(0);return q(()=>{if(!r||(n.current++,n.current%6!==0))return;const a=e.current,o=t.current;a&&o&&s(a.distanceTo(o))}),null},ze=({position:e=[0,0,0],initialCondition:t,colorHue:s=.6,isSecondary:r=!1,lastPosRef:n})=>{const{currentSystem:a}=D();switch(a){case"lorenz":return i.jsx(Pr,{position:e,initialCondition:t||[1,1,1],colorHue:s,isSecondary:r,lastPosRef:n});case"rossler":return i.jsx(_r,{position:e,initialCondition:t||[1,1,1],colorHue:s,isSecondary:r,lastPosRef:n});case"doublePendulum":return i.jsx(Ar,{position:e,initialCondition:t||{theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0},colorHue:s,isSecondary:r,lastPosRef:n});default:return null}},Jr=()=>{const{bloomEnabled:e,bloomIntensity:t,isPlaying:s}=D(),r=h.useRef(t);return q(()=>{if(!e||!s)return;const n=window.__chaosLabSystem;if(!n?.points||n.points.length<5)return;const a=n.points,o=a[a.length-1],c=a[a.length-4],l=o.x-c.x,u=o.y-c.y,f=o.z-c.z,p=Math.sqrt(l*l+u*u+f*f),m=1+Math.min(p*.02,.3);r.current+=(t*m-r.current)*.05}),e?i.jsx(Tr,{children:i.jsx(Rr,{intensity:r.current,luminanceThreshold:.1,luminanceSmoothing:.9,mipmapBlur:!0})}):null},ei=()=>{const{sideBySideMode:e,currentSystem:t,initialOffset:s,colorTheme:r}=D(),n=V[r],a=h.useRef(null),o=h.useRef(null);return i.jsxs(i.Fragment,{children:[i.jsx("ambientLight",{intensity:.2}),i.jsx("directionalLight",{position:[10,10,5],intensity:.3}),i.jsx(Nr,{}),t==="doublePendulum"&&i.jsx(Qt,{args:[10,10],position:[0,-3,0],cellColor:"#222233",sectionColor:"#333355",fadeDistance:25,fadeStrength:1}),e?i.jsxs(i.Fragment,{children:[i.jsx(ze,{position:[0,0,0],initialCondition:t==="doublePendulum"?{theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0}:[1,1,1],colorHue:n.trailHue1,isSecondary:!1,lastPosRef:a}),i.jsx(ze,{position:[0,0,0],initialCondition:t==="doublePendulum"?{theta1:Math.PI/2+s,theta2:Math.PI/2,omega1:0,omega2:0}:[1+s,1,1],colorHue:n.trailHue2,isSecondary:!0,lastPosRef:o}),i.jsx(Qr,{posA:a,posB:o})]}):i.jsx(ze,{}),i.jsx(Yr,{}),i.jsx(kr,{}),i.jsx(Wr,{}),i.jsx(Kr,{}),i.jsx(Zr,{}),i.jsx(Jr,{})]})};class ti extends h.Component{state={hasError:!1,error:null};static getDerivedStateFromError(t){return{hasError:!0,error:t}}handleRetry=()=>{this.setState({hasError:!1,error:null})};render(){return this.state.hasError?i.jsxs("div",{style:{width:"100vw",height:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:"#000010",color:"#ccc",fontFamily:"system-ui, sans-serif",textAlign:"center",padding:"2rem"},children:[i.jsx("h2",{style:{color:"#ff6666",marginBottom:"1rem"},children:" Rendering Error"}),i.jsx("p",{style:{maxWidth:"400px",lineHeight:1.6,marginBottom:"1rem"},children:"The 3D visualization encountered an error. This can happen if WebGL is not available or if GPU resources were exhausted."}),i.jsx("code",{style:{background:"rgba(255,255,255,0.05)",padding:"8px 16px",borderRadius:"6px",fontSize:"12px",color:"#ff9999",marginBottom:"1.5rem",maxWidth:"80vw",overflow:"auto"},children:this.state.error?.message||"Unknown error"}),i.jsx("button",{onClick:this.handleRetry,style:{padding:"12px 24px",background:"#88ccff",color:"#000",border:"none",borderRadius:"8px",fontSize:"14px",fontWeight:600,cursor:"pointer"},children:" Retry"})]}):this.props.children}}const si=()=>{const{currentSystem:e,colorTheme:t}=D(),s=V[t],r=ct[e]??ct.lorenz;return i.jsx(ti,{children:i.jsx("div",{style:{width:"100vw",height:"100vh",background:s.bg},role:"img","aria-label":`3D visualization of ${e==="lorenz"?"Lorenz attractor":e==="rossler"?"Rssler attractor":"double pendulum"} chaos system`,children:i.jsxs(Yt,{camera:{position:r.position,fov:r.fov},gl:{antialias:!0,alpha:!0,powerPreference:"high-performance",preserveDrawingBuffer:!0},children:[i.jsx("color",{attach:"background",args:[s.bg]}),i.jsx("fog",{attach:"fog",args:[s.bg,30,60]}),i.jsx(h.Suspense,{fallback:null,children:i.jsx(ei,{})})]})})})},ri={classic:" Classic",neon:" Neon",blueprint:" Blueprint",terminal:" Terminal"},ii={lorenz:" Lorenz",rossler:" Rssler",doublePendulum:" Pendulum"},ni=()=>{const[e,t]=h.useState(!1),[s,r]=h.useState(!1);h.useEffect(()=>{const S=()=>r(window.innerWidth<=768);return S(),window.addEventListener("resize",S),()=>window.removeEventListener("resize",S)},[]);const{currentSystem:n,setCurrentSystem:a,isPlaying:o,setIsPlaying:c,speed:l,setSpeed:u,trailLength:f,setTrailLength:p,sideBySideMode:m,setSideBySideMode:d,initialOffset:v,setInitialOffset:M,autoRotate:y,setAutoRotate:b,currentPreset:x,setCurrentPreset:R,colorTheme:P,setColorTheme:C,lorenzParams:T,setLorenzParams:B,rosslerParams:g,setRosslerParams:w,doublePendulumParams:E,setDoublePendulumParams:A,resetSimulation:z,showLyapunov:_,setShowLyapunov:O,showBifurcation:k,setShowBifurcation:L,showPoincare:K,setShowPoincare:ge,showParameterSpace:X,setShowParameterSpace:J,cinematicCamera:$,setCinematicCamera:fe,chaosAutopilot:Y,setChaosAutopilot:Re,setStoryMode:Et,bloomEnabled:We,setBloomEnabled:Rt,bloomIntensity:Me,setBloomIntensity:Mt,audioEnabled:xe,setAudioEnabled:Pt,audioVolume:Pe,setAudioVolume:Ct}=D(),ie=V[P],_t=S=>{const ye=at[n].find(zt=>zt.name===S);if(ye){switch(n){case"lorenz":B(ye.params);break;case"rossler":w(ye.params);break;case"doublePendulum":A(ye.params);break}R(S)}},Bt=S=>{a(S),R(null)},$e=S=>S>=.01?S.toFixed(3):S.toExponential(1),At=()=>{switch(n){case"lorenz":return i.jsxs("div",{className:"parameter-group",role:"group","aria-label":"Lorenz system parameters",children:[i.jsx("h4",{children:"Lorenz Parameters"}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"sigma-slider",children:[" (sigma): ",T.sigma.toFixed(2)]}),i.jsx("input",{id:"sigma-slider",type:"range",min:"0.1",max:"30",step:"0.1",value:T.sigma,"aria-valuemin":.1,"aria-valuemax":30,"aria-valuenow":T.sigma,"aria-label":`Sigma: ${T.sigma.toFixed(2)}`,onChange:S=>B({sigma:parseFloat(S.target.value)})})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"rho-slider",children:[" (rho): ",T.rho.toFixed(2)]}),i.jsx("input",{id:"rho-slider",type:"range",min:"0.1",max:"50",step:"0.1",value:T.rho,"aria-valuemin":.1,"aria-valuemax":50,"aria-valuenow":T.rho,"aria-label":`Rho: ${T.rho.toFixed(2)}`,onChange:S=>B({rho:parseFloat(S.target.value)})})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"beta-slider",children:[" (beta): ",T.beta.toFixed(3)]}),i.jsx("input",{id:"beta-slider",type:"range",min:"0.1",max:"10",step:"0.01",value:T.beta,"aria-valuemin":.1,"aria-valuemax":10,"aria-valuenow":T.beta,"aria-label":`Beta: ${T.beta.toFixed(3)}`,onChange:S=>B({beta:parseFloat(S.target.value)})})]})]});case"rossler":return i.jsxs("div",{className:"parameter-group",role:"group","aria-label":"Rssler system parameters",children:[i.jsx("h4",{children:"Rssler Parameters"}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"a-slider",children:["a: ",g.a.toFixed(3)]}),i.jsx("input",{id:"a-slider",type:"range",min:"0.01",max:"1.0",step:"0.01",value:g.a,"aria-label":`Parameter a: ${g.a.toFixed(3)}`,onChange:S=>w({a:parseFloat(S.target.value)})})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"b-slider",children:["b: ",g.b.toFixed(3)]}),i.jsx("input",{id:"b-slider",type:"range",min:"0.01",max:"1.0",step:"0.01",value:g.b,"aria-label":`Parameter b: ${g.b.toFixed(3)}`,onChange:S=>w({b:parseFloat(S.target.value)})})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"c-slider",children:["c: ",g.c.toFixed(2)]}),i.jsx("input",{id:"c-slider",type:"range",min:"1.0",max:"20.0",step:"0.1",value:g.c,"aria-label":`Parameter c: ${g.c.toFixed(2)}`,onChange:S=>w({c:parseFloat(S.target.value)})})]})]});case"doublePendulum":return i.jsxs("div",{className:"parameter-group",role:"group","aria-label":"Double pendulum parameters",children:[i.jsx("h4",{children:"Pendulum Parameters"}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"mass1-slider",children:["Mass 1: ",E.mass1.toFixed(2)]}),i.jsx("input",{id:"mass1-slider",type:"range",min:"0.1",max:"5.0",step:"0.1",value:E.mass1,"aria-label":`Mass 1: ${E.mass1.toFixed(2)}`,onChange:S=>A({mass1:parseFloat(S.target.value)})})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"mass2-slider",children:["Mass 2: ",E.mass2.toFixed(2)]}),i.jsx("input",{id:"mass2-slider",type:"range",min:"0.1",max:"5.0",step:"0.1",value:E.mass2,"aria-label":`Mass 2: ${E.mass2.toFixed(2)}`,onChange:S=>A({mass2:parseFloat(S.target.value)})})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"len1-slider",children:["Length 1: ",E.length1.toFixed(2)]}),i.jsx("input",{id:"len1-slider",type:"range",min:"0.2",max:"2.0",step:"0.1",value:E.length1,"aria-label":`Length 1: ${E.length1.toFixed(2)}`,onChange:S=>A({length1:parseFloat(S.target.value)})})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"len2-slider",children:["Length 2: ",E.length2.toFixed(2)]}),i.jsx("input",{id:"len2-slider",type:"range",min:"0.2",max:"2.0",step:"0.1",value:E.length2,"aria-label":`Length 2: ${E.length2.toFixed(2)}`,onChange:S=>A({length2:parseFloat(S.target.value)})})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"gravity-slider",children:["Gravity: ",E.gravity.toFixed(2)]}),i.jsx("input",{id:"gravity-slider",type:"range",min:"1.0",max:"20.0",step:"0.1",value:E.gravity,"aria-label":`Gravity: ${E.gravity.toFixed(2)}`,onChange:S=>A({gravity:parseFloat(S.target.value)})})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"damping-slider",children:["Damping: ",E.damping.toFixed(3)]}),i.jsx("input",{id:"damping-slider",type:"range",min:"0.0",max:"0.2",step:"0.005",value:E.damping,"aria-label":`Damping: ${E.damping.toFixed(3)}`,onChange:S=>A({damping:parseFloat(S.target.value)})})]})]});default:return null}};return i.jsxs("aside",{className:`controls ${e?"collapsed":""} ${s?"mobile":""}`,role:"region","aria-label":"Simulation controls",style:{"--panel-bg":ie.panelBg,"--panel-border":ie.panelBorder,"--text-color":ie.text,"--text-muted":ie.textMuted,"--accent":ie.accent,"--accent2":ie.accent2,"--heading":ie.heading,"--param-color":ie.paramColor},children:[i.jsx("button",{className:"controls-toggle",onClick:()=>t(!e),"aria-label":e?"Show controls":"Hide controls","aria-expanded":!e,children:e?"":""}),!e&&i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"control-section",children:[i.jsx("h3",{id:"system-heading",children:"Chaos System"}),i.jsx("div",{className:"system-tabs",role:"tablist","aria-labelledby":"system-heading",children:["lorenz","rossler","doublePendulum"].map(S=>i.jsx("button",{role:"tab","aria-selected":n===S,"aria-label":`Select ${S==="doublePendulum"?"Double Pendulum":S} system`,className:`system-tab ${n===S?"active":""}`,onClick:()=>Bt(S),children:ii[S]},S))})]}),i.jsxs("div",{className:"control-section",children:[i.jsx("h3",{children:"Simulation"}),i.jsxs("div",{className:"button-group",children:[i.jsx("button",{onClick:()=>c(!o),className:`play-button ${o?"playing":"paused"}`,"aria-label":o?"Pause simulation":"Play simulation",children:o?" Pause":" Play"}),i.jsx("button",{onClick:z,className:"reset-button","aria-label":"Reset simulation",children:" Reset"})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"speed-slider",children:["Speed: ",l.toFixed(1),"x"]}),i.jsx("input",{id:"speed-slider",type:"range",min:"0.1",max:"5.0",step:"0.1",value:l,"aria-label":`Simulation speed: ${l.toFixed(1)}x`,onChange:S=>u(parseFloat(S.target.value))})]}),i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"trail-slider",children:["Trail: ",f,f>3e3&&i.jsx("span",{className:"warn",children:"  High"})]}),i.jsx("input",{id:"trail-slider",type:"range",min:"100",max:"5000",step:"100",value:f,"aria-label":`Trail length: ${f} points`,onChange:S=>p(parseInt(S.target.value))})]})]}),i.jsxs("div",{className:"control-section butterfly-section",children:[i.jsx("h3",{children:" Butterfly Effect"}),i.jsx("div",{className:"checkbox-group",children:i.jsxs("label",{children:[i.jsx("input",{type:"checkbox",checked:m,"aria-label":"Enable butterfly mode: show two systems with tiny initial difference",onChange:S=>{d(S.target.checked),S.target.checked&&z()}}),"Enable Butterfly Mode"]})}),m&&i.jsxs("div",{className:"slider-group offset-slider",children:[i.jsxs("label",{htmlFor:"offset-slider",children:["Initial Offset: ",i.jsx("span",{className:"offset-value",children:$e(v)})]}),i.jsx("input",{id:"offset-slider",type:"range",min:"-6",max:"-0.5",step:"0.1",value:Math.log10(v),"aria-label":`Initial offset between systems: ${$e(v)}`,onChange:S=>{M(Math.pow(10,parseFloat(S.target.value))),z()}}),i.jsxs("div",{className:"offset-labels","aria-hidden":"true",children:[i.jsx("span",{children:"Tiny"}),i.jsx("span",{children:"Large"})]})]})]}),i.jsxs("div",{className:"control-section",children:[i.jsx("h3",{children:"View"}),n!=="doublePendulum"&&i.jsx("div",{className:"checkbox-group",children:i.jsxs("label",{children:[i.jsx("input",{type:"checkbox",checked:y,"aria-label":"Auto-rotate camera around the attractor",onChange:S=>b(S.target.checked)}),"Auto Rotate"]})}),i.jsx("div",{className:"checkbox-group",children:i.jsxs("label",{children:[i.jsx("input",{type:"checkbox",checked:We,"aria-label":"Toggle bloom glow post-processing effect",onChange:S=>Rt(S.target.checked)})," Bloom Glow"]})}),We&&i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"bloom-intensity",children:["Bloom: ",Me.toFixed(1)]}),i.jsx("input",{id:"bloom-intensity",type:"range",min:"0.2",max:"4.0",step:"0.1",value:Me,"aria-label":`Bloom intensity: ${Me.toFixed(1)}`,onChange:S=>Mt(parseFloat(S.target.value))})]})]}),i.jsxs("div",{className:"control-section",children:[i.jsx("h3",{children:" Experience"}),i.jsxs("div",{className:"experience-buttons",children:[i.jsx("button",{className:`experience-btn cinematic ${$?"active":""}`,onClick:()=>fe(!$),"aria-pressed":$,"aria-label":"Toggle cinematic chase camera that follows the trail",children:" Chase Cam"}),i.jsx("button",{className:`experience-btn autopilot ${Y?"active":""}`,onClick:()=>Re(!Y),"aria-pressed":Y,"aria-label":"Toggle chaos autopilot that morphs parameters automatically",children:" Autopilot"}),i.jsx("button",{className:`experience-btn audio ${xe?"active":""}`,onClick:()=>Pt(!xe),"aria-pressed":xe,"aria-label":"Toggle chaos sonification  hear the attractor as sound",children:" Sonify"}),i.jsx("button",{className:"experience-btn story",onClick:()=>{Et(!0),b(!0)},"aria-label":"Launch guided story mode tour",children:" Story Mode"})]}),xe&&i.jsxs("div",{className:"audio-controls",children:[i.jsxs("div",{className:"slider-group",children:[i.jsxs("label",{htmlFor:"audio-volume",children:["Volume: ",Math.round(Pe*100),"%"]}),i.jsx("input",{id:"audio-volume",type:"range",min:"0",max:"1",step:"0.05",value:Pe,"aria-label":`Audio volume: ${Math.round(Pe*100)}%`,onChange:S=>Ct(parseFloat(S.target.value))})]}),i.jsx("div",{className:"autopilot-hint",children:" Listening to chaos  pitch follows position, volume follows velocity"})]}),Y&&i.jsx("div",{className:"autopilot-hint",children:"Parameters are morphing through interesting regions..."}),$&&i.jsx("div",{className:"autopilot-hint",children:"Camera is following the trail head. Orbit controls disabled."})]}),i.jsxs("div",{className:"control-section",children:[i.jsx("h3",{id:"theme-heading",children:"Theme"}),i.jsx("div",{className:"theme-grid",role:"radiogroup","aria-labelledby":"theme-heading",children:Object.keys(V).map(S=>i.jsx("button",{role:"radio","aria-checked":P===S,"aria-label":`${S} theme`,className:`theme-btn ${P===S?"active":""}`,onClick:()=>C(S),style:{"--tbg":V[S].bg,"--taccent":V[S].accent},children:ri[S]},S))})]}),i.jsxs("div",{className:"control-section",children:[i.jsx("h3",{children:"Presets"}),i.jsx("div",{className:"preset-chips",role:"group","aria-label":"Parameter presets",children:at[n].map(S=>i.jsx("button",{className:`preset-chip ${x===S.name?"active":""}`,onClick:()=>_t(S.name),"aria-label":`${S.name}: ${S.description}`,"aria-pressed":x===S.name,children:S.name},S.name))})]}),At(),n!=="doublePendulum"&&i.jsxs("div",{className:"control-section",children:[i.jsx("h3",{children:" Analysis"}),i.jsxs("div",{className:"analysis-buttons",children:[i.jsx("button",{className:`analysis-btn ${_?"active":""}`,onClick:()=>O(!_),"aria-pressed":_,"aria-label":"Toggle Lyapunov exponent indicator",children:" Lyapunov"}),i.jsx("button",{className:`analysis-btn ${k?"active":""}`,onClick:()=>L(!k),"aria-pressed":k,"aria-label":"Toggle bifurcation diagram",children:" Bifurcation"}),i.jsx("button",{className:`analysis-btn ${K?"active":""}`,onClick:()=>ge(!K),"aria-pressed":K,"aria-label":"Toggle Poincar section",children:" Poincar"}),i.jsx("button",{className:`analysis-btn ${X?"active":""}`,onClick:()=>J(!X),"aria-pressed":X,"aria-label":"Toggle parameter space explorer",children:" Param Space"})]})]})]})]})},ai={lorenz:{title:"Lorenz Attractor",description:"The Lorenz attractor is a set of chaotic solutions of the Lorenz system, discovered by Edward Lorenz in 1963. It arises from a simplified model of atmospheric convection.",equations:["dx/dt = (y - x)","dy/dt = x( - z) - y","dz/dt = xy - z"],whatMakesChaotic:'The system is chaotic because small changes in initial conditions lead to drastically different outcomes over time. This is the famous "butterfly effect"  a butterfly flapping its wings in Brazil could theoretically cause a tornado in Texas.',parameters:{" (sigma)":"Prandtl number  relates viscosity to thermal conductivity"," (rho)":"Rayleigh number  measures temperature difference"," (beta)":"Geometric factor related to the size of convection cells"}},rossler:{title:"Rssler Attractor",description:"The Rssler attractor is another chaotic system, developed by Otto Rssler in 1976. It was designed to be simpler than the Lorenz system while still exhibiting chaotic behavior.",equations:["dx/dt = -y - z","dy/dt = x + ay","dz/dt = b + z(x - c)"],whatMakesChaotic:"The Rssler system shows how even simple nonlinear equations can produce chaos. The attractor has a characteristic spiral structure that folds back on itself, creating sensitive dependence on initial conditions.",parameters:{a:"Controls the rate of expansion in the y direction",b:"Constant term that affects the z component",c:"Controls the folding and stretching of the attractor"}},doublePendulum:{title:"Double Pendulum",description:"A double pendulum consists of two pendulums attached end to end. Despite being a deterministic system governed by well-known physical laws, it exhibits chaotic motion.",equations:["Complex coupled differential equations","involving angles ,  and their","angular velocities , "],whatMakesChaotic:"The chaos arises from the nonlinear coupling between the two pendulums. Small changes in the initial angles or velocities can lead to completely different trajectories. This demonstrates that chaos can emerge from simple, everyday systems.",parameters:{"Mass 1, Mass 2":"Masses of the first and second pendulum bobs","Length 1, Length 2":"Lengths of the first and second pendulum arms",Gravity:"Gravitational acceleration",Damping:"Energy loss due to friction (0 = no damping)"}}},oi=()=>{const{currentSystem:e,showInfoPanel:t,setShowInfoPanel:s}=D();if(!t)return i.jsx("button",{className:"info-toggle collapsed",onClick:()=>s(!0),"aria-label":"Show system information panel",children:""});const r=ai[e];return i.jsxs("aside",{className:"info-panel",role:"complementary","aria-label":"System information",children:[i.jsxs("div",{className:"info-header",children:[i.jsx("h2",{children:r.title}),i.jsx("button",{className:"info-close",onClick:()=>s(!1),"aria-label":"Close information panel",children:""})]}),i.jsxs("div",{className:"info-content",children:[i.jsxs("section",{"aria-labelledby":"info-overview",children:[i.jsx("h3",{id:"info-overview",children:"Overview"}),i.jsx("p",{children:r.description})]}),i.jsxs("section",{"aria-labelledby":"info-equations",children:[i.jsx("h3",{id:"info-equations",children:"Equations"}),i.jsx("div",{className:"equations",role:"math","aria-label":"System equations",children:r.equations.map((n,a)=>i.jsx("div",{className:"equation",children:n},a))})]}),i.jsxs("section",{"aria-labelledby":"info-chaos",children:[i.jsx("h3",{id:"info-chaos",children:"What Makes It Chaotic?"}),i.jsx("p",{children:r.whatMakesChaotic})]}),i.jsxs("section",{"aria-labelledby":"info-params",children:[i.jsx("h3",{id:"info-params",children:"Parameters"}),i.jsx("dl",{className:"parameters",children:Object.entries(r.parameters).map(([n,a])=>i.jsxs("div",{className:"parameter",children:[i.jsx("dt",{children:i.jsx("strong",{children:n})}),i.jsx("dd",{children:a})]},n))})]}),i.jsxs("section",{"aria-labelledby":"info-tips",children:[i.jsx("h3",{id:"info-tips",children:"Tips"}),i.jsxs("ul",{children:[i.jsx("li",{children:"Try the side-by-side mode to see how small changes create big differences"}),i.jsx("li",{children:"Experiment with different presets to explore various behaviors"}),i.jsx("li",{children:"Adjust the trail length to see more or less of the trajectory"}),i.jsx("li",{children:"Use the speed control to slow down and observe the motion closely"})]})]})]})]})},ce=[{title:"Welcome to Chaos Lab! ",description:"Explore the beautiful world of chaos theory through interactive visualizations. Watch as simple equations create complex, unpredictable patterns."},{title:"Try Side-by-Side Mode",description:"Enable 'Butterfly Mode' to see the butterfly effect in action. Two systems with tiny differences will evolve completely differently!",highlight:"side-by-side"},{title:"Experiment with Parameters",description:"Adjust the sliders to see how small changes in parameters can dramatically alter the behavior. Try the preset configurations for interesting starting points.",highlight:"parameters"},{title:"Explore Different Systems",description:"Switch between Lorenz Attractor, Rssler Attractor, and Double Pendulum to see different types of chaotic behavior.",highlight:"systems"},{title:"Learn More",description:"Click the info button () to learn about the mathematics and physics behind each system. Ready to explore chaos?",highlight:"info"}],li=()=>{const[e,t]=h.useState(!1),[s,r]=h.useState(0),{setSideBySideMode:n,setShowInfoPanel:a}=D(),o=h.useRef(null);h.useEffect(()=>{localStorage.getItem("chaosLabTutorial")||t(!0)},[]),h.useEffect(()=>{e&&o.current&&o.current.focus()},[e,s]);const c=h.useCallback(()=>{localStorage.setItem("chaosLabTutorial","completed"),t(!1)},[]),l=h.useCallback(()=>{s<ce.length-1?r(s+1):c()},[s,c]),u=h.useCallback(()=>{switch(ce[s].highlight){case"side-by-side":n(!0);break;case"info":a(!0);break}l()},[s,l,n,a]),f=h.useCallback(d=>{d.key==="Escape"?c():(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),l())},[c,l]);if(!e)return null;const p=ce[s],m=s===ce.length-1;return i.jsx("div",{className:"quick-start-overlay",role:"dialog","aria-modal":"true","aria-label":"Quick start tutorial",onKeyDown:f,children:i.jsxs("div",{className:"quick-start-modal",ref:o,tabIndex:-1,children:[i.jsxs("div",{className:"quick-start-header",children:[i.jsx("h2",{id:"qs-title",children:p.title}),i.jsx("button",{className:"quick-start-close",onClick:c,"aria-label":"Close tutorial",children:""})]}),i.jsxs("div",{className:"quick-start-content",children:[i.jsx("p",{id:"qs-desc",children:p.description}),i.jsx("div",{className:"quick-start-progress",role:"progressbar","aria-valuenow":s+1,"aria-valuemin":1,"aria-valuemax":ce.length,"aria-label":`Step ${s+1} of ${ce.length}`,children:ce.map((d,v)=>i.jsx("div",{className:`progress-dot ${v<=s?"active":""}`,"aria-hidden":"true"},v))})]}),i.jsxs("div",{className:"quick-start-actions",children:[i.jsx("button",{className:"quick-start-skip",onClick:c,children:"Skip Tutorial"}),i.jsx("button",{className:"quick-start-next",onClick:p.highlight?u:l,"aria-describedby":"qs-desc",children:m?"Let's Explore!":"Next"})]})]})})},ci=()=>{const{sideBySideMode:e,divergence:t,colorTheme:s}=D(),r=V[s];if(!e)return null;const n=Math.log10(Math.max(t,1e-4)),a=Math.min(1,Math.max(0,(n+4)/6)),o=Math.round(a*100),c=(1-a)*120,l=t<.001?t.toExponential(2):t.toFixed(3);return i.jsxs("div",{role:"meter","aria-label":"Divergence between the two systems","aria-valuenow":a,"aria-valuemin":0,"aria-valuemax":1,"aria-valuetext":`Divergence: ${l}`,style:{position:"absolute",bottom:80,left:"50%",transform:"translateX(-50%)",zIndex:200,pointerEvents:"none",textAlign:"center",fontFamily:"'Segoe UI', sans-serif"},children:[i.jsx("div",{style:{color:r.textMuted,fontSize:"11px",letterSpacing:"2px",textTransform:"uppercase",marginBottom:6},children:"Divergence"}),i.jsx("div",{style:{width:200,height:6,background:`rgba(${r.bgRgb}, 0.7)`,borderRadius:3,overflow:"hidden",border:`1px solid ${r.panelBorder}`,backdropFilter:"blur(4px)"},children:i.jsx("div",{style:{width:`${o}%`,height:"100%",background:`hsl(${c}, 90%, 55%)`,borderRadius:3,transition:"width 0.1s ease, background 0.3s ease",boxShadow:`0 0 8px hsla(${c}, 90%, 55%, 0.6)`}})}),i.jsx("div",{style:{color:r.text,fontSize:"13px",marginTop:4,fontVariantNumeric:"tabular-nums",fontWeight:600,textShadow:`0 0 10px hsla(${c}, 90%, 55%, 0.5)`},children:l})]})},ui=()=>{const{showLyapunov:e,lyapunovExponent:t,colorTheme:s}=D(),r=V[s],n=h.useRef("");if(!e)return null;const o=(Math.max(-2,Math.min(3,t))+2)/5,c=(1-o)*120,l=Math.min(100,Math.max(5,o*100)),u=t>.1?"Chaotic":t>-.05?"Edge of Chaos":"Stable",f=t>.1?"":t>-.05?"":"",p=n.current!==u;return p&&(n.current=u),i.jsxs("div",{className:"lyapunov-indicator",role:"region","aria-label":`Lyapunov exponent indicator: system is ${u}`,style:{"--panel-bg":r.panelBg,"--panel-border":r.panelBorder,"--text":r.text,"--text-muted":r.textMuted,"--bar-hue":c},children:[i.jsxs("div",{className:"lyapunov-header",children:[i.jsx("span",{className:"lyapunov-label",children:" (Lyapunov)"}),i.jsxs("span",{className:"lyapunov-status","aria-hidden":"true",children:[f," ",u]})]}),i.jsxs("div",{className:"lyapunov-value",style:{color:`hsl(${c}, 90%, 60%)`},children:[" = ",t.toFixed(3)]}),i.jsxs("div",{className:"lyapunov-bar-track",role:"meter","aria-valuenow":t,"aria-valuemin":-2,"aria-valuemax":3,"aria-label":"Lyapunov exponent",children:[i.jsx("div",{className:"lyapunov-bar-fill",style:{width:`${l}%`,background:`hsl(${c}, 85%, 50%)`,boxShadow:`0 0 10px hsla(${c}, 85%, 50%, 0.6)`}}),i.jsx("div",{className:"lyapunov-bar-zero","aria-hidden":"true"})]}),i.jsx("div",{className:"lyapunov-hint",children:"Measures how fast nearby paths diverge. Positive = chaos."}),p&&i.jsxs("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:["System is now ",u,", Lyapunov exponent: ",t.toFixed(2)]})]})},hi=[{key:"Space",action:"Play / Pause simulation"},{key:"R",action:"Reset simulation"},{key:"1",action:"Switch to Lorenz attractor"},{key:"2",action:"Switch to Rssler attractor"},{key:"3",action:"Switch to Double Pendulum"},{key:"S",action:"Toggle side-by-side (Butterfly) mode"},{key:"C",action:"Toggle cinematic chase camera"},{key:"A",action:"Toggle chaos autopilot"},{key:"T",action:"Cycle through color themes"},{key:"P",action:"Screenshot current view"},{key:"L",action:"Copy share link to clipboard"},{key:"H / ?",action:"Toggle this help overlay"},{key:"Esc",action:"Close open dialogs"}],di=({isVisible:e,onClose:t})=>{const s=h.useRef(null);return h.useEffect(()=>{e&&s.current?.focus()},[e]),h.useEffect(()=>{if(!e)return;const r=n=>{(n.key==="Escape"||n.key==="h"||n.key==="H"||n.key==="?")&&(n.preventDefault(),t())};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[e,t]),e?i.jsx("div",{className:"help-overlay",role:"dialog","aria-modal":"true","aria-label":"Keyboard shortcuts",onClick:t,children:i.jsxs("div",{className:"help-modal",ref:s,tabIndex:-1,onClick:r=>r.stopPropagation(),children:[i.jsxs("div",{className:"help-header",children:[i.jsx("h2",{children:" Keyboard Shortcuts"}),i.jsx("button",{className:"help-close",onClick:t,"aria-label":"Close help",children:""})]}),i.jsx("div",{className:"help-grid",children:hi.map(({key:r,action:n})=>i.jsxs("div",{className:"help-row",children:[i.jsx("kbd",{className:"help-key",children:r}),i.jsx("span",{className:"help-action",children:n})]},r))}),i.jsxs("div",{className:"help-footer",children:[i.jsxs("p",{children:[i.jsx("strong",{children:"Mouse:"})," Drag to rotate  Scroll to zoom  Right-drag to pan"]}),i.jsxs("p",{children:[i.jsx("strong",{children:"Touch:"})," Drag to rotate  Pinch to zoom"]}),i.jsxs("p",{children:[i.jsx("strong",{children:"Right-click"})," canvas for quick actions"]})]})]})}):null},pi=12e3,Ne=2e3,fi=()=>{const{storyMode:e,setStoryMode:t,currentStoryIndex:s,setCurrentStoryIndex:r,setCurrentSystem:n,setLorenzParams:a,setRosslerParams:o,setDoublePendulumParams:c,setTrailLength:l,setSpeed:u,setSideBySideMode:f,setInitialOffset:p,setCurrentPreset:m,setAutoRotate:d,resetSimulation:v,colorTheme:M,setCinematicCamera:y}=D(),b=V[M],x=h.useRef(null),[R,P]=h.useState(!1),[C,T]=h.useState(0),B=h.useCallback(z=>{const _=ae[z];if(_){switch(n(_.system),l(_.trailLength),u(_.speed),f(_.sideBySide),p(_.offset),m(null),d(!0),y(!_.sideBySide),_.system){case"lorenz":a(_.params);break;case"rossler":o(_.params);break;case"doublePendulum":c(_.params);break}v()}},[n,a,o,c,l,u,f,p,m,d,y,v]),g=h.useCallback(()=>{P(!0),setTimeout(()=>{const z=(s+1)%ae.length;r(z),B(z),T(z),setTimeout(()=>P(!1),100)},Ne/2)},[s,r,B]),w=h.useCallback(()=>{P(!0),setTimeout(()=>{const z=(s-1+ae.length)%ae.length;r(z),B(z),T(z),setTimeout(()=>P(!1),100)},Ne/2)},[s,r,B]);h.useEffect(()=>{e&&(B(s),T(s))},[e]),h.useEffect(()=>{if(e)return x.current=setTimeout(g,pi),()=>{x.current&&clearTimeout(x.current)}},[e,s,g]);const E=h.useCallback(()=>{t(!1),y(!1),d(!1),x.current&&clearTimeout(x.current)},[t,y,d]);if(h.useEffect(()=>{if(!e)return;const z=_=>{_.key==="Escape"?E():_.key==="ArrowRight"||_.key===" "?(_.preventDefault(),g()):_.key==="ArrowLeft"&&(_.preventDefault(),w())};return window.addEventListener("keydown",z),()=>window.removeEventListener("keydown",z)},[e,g,w,E]),!e)return null;const A=ae[C];return A?i.jsxs("div",{className:`story-mode-overlay ${R?"transitioning":""}`,style:{"--story-accent":b.accent,"--story-bg":b.panelBg,"--story-text":b.text,"--story-border":b.panelBorder},children:[i.jsx("div",{className:"story-progress",children:ae.map((z,_)=>i.jsx("button",{className:`story-dot ${_===C?"active":""} ${_<C?"visited":""}`,onClick:()=>{P(!0),setTimeout(()=>{r(_),B(_),T(_),setTimeout(()=>P(!1),100)},Ne/2)},"aria-label":`Go to story ${_+1}: ${ae[_].name}`},_))}),i.jsxs("div",{className:"story-card",children:[i.jsx("div",{className:"story-emoji",children:A.emoji}),i.jsxs("div",{className:"story-text",children:[i.jsx("h2",{className:"story-title",children:A.name}),i.jsx("p",{className:"story-description",children:A.description})]}),i.jsxs("div",{className:"story-counter",children:[C+1," / ",ae.length]})]}),i.jsxs("div",{className:"story-nav",children:[i.jsx("button",{className:"story-nav-btn",onClick:w,"aria-label":"Previous story",children:""}),i.jsx("button",{className:"story-nav-btn story-exit",onClick:E,"aria-label":"Exit story mode",children:" Exit"}),i.jsx("button",{className:"story-nav-btn",onClick:g,"aria-label":"Next story",children:""})]})]}):null},ut={lorenz:{xRange:[-25,25],yRange:[-30,30],zRange:[0,55]},rossler:{xRange:[-15,15],yRange:[-15,15],zRange:[0,30]},doublePendulum:{xRange:[-3,3],yRange:[-3,3],zRange:[-1,1]}};function je(e,t,s,r,n){const a=Math.max(t,Math.min(s,e));return r+(a-t)/(s-t)*(n-r)}const Te=[130.81,146.83,164.81,196,220,261.63,293.66,329.63,392,440,523.25,587.33,659.26];function ht(e){let t=Te[0],s=Math.abs(e-t);for(let r=1;r<Te.length;r++){const n=Math.abs(e-Te[r]);n<s&&(s=n,t=Te[r])}return t}const mi=()=>{const{audioEnabled:e,audioVolume:t,currentSystem:s,isPlaying:r}=D(),n=h.useRef(null),a=h.useRef(null),o=h.useRef(null),c=h.useRef(null),l=h.useRef(null),u=h.useRef(null),f=h.useRef(null),p=h.useRef(null),m=h.useRef(0),d=h.useCallback(()=>{if(n.current)return;const y=new AudioContext;n.current=y;const b=y.createOscillator();b.type="sine",b.frequency.value=220,a.current=b;const x=y.createOscillator();x.type="triangle",x.frequency.value=220,x.detune.value=7,o.current=x;const R=y.createBiquadFilter();R.type="lowpass",R.frequency.value=800,R.Q.value=2,l.current=R;const P=y.createGain();P.gain.value=0,c.current=P;const C=y.createGain();C.gain.value=t,u.current=C;const T=y.createDelay(1);T.delayTime.value=.3;const B=y.createGain();B.gain.value=.25;const g=y.createGain();g.gain.value=.3,f.current=g,b.connect(R),x.connect(R),R.connect(P),P.connect(C),P.connect(T),T.connect(B),B.connect(T),T.connect(g),g.connect(C),C.connect(y.destination),b.start(),x.start()},[t]),v=h.useCallback(()=>{if(m.current&&(cancelAnimationFrame(m.current),m.current=0),a.current){try{a.current.stop()}catch{}a.current=null}if(o.current){try{o.current.stop()}catch{}o.current=null}n.current&&(n.current.close(),n.current=null),c.current=null,l.current=null,u.current=null,f.current=null,p.current=null},[]),M=h.useCallback(()=>{const y=n.current,b=a.current,x=o.current,R=c.current,P=l.current;if(!y||!b||!x||!R||!P)return;const C=window.__chaosLabSystem;if(!C?.points||C.points.length<5){R.gain.setTargetAtTime(0,y.currentTime,.1),m.current=requestAnimationFrame(M);return}const T=window.__chaosLabSystemType||"lorenz",B=C.points,g=B[B.length-1],w=ut[T]||ut.lorenz,E=p.current||g,A=g.x-E.x,z=g.y-E.y,_=g.z-E.z,O=Math.sqrt(A*A+z*z+_*_);p.current={x:g.x,y:g.y,z:g.z};const k=y.currentTime,L=.08,K=je(g.x,w.xRange[0],w.xRange[1],100,600),ge=ht(K);b.frequency.setTargetAtTime(ge,k,L);const X=je(g.y,w.yRange[0],w.yRange[1],80,500),J=ht(X)*1.5;x.frequency.setTargetAtTime(J,k,L*1.5);const $=je(g.z,w.zRange[0],w.zRange[1],200,2500);P.frequency.setTargetAtTime($,k,L);const Y=Math.min(1,O/(T==="doublePendulum"?2:15)),Re=Y*Y*.4;R.gain.setTargetAtTime(Re,k,L),m.current=requestAnimationFrame(M)},[]);return h.useEffect(()=>(e&&r?(d(),setTimeout(()=>{m.current=requestAnimationFrame(M)},100)):v(),()=>{v()}),[e,r,d,v,M]),h.useEffect(()=>{u.current&&n.current&&u.current.gain.setTargetAtTime(t,n.current.currentTime,.05)},[t]),h.useEffect(()=>{e&&c.current&&n.current&&(r||c.current.gain.setTargetAtTime(0,n.current.currentTime,.2))},[r,e]),h.useEffect(()=>{p.current=null},[s]),null};function gi(){const{currentSystem:e}=D();return h.useCallback(()=>{const s=document.querySelector("canvas");if(s)try{const r=e==="doublePendulum"?"pendulum":e,n=new Date().toISOString().split("T")[0],a=`chaos-lab-${r}-${n}.png`;s.toBlob(o=>{if(!o)return;const c=URL.createObjectURL(o),l=document.createElement("a");l.href=c,l.download=a,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(c)},"image/png")}catch(r){console.warn("Screenshot failed:",r)}},[e])}const vi=new Set(["lorenz","rossler","doublePendulum"]),bi=new Set(["classic","neon","blueprint","terminal"]);function wt(){const e=D.getState(),t=new URLSearchParams;switch(t.set("sys",e.currentSystem),t.set("theme",e.colorTheme),t.set("speed",e.speed.toFixed(1)),t.set("trail",String(e.trailLength)),t.set("sbs",e.sideBySideMode?"1":"0"),e.sideBySideMode&&t.set("offset",e.initialOffset.toExponential(1)),e.currentSystem){case"lorenz":t.set("sigma",e.lorenzParams.sigma.toFixed(2)),t.set("rho",e.lorenzParams.rho.toFixed(2)),t.set("beta",e.lorenzParams.beta.toFixed(3));break;case"rossler":t.set("a",e.rosslerParams.a.toFixed(3)),t.set("b",e.rosslerParams.b.toFixed(3)),t.set("c",e.rosslerParams.c.toFixed(2));break;case"doublePendulum":t.set("m1",e.doublePendulumParams.mass1.toFixed(2)),t.set("m2",e.doublePendulumParams.mass2.toFixed(2)),t.set("l1",e.doublePendulumParams.length1.toFixed(2)),t.set("l2",e.doublePendulumParams.length2.toFixed(2)),t.set("g",e.doublePendulumParams.gravity.toFixed(2)),t.set("damp",e.doublePendulumParams.damping.toFixed(3));break}return"#"+t.toString()}function xi(e){if(!e||e.length<2)return!1;try{const t=new URLSearchParams(e.slice(1)),s=D.getState(),r=t.get("sys");if(r&&vi.has(r))s.setCurrentSystem(r);else return!1;const n=t.get("theme");n&&bi.has(n)&&s.setColorTheme(n);const a=parseFloat(t.get("speed")||"");a>0&&a<=5&&s.setSpeed(a);const o=parseInt(t.get("trail")||"");if(o>=100&&o<=5e3&&s.setTrailLength(o),t.get("sbs")==="1"){s.setSideBySideMode(!0);const l=parseFloat(t.get("offset")||"");l>0&&l<1&&s.setInitialOffset(l)}switch(r){case"lorenz":{const l=parseFloat(t.get("sigma")||""),u=parseFloat(t.get("rho")||""),f=parseFloat(t.get("beta")||"");l>0&&s.setLorenzParams({sigma:l}),u>0&&s.setLorenzParams({rho:u}),f>0&&s.setLorenzParams({beta:f});break}case"rossler":{const l=parseFloat(t.get("a")||""),u=parseFloat(t.get("b")||""),f=parseFloat(t.get("c")||"");l>0&&s.setRosslerParams({a:l}),u>0&&s.setRosslerParams({b:u}),f>0&&s.setRosslerParams({c:f});break}case"doublePendulum":{const l=parseFloat(t.get("m1")||""),u=parseFloat(t.get("m2")||""),f=parseFloat(t.get("l1")||""),p=parseFloat(t.get("l2")||""),m=parseFloat(t.get("g")||""),d=parseFloat(t.get("damp")||"");l>0&&s.setDoublePendulumParams({mass1:l}),u>0&&s.setDoublePendulumParams({mass2:u}),f>0&&s.setDoublePendulumParams({length1:f}),p>0&&s.setDoublePendulumParams({length2:p}),m>0&&s.setDoublePendulumParams({gravity:m}),d>=0&&s.setDoublePendulumParams({damping:d});break}}return!0}catch{return!1}}function dt(){return window.location.origin+window.location.pathname+wt()}function yi(){const e=h.useRef(!1);h.useEffect(()=>{e.current||(e.current=!0,window.location.hash&&xi(window.location.hash))},[]);const{currentSystem:t,colorTheme:s,speed:r,trailLength:n,sideBySideMode:a,initialOffset:o,lorenzParams:c,rosslerParams:l,doublePendulumParams:u}=D();h.useEffect(()=>{const f=setTimeout(()=>{window.history.replaceState(null,"",wt())},500);return()=>clearTimeout(f)},[t,s,r,n,a,o,c,l,u])}const Ie=["classic","neon","blueprint","terminal"],De=["lorenz","rossler","doublePendulum"];function Si(e){const t=gi();h.useEffect(()=>{const s=r=>{const n=r.target.tagName;if(n==="INPUT"||n==="TEXTAREA"||n==="SELECT"||r.ctrlKey||r.metaKey||r.altKey)return;const a=D.getState();switch(r.key){case" ":r.preventDefault(),a.setIsPlaying(!a.isPlaying);break;case"r":case"R":a.resetSimulation();break;case"1":a.setCurrentSystem(De[0]),a.setCurrentPreset(null);break;case"2":a.setCurrentSystem(De[1]),a.setCurrentPreset(null);break;case"3":a.setCurrentSystem(De[2]),a.setCurrentPreset(null);break;case"s":case"S":a.setSideBySideMode(!a.sideBySideMode),a.sideBySideMode||a.resetSimulation();break;case"t":case"T":{const o=Ie.indexOf(a.colorTheme),c=Ie[(o+1)%Ie.length];a.setColorTheme(c);break}case"h":case"H":case"?":e();break;case"p":case"P":t();break;case"l":case"L":try{navigator.clipboard.writeText(dt())}catch{window.prompt("Share this URL:",dt())}break;case"c":case"C":a.setCinematicCamera(!a.cinematicCamera);break;case"a":case"A":a.setChaosAutopilot(!a.chaosAutopilot);break;case"Escape":a.storyMode?(a.setStoryMode(!1),a.setCinematicCamera(!1)):a.showBifurcation?a.setShowBifurcation(!1):a.showPoincare?a.setShowPoincare(!1):a.showParameterSpace?a.setShowParameterSpace(!1):a.cinematicCamera&&a.setCinematicCamera(!1);break}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[e,t])}const Ti=h.lazy(()=>Oe(()=>import("./BifurcationDiagram-CD28wd6-.js"),__vite__mapDeps([0,1,2])).then(e=>({default:e.BifurcationDiagram}))),wi=h.lazy(()=>Oe(()=>import("./PoincareSection-D4ZmqAVA.js"),__vite__mapDeps([3,1,4])).then(e=>({default:e.PoincareSection}))),Ei=h.lazy(()=>Oe(()=>import("./ParameterSpace-Bv7wZJMU.js"),__vite__mapDeps([5,1,6])).then(e=>({default:e.ParameterSpace})));function Ri(){const e=D(t=>t.setIsPlaying);h.useEffect(()=>{const t=window.matchMedia("(prefers-reduced-motion: reduce)");t.matches&&e(!1);const s=r=>{r.matches&&e(!1)};return t.addEventListener("change",s),()=>t.removeEventListener("change",s)},[e])}function Mi(){const{colorTheme:e,currentSystem:t}=D(),s=V[e],[r,n]=h.useState(!1),a=h.useCallback(()=>n(c=>!c),[]);Ri(),Si(a),yi();const o=t==="lorenz"?"Lorenz Attractor":t==="rossler"?"Rssler Attractor":"Double Pendulum";return i.jsxs("div",{className:"app",style:{"--bg":s.bg,"--text":s.text,"--accent":s.accent},children:[i.jsx("a",{href:"#controls-region",className:"skip-link",children:"Skip to controls"}),i.jsxs("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:["Now viewing: ",o]}),i.jsx("main",{children:i.jsx(si,{})}),i.jsx(oi,{}),i.jsx("div",{id:"controls-region",children:i.jsx(ni,{})}),i.jsx(ci,{}),i.jsx(ui,{}),i.jsxs(h.Suspense,{fallback:null,children:[i.jsx(Ti,{}),i.jsx(wi,{}),i.jsx(Ei,{})]}),i.jsx(di,{isVisible:r,onClose:a}),i.jsx(fi,{}),i.jsx(li,{}),i.jsx(mi,{}),i.jsxs("div",{className:"title-overlay","aria-hidden":"true",children:[i.jsx("h1",{children:"Chaos Lab"}),i.jsx("p",{children:"Interactive Chaos Theory Visualizer"})]}),i.jsx("div",{className:"instructions","aria-hidden":"true",children:i.jsxs("p",{children:[i.jsx("strong",{children:"Mouse:"})," Drag to rotate  Scroll to zoom  Right-drag to pan",i.jsx("br",{}),i.jsx("strong",{children:"Touch:"})," Drag to rotate  Pinch to zoom"]})})]})}es.createRoot(document.getElementById("root")).render(i.jsx(h.StrictMode,{children:i.jsx(Mi,{})}));export{V as T,D as u};
