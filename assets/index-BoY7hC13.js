const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/BifurcationDiagram-O0Hzjq-S.js","assets/three-vendor-CMdyc2H8.js","assets/BifurcationDiagram-7MOkXOt8.css","assets/PoincareSection-BEnob7Mp.js","assets/PoincareSection-Bu5ajD9c.css","assets/ParameterSpace-DsCtjsWw.js","assets/ParameterSpace-U0tBLzM4.css"])))=>i.map(i=>d[i]);
import{V as G,c as lt,r as o,u as X,B as W,L as Ie,A as J,j as t,a as Me,D as ct,C as K,b as Ge,d as ut,E as ht,e as dt,G as mt,O as pt,f as ft,w as gt,_ as _e,g as yt}from"./three-vendor-CMdyc2H8.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function s(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(i){if(i.ep)return;i.ep=!0;const n=s(i);fetch(i.href,n)}})();class bt{points=[];position;params;dt=.01;perturbation=new G(1,0,0);lyapunovSum=0;lyapunovSteps=0;lyapunovExponent=0;RENORM_INTERVAL=10;stepsSinceRenorm=0;prevZ=0;prevDz=0;poincarePoints=[];MAX_POINCARE=5e3;constructor(e=new G(1,1,1),s){this.position=e.clone(),this.params=s,this.points=[this.position.clone()],this.prevZ=e.z}derivatives(e,s,a){const{sigma:i,rho:n,beta:c}=this.params;return[i*(s-e),e*(n-a)-s,e*s-c*a]}jacobianApply(e,s,a,i,n,c){const{sigma:d,rho:h,beta:u}=this.params;return[d*(n-i),(h-a)*i-n-e*c,s*i+e*n-u*c]}step(e=1){const s=this.dt*e,{x:a,y:i,z:n}=this.position,[c,d,h]=this.derivatives(a,i,n),[u,m,l]=this.derivatives(a+.5*s*c,i+.5*s*d,n+.5*s*h),[x,f,v]=this.derivatives(a+.5*s*u,i+.5*s*m,n+.5*s*l),[P,y,S]=this.derivatives(a+s*x,i+s*f,n+s*v);this.position.x+=s/6*(c+2*u+2*x+P),this.position.y+=s/6*(d+2*m+2*f+y),this.position.z+=s/6*(h+2*l+2*v+S),(!isFinite(this.position.x)||!isFinite(this.position.y)||!isFinite(this.position.z)||Math.abs(this.position.x)>1e6)&&this.position.set(1,1,1),this.points.push(new G(this.position.x,this.position.y,this.position.z));const g=this.perturbation.x,p=this.perturbation.y,T=this.perturbation.z,[A,j,k]=this.jacobianApply(this.position.x,this.position.y,this.position.z,g,p,T);if(this.perturbation.x+=A*s,this.perturbation.y+=j*s,this.perturbation.z+=k*s,this.stepsSinceRenorm++,this.stepsSinceRenorm>=this.RENORM_INTERVAL){const R=this.perturbation.length();if(R>0&&isFinite(R)){this.lyapunovSum+=Math.log(R),this.lyapunovSteps++,this.perturbation.divideScalar(R);const b=this.lyapunovSteps*this.RENORM_INTERVAL*this.dt;this.lyapunovExponent=this.lyapunovSum/b}this.stepsSinceRenorm=0}const w=this.position.z-this.prevZ;return this.prevDz>0&&w<=0&&this.points.length>100&&(this.poincarePoints.push([this.position.x,this.position.y]),this.poincarePoints.length>this.MAX_POINCARE&&this.poincarePoints.splice(0,this.poincarePoints.length-this.MAX_POINCARE)),this.prevDz=w,this.prevZ=this.position.z,this.position}reset(e=new G(1,1,1)){this.position=e.clone(),this.points=[this.position.clone()],this.perturbation.set(1,0,0),this.lyapunovSum=0,this.lyapunovSteps=0,this.lyapunovExponent=0,this.stepsSinceRenorm=0,this.prevZ=e.z,this.prevDz=0,this.poincarePoints=[]}updateParams(e){this.params={...this.params,...e}}trimTrail(e){this.points.length>e&&this.points.splice(0,this.points.length-e)}getSpeed(){if(this.points.length<2)return 0;const e=this.points[this.points.length-1],s=this.points[this.points.length-2];return e.distanceTo(s)}getParams(){return{...this.params}}perturb(e){this.position.x+=(Math.random()-.5)*e*2,this.position.y+=(Math.random()-.5)*e*2,this.position.z+=(Math.random()-.5)*e*2}getPosition(){return{x:this.position.x,y:this.position.y,z:this.position.z}}}const V={system:null,type:null};function Be(r,e){V.system=r,V.type=e}function De(r){V.system===r&&(V.system=null,V.type=null)}function xt(r){const e=V.system;e&&typeof e.perturb=="function"&&e.perturb(r)}const vt={lorenz:.1,rossler:.5,doublePendulum:1},St=5,wt=6e3,pe=[];function jt(r,e,s){const a=vt[e]??.1,i=e==="doublePendulum",n=Math.min(r.length,wt),c=new Float32Array(n*3),d=Math.max(0,r.length-n);for(let h=0;h<n;h++){const u=r[d+h],m=h*3;c[m]=u.x*a,c[m+1]=u.y*a,c[m+2]=i?0:u.z*a}pe.push({positions:c,count:n,hue:s,flat:i}),pe.length>St&&pe.shift()}function Pt(){pe.length=0}function Mt(){return pe}function Ce(){return pe.length}const U={classic:{bg:"#000010",bgRgb:"0,0,16",panelBg:"rgba(20, 20, 25, 0.95)",panelBorder:"rgba(255, 255, 255, 0.1)",text:"#cccccc",textMuted:"rgba(255,255,255,0.6)",accent:"#88ccff",accent2:"#aaffaa",heading:"#88ccff",paramColor:"#ffcc88",trailHue1:.55,trailHue2:.85,starColor:"#ffffff"},neon:{bg:"#000000",bgRgb:"0,0,0",panelBg:"rgba(10, 0, 20, 0.95)",panelBorder:"rgba(255, 0, 255, 0.25)",text:"#e0e0e0",textMuted:"rgba(255,255,255,0.5)",accent:"#ff00ff",accent2:"#00ffff",heading:"#ff44ff",paramColor:"#ffff00",trailHue1:.83,trailHue2:.5,starColor:"#ff88ff"},blueprint:{bg:"#0a1628",bgRgb:"10,22,40",panelBg:"rgba(15, 30, 60, 0.95)",panelBorder:"rgba(100, 160, 255, 0.3)",text:"#c0d8f0",textMuted:"rgba(192,216,240,0.6)",accent:"#4488ff",accent2:"#88bbff",heading:"#6699ff",paramColor:"#aaccff",trailHue1:.6,trailHue2:.58,starColor:"#4488ff"},terminal:{bg:"#000a00",bgRgb:"0,10,0",panelBg:"rgba(0, 15, 0, 0.95)",panelBorder:"rgba(0, 255, 0, 0.2)",text:"#00dd00",textMuted:"rgba(0,220,0,0.5)",accent:"#00ff00",accent2:"#88ff88",heading:"#00ff00",paramColor:"#44ff44",trailHue1:.33,trailHue2:.28,starColor:"#00ff00"}},He={lorenz:[{name:"Classic Lorenz",description:"The original butterfly attractor",params:{sigma:10,rho:28,beta:8/3}},{name:"Edge of Chaos",description:"Parameters at the edge between order and chaos",params:{sigma:10,rho:24,beta:8/3}},{name:"Strange Attractor",description:"Different parameter set creating unique patterns",params:{sigma:12,rho:30,beta:2.5}}],rossler:[{name:"Classic RÃ¶ssler",description:"The standard RÃ¶ssler attractor parameters",params:{a:.2,b:.2,c:5.7}},{name:"Spiral Focus",description:"Creates tighter spiral patterns",params:{a:.1,b:.1,c:4}},{name:"Period Doubling",description:"Shows period-doubling route to chaos",params:{a:.15,b:.2,c:10}}],doublePendulum:[{name:"Equal Masses",description:"Two pendulums with equal mass and length",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0}},{name:"Heavy Bottom",description:"Bottom pendulum twice as heavy",params:{mass1:1,mass2:2,length1:1,length2:1,gravity:9.81,damping:0}},{name:"With Damping",description:"Small damping showing energy dissipation",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:.05}}]},ae=[{name:"The Butterfly Effect",emoji:"ðŸ¦‹",description:"Two nearly identical universes diverge into completely different futures",system:"lorenz",params:{sigma:10,rho:28,beta:8/3},trailLength:2e3,speed:1,sideBySide:!0,offset:1e-6},{name:"The Strange Attractor",emoji:"ðŸŒ€",description:"The iconic Lorenz butterfly â€” a shape that never repeats, yet never escapes",system:"lorenz",params:{sigma:10,rho:28,beta:8/3},trailLength:4e3,speed:1.5,sideBySide:!1,offset:.001},{name:"Edge of Order",emoji:"âš–ï¸",description:"Right at the boundary where predictable behavior gives way to chaos",system:"lorenz",params:{sigma:10,rho:24.5,beta:8/3},trailLength:3e3,speed:.8,sideBySide:!1,offset:.001},{name:"The Spiral",emoji:"ðŸŒŠ",description:"The RÃ¶ssler attractor â€” simplicity breeds complexity in this elegant spiral",system:"rossler",params:{a:.2,b:.2,c:5.7},trailLength:3500,speed:1.2,sideBySide:!1,offset:.001},{name:"Period Doubling",emoji:"ðŸ”„",description:"Watch the RÃ¶ssler system trace a period-2 orbit â€” the route to chaos begins",system:"rossler",params:{a:.2,b:.2,c:3.5},trailLength:3e3,speed:1,sideBySide:!1,offset:.001},{name:"The Pendulum",emoji:"âš¡",description:"A simple double pendulum â€” deterministic laws, unpredictable motion",system:"doublePendulum",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},trailLength:2e3,speed:1,sideBySide:!1,offset:.001},{name:"Dual Pendulums",emoji:"ðŸ”€",description:"Two pendulums, almost identical â€” watch them dance apart",system:"doublePendulum",params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},trailLength:1500,speed:1,sideBySide:!0,offset:1e-4},{name:"The Murmuration",emoji:"ðŸ¦",description:"A swarm of particles traces the attractor â€” chaos as collective motion",system:"lorenz",params:{sigma:10,rho:28,beta:8/3},trailLength:1500,speed:1.2,sideBySide:!1,offset:.001}],I=lt(r=>({currentSystem:"lorenz",setCurrentSystem:e=>r({currentSystem:e}),isPlaying:!0,setIsPlaying:e=>r({isPlaying:e}),speed:1,setSpeed:e=>r({speed:e}),trailLength:2e3,setTrailLength:e=>r({trailLength:e}),sideBySideMode:!1,setSideBySideMode:e=>r({sideBySideMode:e}),initialOffset:.001,setInitialOffset:e=>r({initialOffset:e}),divergence:0,setDivergence:e=>r({divergence:e}),colorTheme:"classic",setColorTheme:e=>r({colorTheme:e}),lorenzParams:{sigma:10,rho:28,beta:8/3},setLorenzParams:e=>r(s=>({lorenzParams:{...s.lorenzParams,...e}})),rosslerParams:{a:.2,b:.2,c:5.7},setRosslerParams:e=>r(s=>({rosslerParams:{...s.rosslerParams,...e}})),doublePendulumParams:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},setDoublePendulumParams:e=>r(s=>({doublePendulumParams:{...s.doublePendulumParams,...e}})),currentPreset:null,setCurrentPreset:e=>r({currentPreset:e}),showInfoPanel:!0,setShowInfoPanel:e=>r({showInfoPanel:e}),autoRotate:!0,setAutoRotate:e=>r({autoRotate:e}),_resetCounter:0,resetSimulation:()=>{r(e=>({_resetCounter:e._resetCounter+1,isPlaying:!1})),setTimeout(()=>r({isPlaying:!0}),100)},showPerformanceWarning:!1,setShowPerformanceWarning:e=>r({showPerformanceWarning:e}),showLyapunov:!1,setShowLyapunov:e=>r({showLyapunov:e}),lyapunovExponent:0,setLyapunovExponent:e=>r({lyapunovExponent:e}),showBifurcation:!1,setShowBifurcation:e=>r({showBifurcation:e}),showPoincare:!1,setShowPoincare:e=>r({showPoincare:e}),showParameterSpace:!1,setShowParameterSpace:e=>r({showParameterSpace:e}),cinematicCamera:!1,setCinematicCamera:e=>r({cinematicCamera:e}),chaosAutopilot:!1,setChaosAutopilot:e=>r({chaosAutopilot:e}),storyMode:!1,setStoryMode:e=>r({storyMode:e}),currentStoryIndex:0,setCurrentStoryIndex:e=>r({currentStoryIndex:e}),bloomEnabled:!0,setBloomEnabled:e=>r({bloomEnabled:e}),bloomIntensity:1.5,setBloomIntensity:e=>r({bloomIntensity:e}),audioEnabled:!1,setAudioEnabled:e=>r({audioEnabled:e}),audioVolume:.3,setAudioVolume:e=>r({audioVolume:e}),particleSwarm:!1,setParticleSwarm:e=>r({particleSwarm:e}),_perturbCounter:0,perturbSystem:()=>{xt(1),r(e=>({_perturbCounter:e._perturbCounter+1}))},_ghostVersion:0,captureGhost:()=>{const e=V.system,s=V.type;if(!e?.points||e.points.length<10||!s)return;const a=I.getState(),i=U[a.colorTheme].trailHue1;jt(e.points,s,i),r(n=>({_ghostVersion:n._ghostVersion+1}))},clearGhosts:()=>{Pt(),r(e=>({_ghostVersion:e._ghostVersion+1}))},showFloorShadow:!1,setShowFloorShadow:e=>r({showFloorShadow:e}),exposureMode:!1,setExposureMode:e=>r({exposureMode:e}),_exposureClearCounter:0,clearExposure:()=>r(e=>({_exposureClearCounter:e._exposureClearCounter+1}))})),te=6e3,Oe=({points:r,hueStart:e,hueEnd:s,scale:a=1,flatZ:i=!1,glowIntensity:n=.6})=>{const c=o.useRef(null),d=o.useRef(null),h=o.useRef(null),u=o.useRef(null),{posBuffer:m,colorBuffer:l,glowColorBuffer:x}=o.useMemo(()=>({posBuffer:new Float32Array(te*3),colorBuffer:new Float32Array(te*3),glowColorBuffer:new Float32Array(te*3)}),[]);X(()=>{if(!h.current||!u.current)return;const P=Math.min(r.length,te);if(P<2){h.current.setDrawRange(0,0),u.current.setDrawRange(0,0);return}const y=Math.max(0,r.length-te),S=a;for(let j=0;j<P;j++){const k=r[y+j],w=j*3;m[w]=k.x*S,m[w+1]=k.y*S,m[w+2]=i?0:k.z*S;const R=j/(P-1),b=R*R,z=e+(s-e)*R,N=.8+R*.2,E=.3+b*.55,M=(1-Math.abs(2*E-1))*N,F=(z%1+1)%1*6,B=M*(1-Math.abs(F%2-1)),O=E-M/2,$=Math.floor(F)%6;let _=0,q=0,D=0;switch($){case 0:_=M,q=B;break;case 1:_=B,q=M;break;case 2:q=M,D=B;break;case 3:q=B,D=M;break;case 4:_=B,D=M;break;case 5:_=M,D=B;break}l[w]=(_+O)*b,l[w+1]=(q+O)*b,l[w+2]=(D+O)*b;const H=b*n,L=1.5+R*.5;x[w]=(_+O)*H*L,x[w+1]=(q+O)*H*L,x[w+2]=(D+O)*H*L}const g=h.current.getAttribute("position"),p=h.current.getAttribute("color");g.set(m.subarray(0,P*3)),p.set(l.subarray(0,P*3)),g.needsUpdate=!0,p.needsUpdate=!0,h.current.setDrawRange(0,P);const T=u.current.getAttribute("position"),A=u.current.getAttribute("color");T.set(m.subarray(0,P*3)),A.set(x.subarray(0,P*3)),T.needsUpdate=!0,A.needsUpdate=!0,u.current.setDrawRange(0,P)}),o.useEffect(()=>{!h.current||!u.current||(h.current.setAttribute("position",new W(new Float32Array(te*3),3)),h.current.setAttribute("color",new W(new Float32Array(te*3),3)),h.current.setDrawRange(0,0),u.current.setAttribute("position",new W(new Float32Array(te*3),3)),u.current.setAttribute("color",new W(new Float32Array(te*3),3)),u.current.setDrawRange(0,0))},[]);const f=o.useMemo(()=>new Ie({vertexColors:!0,transparent:!0,opacity:1,depthWrite:!1,blending:J}),[]),v=o.useMemo(()=>new Ie({vertexColors:!0,transparent:!0,opacity:.5,depthWrite:!1,blending:J}),[]);return t.jsxs(t.Fragment,{children:[t.jsxs("primitive",{object:new Me,ref:c,children:[t.jsx("bufferGeometry",{ref:h}),t.jsx("primitive",{object:f,attach:"material"})]}),t.jsxs("primitive",{object:new Me,ref:d,children:[t.jsx("bufferGeometry",{ref:u}),t.jsx("primitive",{object:v,attach:"material"})]})]})},$e=({position:r,color:e,lightIntensity:s=.8,size:a=1,showPulse:i=!0})=>{const n=o.useRef(null),c=o.useRef(null),d=o.useRef(null),h=o.useRef(Math.random()*Math.PI*2),u=o.useMemo(()=>{const m=e.clone();return m.offsetHSL(0,.1,.2),m},[e]);return X(({clock:m})=>{const l=m.getElapsedTime();if(h.current+=.04,c.current){const x=1+Math.sin(l*3)*.15,f=.05*a*x;c.current.scale.setScalar(f/(.05*a)||1)}if(d.current){const x=1+Math.sin(l*3+Math.PI)*.2,f=d.current.material;f.opacity=.15+Math.sin(l*2.5)*.08;const v=.12*a*x;d.current.scale.setScalar(v/(.12*a)||1)}if(n.current&&i){const x=l*1.2%2,f=.05+x*.15*a;n.current.scale.set(f,f,1);const v=n.current.material;v.opacity=Math.max(0,.4*(1-x/2))}}),t.jsxs("group",{position:r,children:[s>0&&t.jsx("pointLight",{color:e,intensity:s*.4,distance:1.5*a,decay:2}),t.jsxs("mesh",{ref:d,children:[t.jsx("sphereGeometry",{args:[.12*a,16,16]}),t.jsx("meshBasicMaterial",{color:e,transparent:!0,opacity:.15,depthWrite:!1,blending:J})]}),t.jsxs("mesh",{ref:c,children:[t.jsx("sphereGeometry",{args:[.05*a,16,16]}),t.jsx("meshBasicMaterial",{color:u,transparent:!0,opacity:.95})]}),i&&t.jsxs("mesh",{ref:n,rotation:[Math.PI/2,0,0],children:[t.jsx("ringGeometry",{args:[.8,1,32]}),t.jsx("meshBasicMaterial",{color:e,transparent:!0,opacity:.3,side:ct,depthWrite:!1,blending:J})]})]})},Rt=({position:r=[0,0,0],scale:e=.1,initialCondition:s=[1,1,1],isSecondary:a=!1,lastPosRef:i})=>{const n=o.useRef(null),{isPlaying:c,speed:d,trailLength:h,lorenzParams:u,_resetCounter:m,colorTheme:l,showLyapunov:x,setLyapunovExponent:f,showPoincare:v}=I(),P=U[l],y=o.useMemo(()=>{const j=new G(...s);return new bt(j,u)},[s[0],s[1],s[2],u.sigma,u.rho,u.beta]);o.useEffect(()=>{y.reset(new G(...s))},[m]),o.useEffect(()=>{y.updateParams(u)},[u,y]);const S=o.useRef(y);S.current=y,o.useEffect(()=>(a||Be(y,"lorenz"),()=>{a||De(y)}),[y,a]);const g=o.useRef(0);X(()=>{if(!c)return;y.step(d*.5),y.trimTrail(h);const j=y.points;if(i&&j.length>0){const k=j[j.length-1],w=i;w.current?w.current.set(k.x,k.y,k.z):w.current=new G(k.x,k.y,k.z)}!a&&(x||v)&&(g.current++,g.current%30===0&&f(y.lyapunovExponent))});const p=a?P.trailHue2:P.trailHue1,T=p+.2,A=o.useMemo(()=>new K().setHSL(p+.15,1,.7),[p]);return t.jsxs("group",{ref:n,position:r,children:[t.jsx(Oe,{points:y.points,hueStart:p,hueEnd:T,lineWidth:2.5,glowIntensity:.5,scale:e}),y.points.length>0&&(()=>{const j=y.points[y.points.length-1];return t.jsx($e,{position:[j.x*e,j.y*e,j.z*e],color:A,lightIntensity:a?.4:.8,size:.8,showPulse:!a})})()]})};class Tt{points=[];position;params;dt=.01;perturbation=new G(1,0,0);lyapunovSum=0;lyapunovSteps=0;lyapunovExponent=0;RENORM_INTERVAL=10;stepsSinceRenorm=0;prevY=0;poincarePoints=[];MAX_POINCARE=5e3;constructor(e=new G(1,1,1),s){this.position=e.clone(),this.params=s,this.points=[this.position.clone()],this.prevY=e.y}derivatives(e,s,a){const{a:i,b:n,c}=this.params;return[-s-a,e+i*s,n+a*(e-c)]}jacobianApply(e,s,a,i,n,c){const{a:d,c:h}=this.params;return[-n-c,i+d*n,a*i+(e-h)*c]}step(e=1){const s=this.dt*e,{x:a,y:i,z:n}=this.position,[c,d,h]=this.derivatives(a,i,n),[u,m,l]=this.derivatives(a+.5*s*c,i+.5*s*d,n+.5*s*h),[x,f,v]=this.derivatives(a+.5*s*u,i+.5*s*m,n+.5*s*l),[P,y,S]=this.derivatives(a+s*x,i+s*f,n+s*v);this.position.x+=s/6*(c+2*u+2*x+P),this.position.y+=s/6*(d+2*m+2*f+y),this.position.z+=s/6*(h+2*l+2*v+S),(!isFinite(this.position.x)||!isFinite(this.position.y)||!isFinite(this.position.z)||Math.abs(this.position.x)>1e6)&&this.position.set(1,1,1),this.points.push(new G(this.position.x,this.position.y,this.position.z));const g=this.perturbation.x,p=this.perturbation.y,T=this.perturbation.z,[A,j,k]=this.jacobianApply(this.position.x,this.position.y,this.position.z,g,p,T);if(this.perturbation.x+=A*s,this.perturbation.y+=j*s,this.perturbation.z+=k*s,this.stepsSinceRenorm++,this.stepsSinceRenorm>=this.RENORM_INTERVAL){const w=this.perturbation.length();if(w>0&&isFinite(w)){this.lyapunovSum+=Math.log(w),this.lyapunovSteps++,this.perturbation.divideScalar(w);const R=this.lyapunovSteps*this.RENORM_INTERVAL*this.dt;this.lyapunovExponent=this.lyapunovSum/R}this.stepsSinceRenorm=0}return this.prevY<0&&this.position.y>=0&&this.points.length>100&&(this.poincarePoints.push([this.position.x,this.position.z]),this.poincarePoints.length>this.MAX_POINCARE&&this.poincarePoints.splice(0,this.poincarePoints.length-this.MAX_POINCARE)),this.prevY=this.position.y,this.position}reset(e=new G(1,1,1)){this.position=e.clone(),this.points=[this.position.clone()],this.perturbation.set(1,0,0),this.lyapunovSum=0,this.lyapunovSteps=0,this.lyapunovExponent=0,this.stepsSinceRenorm=0,this.prevY=e.y,this.poincarePoints=[]}updateParams(e){this.params={...this.params,...e}}trimTrail(e){this.points.length>e&&this.points.splice(0,this.points.length-e)}getSpeed(){if(this.points.length<2)return 0;const e=this.points[this.points.length-1],s=this.points[this.points.length-2];return e.distanceTo(s)}getParams(){return{...this.params}}perturb(e){this.position.x+=(Math.random()-.5)*e*2,this.position.y+=(Math.random()-.5)*e*2,this.position.z+=(Math.random()-.5)*e*2}getPosition(){return{x:this.position.x,y:this.position.y,z:this.position.z}}}const Ct=({position:r=[0,0,0],scale:e=.5,initialCondition:s=[1,1,1],isSecondary:a=!1,lastPosRef:i})=>{const n=o.useRef(null),{isPlaying:c,speed:d,trailLength:h,rosslerParams:u,_resetCounter:m,colorTheme:l,showLyapunov:x,setLyapunovExponent:f,showPoincare:v,currentSystem:P}=I(),y=U[l],S=o.useMemo(()=>{const j=new G(...s);return new Tt(j,u)},[s[0],s[1],s[2],u.a,u.b,u.c]);o.useEffect(()=>{S.reset(new G(...s))},[m]),o.useEffect(()=>{S.updateParams(u)},[u,S]),o.useEffect(()=>(a||Be(S,"rossler"),()=>{a||De(S)}),[S,a]);const g=o.useRef(0);X(()=>{if(!c)return;S.step(d*.5),S.trimTrail(h);const j=S.points;if(i&&j.length>0){const k=j[j.length-1],w=i;w.current?w.current.set(k.x,k.y,k.z):w.current=new G(k.x,k.y,k.z)}!a&&P==="rossler"&&(x||v)&&(g.current++,g.current%30===0&&f(S.lyapunovExponent))});const p=a?y.trailHue2:y.trailHue1,T=p+.25,A=o.useMemo(()=>new K().setHSL(p+.15,1,.8),[p]);return t.jsxs("group",{ref:n,position:r,children:[t.jsx(Oe,{points:S.points,hueStart:p,hueEnd:T,lineWidth:2.5,glowIntensity:.5,scale:e}),S.points.length>0&&(()=>{const j=S.points[S.points.length-1];return t.jsx($e,{position:[j.x*e,j.y*e,j.z*e],color:A,lightIntensity:a?.5:1,size:1,showPulse:!a})})()]})};class Et{points=[];positions=[];state;params;dt=.005;pertState={theta1:1e-6,theta2:0,omega1:0,omega2:0};lyapunovSum=0;lyapunovSteps=0;lyapunovExponent=0;RENORM_INTERVAL=20;stepsSinceRenorm=0;prevTheta2=0;poincarePoints=[];MAX_POINCARE=5e3;constructor(e={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0},s){this.state={...e},this.params=s,this.prevTheta2=e.theta2;const a=this.calculatePositions();this.positions=[a],this.points=[new G(a.p2.x,a.p2.y,0)]}_p1=new Ge;_p2=new Ge;calculatePositions(){const{length1:e,length2:s}=this.params,{theta1:a,theta2:i}=this.state,n=e*Math.sin(a),c=-e*Math.cos(a);return this._p1.set(n,c),this._p2.set(n+s*Math.sin(i),c-s*Math.cos(i)),{p1:this._p1,p2:this._p2}}accelerations(e){const{mass1:s,mass2:a,length1:i,length2:n,gravity:c,damping:d}=this.params,{theta1:h,theta2:u,omega1:m,omega2:l}=e,x=s,f=a,v=i,P=n,y=c,S=Math.cos(h-u),g=Math.sin(h-u),p=Math.sin(h),T=Math.sin(u),A=(x+f)*v-f*v*S*S,j=P/v*A,k=-f*v*m*m*g*S+f*y*T*S+f*P*l*l*g-(x+f)*y*p,w=-f*P*l*l*g*S+(x+f)*y*p*S+(x+f)*v*m*m*g-(x+f)*y*T;let R=k/A,b=w/j;return R-=d*m,b-=d*l,{alpha1:R,alpha2:b}}stateDerivative(e){const{alpha1:s,alpha2:a}=this.accelerations(e);return{theta1:e.omega1,theta2:e.omega2,omega1:s,omega2:a}}addStates(e,s,a){return{theta1:e.theta1+s.theta1*a,theta2:e.theta2+s.theta2*a,omega1:e.omega1+s.omega1*a,omega2:e.omega2+s.omega2*a}}step(e=1){const s=this.dt*e,a=this.stateDerivative(this.state),i=this.stateDerivative(this.addStates(this.state,a,.5*s)),n=this.stateDerivative(this.addStates(this.state,i,.5*s)),c=this.stateDerivative(this.addStates(this.state,n,s));this.state.theta1+=s/6*(a.theta1+2*i.theta1+2*n.theta1+c.theta1),this.state.theta2+=s/6*(a.theta2+2*i.theta2+2*n.theta2+c.theta2),this.state.omega1+=s/6*(a.omega1+2*i.omega1+2*n.omega1+c.omega1),this.state.omega2+=s/6*(a.omega2+2*i.omega2+2*n.omega2+c.omega2),(!isFinite(this.state.theta1)||!isFinite(this.state.theta2)||!isFinite(this.state.omega1)||!isFinite(this.state.omega2)||Math.abs(this.state.omega1)>1e6||Math.abs(this.state.omega2)>1e6)&&(this.state={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0});const d=this.calculatePositions();this.positions.push(d),this.points.push(new G(d.p2.x,d.p2.y,0));const h=1e-7,u={theta1:this.state.theta1+this.pertState.theta1*h,theta2:this.state.theta2+this.pertState.theta2*h,omega1:this.state.omega1+this.pertState.omega1*h,omega2:this.state.omega2+this.pertState.omega2*h},m=this.stateDerivative(this.state),l=this.stateDerivative(u);if(this.pertState.theta1+=(l.theta1-m.theta1)/h*s,this.pertState.theta2+=(l.theta2-m.theta2)/h*s,this.pertState.omega1+=(l.omega1-m.omega1)/h*s,this.pertState.omega2+=(l.omega2-m.omega2)/h*s,this.stepsSinceRenorm++,this.stepsSinceRenorm>=this.RENORM_INTERVAL){const v=Math.sqrt(this.pertState.theta1**2+this.pertState.theta2**2+this.pertState.omega1**2+this.pertState.omega2**2);if(v>0&&isFinite(v)){this.lyapunovSum+=Math.log(v),this.lyapunovSteps++,this.pertState.theta1/=v,this.pertState.theta2/=v,this.pertState.omega1/=v,this.pertState.omega2/=v;const P=this.lyapunovSteps*this.RENORM_INTERVAL*this.dt;this.lyapunovExponent=this.lyapunovSum/P}this.stepsSinceRenorm=0}const x=(this.state.theta2%(2*Math.PI)+2*Math.PI)%(2*Math.PI);return(this.prevTheta2%(2*Math.PI)+2*Math.PI)%(2*Math.PI)>Math.PI&&x<=Math.PI&&x<1&&this.points.length>100&&(this.poincarePoints.push([this.state.theta1,this.state.omega1]),this.poincarePoints.length>this.MAX_POINCARE&&this.poincarePoints.splice(0,this.poincarePoints.length-this.MAX_POINCARE)),this.prevTheta2=this.state.theta2,new G(d.p2.x,d.p2.y,0)}reset(e={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0}){this.state={...e};const s=this.calculatePositions();this.positions=[s],this.points=[new G(s.p2.x,s.p2.y,0)],this.pertState={theta1:1e-6,theta2:0,omega1:0,omega2:0},this.lyapunovSum=0,this.lyapunovSteps=0,this.lyapunovExponent=0,this.stepsSinceRenorm=0,this.prevTheta2=e.theta2,this.poincarePoints=[]}updateParams(e){this.params={...this.params,...e}}trimTrail(e){if(this.points.length>e){const s=this.points.length-e;this.points.splice(0,s),this.positions.splice(0,s)}}getSpeed(){if(this.points.length<2)return 0;const e=this.points[this.points.length-1],s=this.points[this.points.length-2];return e.distanceTo(s)}getCurrentPositions(){return this.positions[this.positions.length-1]}getState(){return{...this.state}}perturb(e){this.state.theta1+=(Math.random()-.5)*e*.3,this.state.theta2+=(Math.random()-.5)*e*.3,this.state.omega1+=(Math.random()-.5)*e*3,this.state.omega2+=(Math.random()-.5)*e*3}}const At=({position:r=[0,0,0],scale:e=1,initialCondition:s={theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0},isSecondary:a=!1,lastPosRef:i})=>{const n=o.useRef(null),{isPlaying:c,speed:d,trailLength:h,doublePendulumParams:u,_resetCounter:m,colorTheme:l,showLyapunov:x,setLyapunovExponent:f,showPoincare:v,currentSystem:P}=I(),y=U[l],S=o.useMemo(()=>new Et(s,u),[s.theta1,s.theta2,s.omega1,s.omega2,u.mass1,u.mass2,u.length1,u.length2,u.gravity,u.damping]);o.useEffect(()=>{S.reset(s)},[m]),o.useEffect(()=>{S.updateParams(u)},[u,S]),o.useEffect(()=>(a||Be(S,"doublePendulum"),()=>{a||De(S)}),[S,a]);const g=o.useRef(0);X(()=>{if(!c)return;S.step(d*2),S.trimTrail(h);const B=S.points;if(i&&B.length>0){const O=B[B.length-1],$=i;$.current?$.current.set(O.x,O.y,0):$.current=new G(O.x,O.y,0)}!a&&P==="doublePendulum"&&(x||v)&&(g.current++,g.current%30===0&&f(S.lyapunovExponent))});const p=S.positions.length>0?S.getCurrentPositions():{p1:{x:0,y:0},p2:{x:0,y:0}},T=a?y.trailHue2:y.trailHue1,A=T+.2,j=o.useMemo(()=>new K(y.textMuted),[y.textMuted]),k=o.useMemo(()=>new K().setHSL(T,.8,.6),[T]),w=o.useMemo(()=>new K().setHSL(T+.1,.8,.7),[T]),R=o.useMemo(()=>new Float32Array(6),[]),b=o.useMemo(()=>new Float32Array(6),[]),z=o.useRef(null),N=o.useRef(null),E=o.useRef(null),M=o.useRef([0,0,0]);return o.useCallback(()=>{const B=p.p1.x*e,O=p.p1.y*e,$=p.p2.x*e,_=p.p2.y*e;R[3]=B,R[4]=O,z.current&&(z.current.needsUpdate=!0),b[0]=B,b[1]=O,b[3]=$,b[4]=_,N.current&&(N.current.needsUpdate=!0),E.current&&E.current.position.set(B,O,0),M.current=[$,_,0]},[p,e,R,b])(),t.jsxs("group",{ref:n,position:r,children:[t.jsx(Oe,{points:S.points,hueStart:T,hueEnd:A,lineWidth:1.8,glowIntensity:.4,scale:e,flatZ:!0}),t.jsxs("line",{children:[t.jsx("bufferGeometry",{children:t.jsx("bufferAttribute",{ref:z,attach:"attributes-position",args:[R,3]})}),t.jsx("lineBasicMaterial",{color:j,linewidth:2,transparent:!0,opacity:.6})]}),t.jsxs("line",{children:[t.jsx("bufferGeometry",{children:t.jsx("bufferAttribute",{ref:N,attach:"attributes-position",args:[b,3]})}),t.jsx("lineBasicMaterial",{color:j,linewidth:2,transparent:!0,opacity:.6})]}),t.jsxs("mesh",{position:[0,0,0],children:[t.jsx("sphereGeometry",{args:[.03,12,12]}),t.jsx("meshBasicMaterial",{color:"#ffffff",transparent:!0,opacity:.7})]}),t.jsxs("mesh",{ref:E,children:[t.jsx("sphereGeometry",{args:[.06*Math.sqrt(u.mass1),16,16]}),t.jsx("meshBasicMaterial",{color:k})]}),t.jsx($e,{position:M.current,color:w,lightIntensity:a?.3:.6,size:.8*Math.sqrt(u.mass2),showPulse:!a})]})},ne=800,Ee=80,kt=.02,zt=()=>{const r=o.useRef(null),{colorTheme:e}=I(),s=U[e],{positions:a,baseSizes:i,phases:n,speeds:c}=o.useMemo(()=>{const l=new Float32Array(ne*3),x=new Float32Array(ne),f=new Float32Array(ne),v=new Float32Array(ne);for(let P=0;P<ne;P++)l[P*3]=(Math.random()-.5)*Ee,l[P*3+1]=(Math.random()-.5)*Ee,l[P*3+2]=(Math.random()-.5)*Ee,x[P]=Math.random()*1.5+.3,f[P]=Math.random()*Math.PI*2,v[P]=.5+Math.random()*2.5;return{positions:l,baseSizes:x,phases:f,speeds:v}},[]),d=o.useMemo(()=>new Float32Array(ne),[]),h=o.useRef(null),u=o.useMemo(()=>new K(s.starColor),[s.starColor]),m=o.useRef(0);return X(({clock:l})=>{if(!r.current)return;const x=l.getElapsedTime(),f=x*kt;if(r.current.rotation.y=f,r.current.rotation.x=f*.3,m.current++,m.current%3===0){for(let v=0;v<ne;v++){const P=.6+.4*Math.sin(x*c[v]+n[v]);d[v]=i[v]*P}h.current&&(h.current.set(d),h.current.needsUpdate=!0)}}),t.jsxs("points",{ref:r,children:[t.jsxs("bufferGeometry",{children:[t.jsx("bufferAttribute",{attach:"attributes-position",args:[a,3]}),t.jsx("bufferAttribute",{ref:h,attach:"attributes-size",args:[new Float32Array(ne),1]})]}),t.jsx("pointsMaterial",{color:u,size:.09,transparent:!0,opacity:.5,sizeAttenuation:!0,depthWrite:!1,blending:J})]})},Ft={lorenz:.1,rossler:.5,doublePendulum:1},Ue=20,Nt={lorenz:.8,rossler:4,doublePendulum:2},Lt={lorenz:.4,rossler:2,doublePendulum:.5},It=.025,_t=.04,Bt=()=>{const{cinematicCamera:r,currentSystem:e,isPlaying:s}=I(),{camera:a}=ut(),i=o.useRef(new G),n=o.useRef(new G),c=o.useRef(!1),d=o.useRef(!1),h=o.useRef(new G),u=o.useRef(new ht),m=o.useRef(0),l=o.useRef(new G),x=o.useRef(new G),f=o.useRef(new G),v=o.useRef(new G),P=o.useRef(new G),y=o.useRef(new G),S=o.useRef(new G(0,1,0));return X(()=>{if(r&&!d.current&&(h.current.copy(a.position),u.current.copy(a.rotation),m.current=0,d.current=!0),!r&&d.current){d.current=!1,c.current=!1;return}if(!r){c.current=!1;return}const g=V.system;if(!g?.points||g.points.length<Ue+5)return;const p=g.points,T=Ft[e]??.1,A=Nt[e]??1,j=Lt[e]??.5,k=p.length-1,w=Math.max(0,k-Ue),R=p[k],b=p[w],z=l.current.subVectors(R,b).normalize();z.lengthSq()<.001&&z.set(0,0,1);const N=e==="doublePendulum",E=f.current,M=v.current;if(N){const $=R.x*T,_=R.y*T;E.set($*.3,_*.3+.5,A),M.set($,_,0)}else{const $=x.current.set(R.x*T,R.y*T,R.z*T),_=S.current.set(0,1,0),q=P.current.crossVectors(z,_);q.lengthSq()<.001&&q.set(1,0,0),q.normalize();const D=y.current.copy(z).multiplyScalar(-A*T);D.x+=_.x*j*T+q.x*.15*T,D.y+=_.y*j*T+q.y*.15*T,D.z+=_.z*j*T+q.z*.15*T,E.copy($).add(D);const H=p[k];M.set(H.x*T,H.y*T,H.z*T)}c.current||(i.current.copy(a.position),n.current.copy(M),c.current=!0),m.current=Math.min(1,m.current+.008);const F=m.current,B=F*F*(3-2*F),O=s?It+(1-B)*.1:.005;i.current.lerp(E,O),n.current.lerp(M,_t+(1-B)*.1),a.position.copy(i.current),a.lookAt(n.current)}),null},Dt=[{params:{sigma:10,rho:28,beta:2.667},duration:5,transitionTime:4},{params:{sigma:10,rho:15,beta:2.667},duration:3,transitionTime:5},{params:{sigma:10,rho:24.06,beta:2.667},duration:4,transitionTime:4},{params:{sigma:10,rho:28,beta:2.667},duration:3,transitionTime:3},{params:{sigma:14,rho:35,beta:3},duration:4,transitionTime:5},{params:{sigma:10,rho:99.96,beta:2.667},duration:5,transitionTime:6},{params:{sigma:10,rho:45,beta:2.667},duration:3,transitionTime:4},{params:{sigma:10,rho:28,beta:2.667},duration:3,transitionTime:4}],Ot=[{params:{a:.2,b:.2,c:3.5},duration:4,transitionTime:5},{params:{a:.2,b:.2,c:4},duration:3,transitionTime:4},{params:{a:.2,b:.2,c:5},duration:3,transitionTime:4},{params:{a:.2,b:.2,c:5.7},duration:4,transitionTime:3},{params:{a:.2,b:.2,c:8.5},duration:4,transitionTime:5},{params:{a:.3,b:.3,c:12},duration:5,transitionTime:5},{params:{a:.2,b:.2,c:5.7},duration:3,transitionTime:6}],$t=[{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},duration:5,transitionTime:4},{params:{mass1:1,mass2:3,length1:1,length2:1,gravity:9.81,damping:0},duration:4,transitionTime:5},{params:{mass1:2,mass2:1,length1:1.5,length2:.5,gravity:9.81,damping:0},duration:4,transitionTime:5},{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:15,damping:0},duration:4,transitionTime:4},{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:5,damping:.02},duration:5,transitionTime:5},{params:{mass1:1,mass2:1,length1:1,length2:1,gravity:9.81,damping:0},duration:3,transitionTime:4}],qt={lorenz:Dt,rossler:Ot,doublePendulum:$t};function Gt(r,e,s){const a={},i=s*s*(3-2*s);for(const n of Object.keys(r)){const c=r[n]??0,d=e[n]??c;a[n]=c+(d-c)*i}return a}const Ht=()=>{const{chaosAutopilot:r,currentSystem:e,setLorenzParams:s,setRosslerParams:a,setDoublePendulumParams:i,setCurrentPreset:n}=I(),c=o.useRef(0),d=o.useRef(0),h=o.useRef("dwell"),u=o.useRef(0);return o.useEffect(()=>{c.current=0,d.current=0,h.current="dwell",u.current=0},[r,e]),X((m,l)=>{if(!r)return;const x=qt[e];if(!x||x.length===0)return;const f=d.current%x.length,v=(f+1)%x.length,P=x[f],y=x[v];if(u.current+=l,h.current==="dwell")u.current>=P.duration&&(h.current="transition",u.current=0);else{const S=Math.min(1,u.current/P.transitionTime),g=Gt(P.params,y.params,S);switch(e){case"lorenz":s(g);break;case"rossler":a(g);break;case"doublePendulum":i(g);break}n(null),S>=1&&(d.current=v,h.current="dwell",u.current=0)}c.current+=l}),null},Q=150,Ut=2,We=50,Ae=.96,Wt={lorenz:.1,rossler:.5,doublePendulum:1},Vt=()=>{const{isPlaying:r,currentSystem:e,colorTheme:s}=I(),a=U[s],i=o.useRef(null),n=o.useRef(0),c=o.useMemo(()=>({positions:new Float32Array(Q*3),velocities:new Float32Array(Q*3),lifetimes:new Float32Array(Q),colors:new Float32Array(Q*4),sizes:new Float32Array(Q)}),[]),d=o.useMemo(()=>new W(new Float32Array(Q*3),3),[]),h=o.useMemo(()=>new W(new Float32Array(Q*4),4),[]),u=o.useMemo(()=>new W(new Float32Array(Q),1),[]),m=o.useMemo(()=>{const l=new K(a.accent);return{r:l.r,g:l.g,b:l.b}},[a.accent]);return o.useEffect(()=>{c.lifetimes.fill(0),n.current=0},[e,c]),X(()=>{if(!r||!i.current)return;const l=V.system;if(!l?.points||l.points.length<3)return;const x=l.points,f=Wt[e]??.1,v=x[x.length-1],P=x[x.length-3],y=(v.x-P.x)*f,S=(v.y-P.y)*f,g=(v.z-P.z)*f,p=Math.sqrt(y*y+S*S+g*g),T=Math.max(.01,p*2);for(let w=0;w<Ut;w++){const R=n.current,b=R*3;c.positions[b]=v.x*f,c.positions[b+1]=v.y*f,c.positions[b+2]=e==="doublePendulum"?0:v.z*f,c.velocities[b]=(Math.random()-.5)*T-y*.3,c.velocities[b+1]=(Math.random()-.5)*T-S*.3,c.velocities[b+2]=e==="doublePendulum"?(Math.random()-.5)*.02:(Math.random()-.5)*T-g*.3,c.lifetimes[R]=We,c.sizes[R]=(.5+Math.random()*1)*f*.5,n.current=(n.current+1)%Q}const A=d.array,j=h.array,k=u.array;for(let w=0;w<Q;w++){const R=w*3,b=w*4;if(c.lifetimes[w]<=0){A[R]=0,A[R+1]=0,A[R+2]=-1e3,j[b+3]=0,k[w]=0;continue}c.lifetimes[w]--,c.positions[R]+=c.velocities[R]*.016,c.positions[R+1]+=c.velocities[R+1]*.016,c.positions[R+2]+=c.velocities[R+2]*.016,c.velocities[R]*=Ae,c.velocities[R+1]*=Ae,c.velocities[R+2]*=Ae;const z=c.lifetimes[w]/We,N=z*z,E=.8+Math.sin(c.lifetimes[w]*.5+w*.7)*.2;A[R]=c.positions[R],A[R+1]=c.positions[R+1],A[R+2]=c.positions[R+2],j[b]=m.r*E,j[b+1]=m.g*E,j[b+2]=m.b*E,j[b+3]=N*E,k[w]=c.sizes[w]*(.3+z*.7)}d.needsUpdate=!0,h.needsUpdate=!0,u.needsUpdate=!0}),t.jsxs("points",{ref:i,children:[t.jsxs("bufferGeometry",{children:[t.jsx("primitive",{object:d,attach:"attributes-position"}),t.jsx("primitive",{object:h,attach:"attributes-color"}),t.jsx("primitive",{object:u,attach:"attributes-size"})]}),t.jsx("pointsMaterial",{vertexColors:!0,size:.04,transparent:!0,opacity:.9,depthWrite:!1,blending:J,sizeAttenuation:!0})]})},Xt={lorenz:.1,rossler:.5,doublePendulum:1},Yt=()=>{const{isPlaying:r,currentSystem:e,colorTheme:s,bloomEnabled:a}=I(),i=U[s],n=o.useRef(null),c=o.useRef(null),d=o.useRef(new G),h=o.useRef(0),u=o.useRef(0),m=o.useMemo(()=>new K(i.accent),[i.accent]),l=o.useMemo(()=>new K,[]),x=o.useMemo(()=>new K(1,1,1),[]);return X(()=>{if(!r||!n.current||!c.current)return;const f=V.system;if(!f?.points||f.points.length<3)return;const v=f.points,P=Xt[e]??.1,y=v[v.length-1],S=y.x*P,g=y.y*P,p=e==="doublePendulum"?.1:y.z*P,T=S-d.current.x,A=g-d.current.y,j=p-d.current.z,k=Math.sqrt(T*T+A*A+j*j);d.current.set(S,g,p),h.current+=(k-h.current)*.08;const w=a?.8:.3,R=Math.min(h.current*8,2),b=w+R;u.current+=(b-u.current)*.06,n.current.position.set(S,g,p),n.current.intensity=u.current,n.current.distance=3+h.current*10,c.current.position.set(S,g,p);const z=.03+h.current*.15;c.current.scale.setScalar(z);const N=Math.min(h.current*3,.6);l.copy(m).lerp(x,N),n.current.color.copy(l),c.current.material.color.copy(l)}),t.jsxs(t.Fragment,{children:[t.jsx("pointLight",{ref:n,intensity:.5,distance:5,decay:2,color:i.accent}),t.jsxs("mesh",{ref:c,children:[t.jsx("sphereGeometry",{args:[1,16,16]}),t.jsx("meshBasicMaterial",{color:i.accent,transparent:!0,opacity:.7,depthWrite:!1,blending:J})]})]})},Z=200,Kt={lorenz:.1,rossler:.5,doublePendulum:1},Zt=()=>{const{particleSwarm:r,isPlaying:e,speed:s,currentSystem:a,colorTheme:i,lorenzParams:n,rosslerParams:c,doublePendulumParams:d,_resetCounter:h}=I(),u=U[i],m=o.useRef(null),l=o.useMemo(()=>({systemState:new Float32Array(Z*4),prevX:new Float32Array(Z),prevY:new Float32Array(Z),prevZ:new Float32Array(Z),sizes:new Float32Array(Z),initialized:!1}),[]),x=o.useMemo(()=>new W(new Float32Array(Z*3),3),[]),f=o.useMemo(()=>new W(new Float32Array(Z*3),3),[]),v=o.useMemo(()=>new W(new Float32Array(Z),1),[]),P=o.useMemo(()=>{const g=new K(u.accent);return{r:g.r,g:g.g,b:g.b}},[u.accent]),y=o.useMemo(()=>{const g=new K(u.accent2);return{r:g.r,g:g.g,b:g.b}},[u.accent2]),S=()=>{for(let g=0;g<Z;g++){const p=g*4;a==="doublePendulum"?(l.systemState[p]=Math.PI/2+(Math.random()-.5)*.5,l.systemState[p+1]=Math.PI/2+(Math.random()-.5)*.5,l.systemState[p+2]=(Math.random()-.5)*1,l.systemState[p+3]=(Math.random()-.5)*1):a==="lorenz"?(l.systemState[p]=1+(Math.random()-.5)*4,l.systemState[p+1]=1+(Math.random()-.5)*4,l.systemState[p+2]=1+(Math.random()-.5)*4):(l.systemState[p]=1+(Math.random()-.5)*3,l.systemState[p+1]=1+(Math.random()-.5)*3,l.systemState[p+2]=.5+Math.random()*2),l.prevX[g]=l.systemState[p],l.prevY[g]=l.systemState[p+1],l.prevZ[g]=l.systemState[p+2],l.sizes[g]=.025+Math.random()*.025}l.initialized=!0};return o.useEffect(()=>{r?S():l.initialized=!1},[r,a,h]),X(()=>{if(!r||!e||!m.current||!l.initialized)return;const g=Kt[a]??.1,p=.01*s*.5,T=x.array,A=f.array,j=v.array;if(a==="lorenz"){const{sigma:k,rho:w,beta:R}=n;for(let b=0;b<Z;b++){const z=b*4,N=b*3;let E=l.systemState[z],M=l.systemState[z+1],F=l.systemState[z+2];const B=k*(M-E),O=E*(w-F)-M,$=E*M-R*F;E+=B*p,M+=O*p,F+=$*p,(!isFinite(E)||!isFinite(M)||!isFinite(F)||Math.abs(E)>1e6)&&(E=1+(Math.random()-.5)*4,M=1+(Math.random()-.5)*4,F=1+(Math.random()-.5)*4),l.systemState[z]=E,l.systemState[z+1]=M,l.systemState[z+2]=F,T[N]=E*g,T[N+1]=M*g,T[N+2]=F*g;const _=E-l.prevX[b],q=M-l.prevY[b],D=F-l.prevZ[b],H=Math.sqrt(_*_+q*q+D*D),L=Math.min(1,H*.15);A[N]=P.r*(1-L)+y.r*L,A[N+1]=P.g*(1-L)+y.g*L,A[N+2]=P.b*(1-L)+y.b*L,j[b]=l.sizes[b]*(.6+L*.4),l.prevX[b]=E,l.prevY[b]=M,l.prevZ[b]=F}}else if(a==="rossler"){const{a:k,b:w,c:R}=c;for(let b=0;b<Z;b++){const z=b*4,N=b*3;let E=l.systemState[z],M=l.systemState[z+1],F=l.systemState[z+2];const B=-M-F,O=E+k*M,$=w+F*(E-R);E+=B*p,M+=O*p,F+=$*p,(!isFinite(E)||!isFinite(M)||!isFinite(F)||Math.abs(E)>1e6)&&(E=1+(Math.random()-.5)*3,M=1+(Math.random()-.5)*3,F=.5+Math.random()*2),l.systemState[z]=E,l.systemState[z+1]=M,l.systemState[z+2]=F,T[N]=E*g,T[N+1]=M*g,T[N+2]=F*g;const _=E-l.prevX[b],q=M-l.prevY[b],D=F-l.prevZ[b],H=Math.sqrt(_*_+q*q+D*D),L=Math.min(1,H*.1);A[N]=P.r*(1-L)+y.r*L,A[N+1]=P.g*(1-L)+y.g*L,A[N+2]=P.b*(1-L)+y.b*L,j[b]=l.sizes[b]*(.6+L*.4),l.prevX[b]=E,l.prevY[b]=M,l.prevZ[b]=F}}else{const{mass1:k,mass2:w,length1:R,length2:b,gravity:z,damping:N}=d,E=k,M=w,F=R,B=b,O=z;for(let $=0;$<Z;$++){const _=$*4,q=$*3;let D=l.systemState[_],H=l.systemState[_+1],L=l.systemState[_+2],Y=l.systemState[_+3];const se=Math.cos(D-H),oe=Math.sin(D-H),ye=Math.sin(D),he=Math.sin(H),fe=(E+M)*F-M*F*se*se,ie=B/F*fe,Re=-M*F*L*L*oe*se+M*O*he*se+M*B*Y*Y*oe-(E+M)*O*ye,ge=-M*B*Y*Y*oe*se+(E+M)*O*ye*se+(E+M)*F*L*L*oe-(E+M)*O*he;let be=fe!==0?Re/fe:0,le=ie!==0?ge/ie:0;be-=N*L,le-=N*Y,D+=L*p,H+=Y*p,L+=be*p,Y+=le*p,(!isFinite(D)||!isFinite(L)||Math.abs(L)>1e6)&&(D=Math.PI/2+(Math.random()-.5)*.5,H=Math.PI/2+(Math.random()-.5)*.5,L=0,Y=0),l.systemState[_]=D,l.systemState[_+1]=H,l.systemState[_+2]=L,l.systemState[_+3]=Y;const xe=F*Math.sin(D)+B*Math.sin(H),ve=-F*Math.cos(D)-B*Math.cos(H);T[q]=xe*g,T[q+1]=ve*g,T[q+2]=0;const Te=Math.sqrt(L*L+Y*Y),ee=Math.min(1,Te*.15);A[q]=P.r*(1-ee)+y.r*ee,A[q+1]=P.g*(1-ee)+y.g*ee,A[q+2]=P.b*(1-ee)+y.b*ee,j[$]=l.sizes[$]*(.6+ee*.4),l.prevX[$]=xe,l.prevY[$]=ve,l.prevZ[$]=0}}x.needsUpdate=!0,f.needsUpdate=!0,v.needsUpdate=!0}),r?t.jsxs("points",{ref:m,children:[t.jsxs("bufferGeometry",{children:[t.jsx("primitive",{object:x,attach:"attributes-position"}),t.jsx("primitive",{object:f,attach:"attributes-color"}),t.jsx("primitive",{object:v,attach:"attributes-size"})]}),t.jsx("pointsMaterial",{vertexColors:!0,size:.04,transparent:!0,opacity:.75,depthWrite:!1,blending:J,sizeAttenuation:!0})]}):null},Ve=6e3,Jt=({ghost:r,index:e,total:s})=>{const a=o.useRef(null);o.useEffect(()=>{if(!a.current)return;const n=new Float32Array(Ve*3),c=new Float32Array(Ve*3);n.set(r.positions.subarray(0,r.count*3));const d=.3+(e+1)/s*.4,h=new K;for(let u=0;u<r.count;u++){const m=r.count>1?u/(r.count-1):1,l=m*m*d,x=(r.hue+m*.08)%1;h.setHSL(x,.4,.15+l*.25);const f=u*3;c[f]=h.r*l,c[f+1]=h.g*l,c[f+2]=h.b*l}a.current.setAttribute("position",new W(n,3)),a.current.setAttribute("color",new W(c,3)),a.current.setDrawRange(0,r.count)},[r,e,s]);const i=o.useMemo(()=>new Ie({vertexColors:!0,transparent:!0,opacity:.5,depthWrite:!1,blending:J}),[]);return t.jsxs("primitive",{object:new Me,children:[t.jsx("bufferGeometry",{ref:a}),t.jsx("primitive",{object:i,attach:"material"})]})},Qt=()=>{const r=I(s=>s._ghostVersion),e=Mt();return e.length===0?null:t.jsx(t.Fragment,{children:e.map((s,a)=>t.jsx(Jt,{ghost:s,index:a,total:e.length},`ghost-${r}-${a}`))})},de=4e3,es={lorenz:.1,rossler:.5,doublePendulum:1},ts={lorenz:-.5,rossler:-6},ss=()=>{const{showFloorShadow:r,currentSystem:e,colorTheme:s}=I(),a=U[s],i=o.useRef(null),n=o.useMemo(()=>({positions:new Float32Array(de*3),colors:new Float32Array(de*3)}),[]),c=o.useMemo(()=>{const d=new K(a.accent);return{r:d.r*.3,g:d.g*.3,b:d.b*.3}},[a.accent]);return o.useMemo(()=>{},[]),X(()=>{if(!r||!i.current)return;if(e==="doublePendulum"){i.current.setDrawRange(0,0);return}const d=V.system;if(!d?.points||d.points.length<2){i.current.setDrawRange(0,0);return}const h=d.points,u=es[e]??.1,m=ts[e]??-3,l=Math.min(h.length,de),x=Math.max(0,h.length-de),{positions:f,colors:v}=n;for(let S=0;S<l;S++){const g=h[x+S],p=S*3;f[p]=g.x*u,f[p+1]=m,f[p+2]=g.z*u;const T=l>1?S/(l-1):1,A=T*T*.6;v[p]=c.r*A,v[p+1]=c.g*A,v[p+2]=c.b*A}let P=i.current.getAttribute("position"),y=i.current.getAttribute("color");P||(P=new W(new Float32Array(de*3),3),i.current.setAttribute("position",P)),y||(y=new W(new Float32Array(de*3),3),i.current.setAttribute("color",y)),P.array.set(f.subarray(0,l*3)),y.array.set(v.subarray(0,l*3)),P.needsUpdate=!0,y.needsUpdate=!0,i.current.setDrawRange(0,l)}),!r||e==="doublePendulum"?null:t.jsxs("primitive",{object:new Me,children:[t.jsx("bufferGeometry",{ref:i}),t.jsx("lineBasicMaterial",{vertexColors:!0,transparent:!0,opacity:.4,depthWrite:!1,blending:J})]})},me=15e3,rs=2,as={lorenz:.1,rossler:.5,doublePendulum:1},ns=()=>{const{exposureMode:r,isPlaying:e,currentSystem:s,colorTheme:a,_exposureClearCounter:i}=I(),n=U[a],c=o.useRef(null),d=o.useRef(0),h=o.useRef(0),u=o.useRef(0),m=o.useMemo(()=>new W(new Float32Array(me*3),3),[]),l=o.useMemo(()=>new W(new Float32Array(me*3),3),[]),x=o.useMemo(()=>new W(new Float32Array(me),1),[]),f=o.useMemo(()=>({h:n.trailHue1,s:.7,l:.5}),[n.trailHue1]),v=o.useMemo(()=>new K,[]);return o.useEffect(()=>{const P=m.array,y=l.array,S=x.array;for(let g=0;g<me;g++){const p=g*3;P[p]=0,P[p+1]=0,P[p+2]=-1e3,y[p]=0,y[p+1]=0,y[p+2]=0,S[g]=0}m.needsUpdate=!0,l.needsUpdate=!0,x.needsUpdate=!0,d.current=0,u.current=0,h.current=0},[s,r,i,m,l,x]),X(()=>{if(!r||!e||!c.current||(h.current++,h.current%rs!==0))return;const P=V.system;if(!P?.points||P.points.length<2)return;const y=P.points,S=as[s]??.1,g=y[y.length-1],p=s==="doublePendulum",T=y[Math.max(0,y.length-3)],A=g.x-T.x,j=g.y-T.y,k=g.z-T.z,w=Math.sqrt(A*A+j*j+k*k),R=d.current,b=R*3,z=m.array,N=l.array,E=x.array;z[b]=g.x*S,z[b+1]=g.y*S,z[b+2]=p?0:g.z*S;const M=Math.min(w*.3,.15),F=(f.h+M)%1;v.setHSL(F,f.s,f.l),N[b]=v.r,N[b+1]=v.g,N[b+2]=v.b,E[R]=.015+Math.random()*.01,m.needsUpdate=!0,l.needsUpdate=!0,x.needsUpdate=!0,d.current=(d.current+1)%me,u.current++;const B=Math.min(u.current,me);c.current.geometry&&c.current.geometry.setDrawRange(0,B)}),r?t.jsxs("points",{ref:c,children:[t.jsxs("bufferGeometry",{children:[t.jsx("primitive",{object:m,attach:"attributes-position"}),t.jsx("primitive",{object:l,attach:"attributes-color"}),t.jsx("primitive",{object:x,attach:"attributes-size"})]}),t.jsx("pointsMaterial",{vertexColors:!0,size:.02,transparent:!0,opacity:.6,depthWrite:!1,blending:J,sizeAttenuation:!0})]}):null},ce=60,Xe=22,os=33,is=()=>{const r=o.useRef(new Float32Array(ce)),e=o.useRef(0),s=o.useRef(0),a=o.useRef(!1),i=o.useRef(!1),n=o.useRef(0);return X(({clock:c})=>{const d=c.getElapsedTime()*1e3;if(s.current>0){const l=d-s.current;r.current[e.current%ce]=l,e.current++,n.current=Math.min(n.current+1,ce)}if(s.current=d,e.current%ce!==0||n.current<ce)return;let h=0;for(let l=0;l<ce;l++)h+=r.current[l];const u=h/ce,m=I.getState();u>os&&!i.current&&(i.current=!0,m.particleSwarm&&I.setState({particleSwarm:!1}),m.trailLength>1500&&I.setState({trailLength:1e3}),m.showPerformanceWarning||I.setState({showPerformanceWarning:!0})),u>Xe&&!a.current&&(a.current=!0,m.showPerformanceWarning||I.setState({showPerformanceWarning:!0})),u<Xe*.8&&a.current&&(a.current=!1,i.current=!1,m.showPerformanceWarning&&I.setState({showPerformanceWarning:!1}))}),null},Ye={lorenz:{position:[10,10,10],fov:60},rossler:{position:[8,8,8],fov:60},doublePendulum:{position:[0,0,5],fov:50}},ls=()=>{const{autoRotate:r,currentSystem:e,cinematicCamera:s}=I();return s?null:t.jsx(pt,{enablePan:!0,enableZoom:!0,enableRotate:!0,autoRotate:r&&e!=="doublePendulum",autoRotateSpeed:2,maxPolarAngle:Math.PI,minDistance:2,maxDistance:20})},cs=({posA:r,posB:e})=>{const{setDivergence:s,sideBySideMode:a}=I(),i=o.useRef(0);return X(()=>{if(!a||(i.current++,i.current%6!==0))return;const n=r.current,c=e.current;n&&c&&s(n.distanceTo(c))}),null},ke=({position:r=[0,0,0],initialCondition:e,colorHue:s=.6,isSecondary:a=!1,lastPosRef:i})=>{const{currentSystem:n}=I();switch(n){case"lorenz":return t.jsx(Rt,{position:r,initialCondition:e||[1,1,1],colorHue:s,isSecondary:a,lastPosRef:i});case"rossler":return t.jsx(Ct,{position:r,initialCondition:e||[1,1,1],colorHue:s,isSecondary:a,lastPosRef:i});case"doublePendulum":return t.jsx(At,{position:r,initialCondition:e||{theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0},colorHue:s,isSecondary:a,lastPosRef:i});default:return null}},us=()=>{const{bloomEnabled:r,bloomIntensity:e,isPlaying:s}=I(),a=o.useRef(null),i=o.useRef(e);return X(()=>{if(!r||!a.current)return;if(!s){a.current.intensity=e;return}const n=V.system;if(!n?.points||n.points.length<5){a.current.intensity=e;return}const c=n.points,d=c[c.length-1],h=c[c.length-4],u=d.x-h.x,m=d.y-h.y,l=d.z-h.z,x=Math.sqrt(u*u+m*m+l*l),f=1+Math.min(x*.02,.3),v=e*f;i.current+=(v-i.current)*.05,a.current.intensity=i.current}),r?t.jsx(ft,{children:t.jsx(gt,{ref:a,intensity:e,luminanceThreshold:.1,luminanceSmoothing:.9,mipmapBlur:!0})}):null},hs=()=>{const{sideBySideMode:r,currentSystem:e,initialOffset:s,colorTheme:a}=I(),i=U[a],n=o.useRef(null),c=o.useRef(null);return t.jsxs(t.Fragment,{children:[t.jsx("ambientLight",{intensity:.2}),t.jsx("directionalLight",{position:[10,10,5],intensity:.3}),t.jsx(zt,{}),e==="doublePendulum"&&t.jsx(mt,{args:[10,10],position:[0,-3,0],cellColor:"#222233",sectionColor:"#333355",fadeDistance:25,fadeStrength:1}),r?t.jsxs(t.Fragment,{children:[t.jsx(ke,{position:[0,0,0],initialCondition:e==="doublePendulum"?{theta1:Math.PI/2,theta2:Math.PI/2,omega1:0,omega2:0}:[1,1,1],colorHue:i.trailHue1,isSecondary:!1,lastPosRef:n}),t.jsx(ke,{position:[0,0,0],initialCondition:e==="doublePendulum"?{theta1:Math.PI/2+s,theta2:Math.PI/2,omega1:0,omega2:0}:[1+s,1,1],colorHue:i.trailHue2,isSecondary:!0,lastPosRef:c}),t.jsx(cs,{posA:n,posB:c})]}):t.jsx(ke,{}),t.jsx(ls,{}),t.jsx(Bt,{}),t.jsx(Ht,{}),t.jsx(Vt,{}),t.jsx(Qt,{}),t.jsx(ss,{}),t.jsx(ns,{}),t.jsx(Yt,{}),t.jsx(Zt,{}),t.jsx(us,{}),t.jsx(is,{})]})};class ds extends o.Component{state={hasError:!1,error:null};static getDerivedStateFromError(e){return{hasError:!0,error:e}}handleRetry=()=>{this.setState({hasError:!1,error:null})};render(){return this.state.hasError?t.jsxs("div",{style:{width:"100vw",height:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:"#000010",color:"#ccc",fontFamily:"system-ui, sans-serif",textAlign:"center",padding:"2rem"},children:[t.jsx("h2",{style:{color:"#ff6666",marginBottom:"1rem"},children:"âš ï¸ Rendering Error"}),t.jsx("p",{style:{maxWidth:"400px",lineHeight:1.6,marginBottom:"1rem"},children:"The 3D visualization encountered an error. This can happen if WebGL is not available or if GPU resources were exhausted."}),t.jsx("code",{style:{background:"rgba(255,255,255,0.05)",padding:"8px 16px",borderRadius:"6px",fontSize:"12px",color:"#ff9999",marginBottom:"1.5rem",maxWidth:"80vw",overflow:"auto"},children:this.state.error?.message||"Unknown error"}),t.jsx("button",{onClick:this.handleRetry,style:{padding:"12px 24px",background:"#88ccff",color:"#000",border:"none",borderRadius:"8px",fontSize:"14px",fontWeight:600,cursor:"pointer"},children:"ðŸ”„ Retry"})]}):this.props.children}}const ms=()=>{const{currentSystem:r,colorTheme:e}=I(),s=U[e],a=Ye[r]??Ye.lorenz;return t.jsx(ds,{children:t.jsx("div",{style:{width:"100vw",height:"100vh",background:s.bg},role:"img","aria-label":`3D visualization of ${r==="lorenz"?"Lorenz attractor":r==="rossler"?"RÃ¶ssler attractor":"double pendulum"} chaos system`,children:t.jsxs(dt,{camera:{position:a.position,fov:a.fov},dpr:[1,2],gl:{antialias:!0,alpha:!0,powerPreference:"high-performance"},performance:{min:.5},children:[t.jsx("color",{attach:"background",args:[s.bg]}),t.jsx("fog",{attach:"fog",args:[s.bg,30,60]}),t.jsx(o.Suspense,{fallback:null,children:t.jsx(hs,{})})]})})})},ps={classic:"ðŸŒŒ Classic",neon:"ðŸ’œ Neon",blueprint:"ðŸ“ Blueprint",terminal:"ðŸ’» Terminal"},fs={lorenz:"ðŸ¦‹ Lorenz",rossler:"ðŸŒ€ RÃ¶ssler",doublePendulum:"âš¡ Pendulum"},gs=()=>{const[r,e]=o.useState(!1),[s,a]=o.useState(!1);o.useEffect(()=>{const C=()=>a(window.innerWidth<=768);return C(),window.addEventListener("resize",C),()=>window.removeEventListener("resize",C)},[]);const{currentSystem:i,setCurrentSystem:n,isPlaying:c,setIsPlaying:d,speed:h,setSpeed:u,trailLength:m,setTrailLength:l,sideBySideMode:x,setSideBySideMode:f,initialOffset:v,setInitialOffset:P,autoRotate:y,setAutoRotate:S,currentPreset:g,setCurrentPreset:p,colorTheme:T,setColorTheme:A,lorenzParams:j,setLorenzParams:k,rosslerParams:w,setRosslerParams:R,doublePendulumParams:b,setDoublePendulumParams:z,resetSimulation:N,showLyapunov:E,setShowLyapunov:M,showBifurcation:F,setShowBifurcation:B,showPoincare:O,setShowPoincare:$,showParameterSpace:_,setShowParameterSpace:q,cinematicCamera:D,setCinematicCamera:H,chaosAutopilot:L,setChaosAutopilot:Y,setStoryMode:se,bloomEnabled:oe,setBloomEnabled:ye,bloomIntensity:he,setBloomIntensity:fe,audioEnabled:ie,setAudioEnabled:Re,audioVolume:ge,setAudioVolume:be,particleSwarm:le,setParticleSwarm:xe,perturbSystem:ve,captureGhost:Te,clearGhosts:ee,_ghostVersion:et,showFloorShadow:Se,setShowFloorShadow:tt,exposureMode:we,setExposureMode:st,clearExposure:rt}=I(),re=U[T],at=C=>{const je=He[i].find(it=>it.name===C);if(je){switch(i){case"lorenz":k(je.params);break;case"rossler":R(je.params);break;case"doublePendulum":z(je.params);break}p(C)}},nt=C=>{n(C),p(null)},qe=C=>C>=.01?C.toFixed(3):C.toExponential(1),ot=()=>{switch(i){case"lorenz":return t.jsxs("div",{className:"parameter-group",role:"group","aria-label":"Lorenz system parameters",children:[t.jsx("h4",{children:"Lorenz Parameters"}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"sigma-slider",children:["Ïƒ (sigma): ",j.sigma.toFixed(2)]}),t.jsx("input",{id:"sigma-slider",type:"range",min:"0.1",max:"30",step:"0.1",value:j.sigma,"aria-valuemin":.1,"aria-valuemax":30,"aria-valuenow":j.sigma,"aria-label":`Sigma: ${j.sigma.toFixed(2)}`,onChange:C=>k({sigma:parseFloat(C.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"rho-slider",children:["Ï (rho): ",j.rho.toFixed(2)]}),t.jsx("input",{id:"rho-slider",type:"range",min:"0.1",max:"50",step:"0.1",value:j.rho,"aria-valuemin":.1,"aria-valuemax":50,"aria-valuenow":j.rho,"aria-label":`Rho: ${j.rho.toFixed(2)}`,onChange:C=>k({rho:parseFloat(C.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"beta-slider",children:["Î² (beta): ",j.beta.toFixed(3)]}),t.jsx("input",{id:"beta-slider",type:"range",min:"0.1",max:"10",step:"0.01",value:j.beta,"aria-valuemin":.1,"aria-valuemax":10,"aria-valuenow":j.beta,"aria-label":`Beta: ${j.beta.toFixed(3)}`,onChange:C=>k({beta:parseFloat(C.target.value)})})]})]});case"rossler":return t.jsxs("div",{className:"parameter-group",role:"group","aria-label":"RÃ¶ssler system parameters",children:[t.jsx("h4",{children:"RÃ¶ssler Parameters"}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"a-slider",children:["a: ",w.a.toFixed(3)]}),t.jsx("input",{id:"a-slider",type:"range",min:"0.01",max:"1.0",step:"0.01",value:w.a,"aria-label":`Parameter a: ${w.a.toFixed(3)}`,onChange:C=>R({a:parseFloat(C.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"b-slider",children:["b: ",w.b.toFixed(3)]}),t.jsx("input",{id:"b-slider",type:"range",min:"0.01",max:"1.0",step:"0.01",value:w.b,"aria-label":`Parameter b: ${w.b.toFixed(3)}`,onChange:C=>R({b:parseFloat(C.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"c-slider",children:["c: ",w.c.toFixed(2)]}),t.jsx("input",{id:"c-slider",type:"range",min:"1.0",max:"20.0",step:"0.1",value:w.c,"aria-label":`Parameter c: ${w.c.toFixed(2)}`,onChange:C=>R({c:parseFloat(C.target.value)})})]})]});case"doublePendulum":return t.jsxs("div",{className:"parameter-group",role:"group","aria-label":"Double pendulum parameters",children:[t.jsx("h4",{children:"Pendulum Parameters"}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"mass1-slider",children:["Mass 1: ",b.mass1.toFixed(2)]}),t.jsx("input",{id:"mass1-slider",type:"range",min:"0.1",max:"5.0",step:"0.1",value:b.mass1,"aria-label":`Mass 1: ${b.mass1.toFixed(2)}`,onChange:C=>z({mass1:parseFloat(C.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"mass2-slider",children:["Mass 2: ",b.mass2.toFixed(2)]}),t.jsx("input",{id:"mass2-slider",type:"range",min:"0.1",max:"5.0",step:"0.1",value:b.mass2,"aria-label":`Mass 2: ${b.mass2.toFixed(2)}`,onChange:C=>z({mass2:parseFloat(C.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"len1-slider",children:["Length 1: ",b.length1.toFixed(2)]}),t.jsx("input",{id:"len1-slider",type:"range",min:"0.2",max:"2.0",step:"0.1",value:b.length1,"aria-label":`Length 1: ${b.length1.toFixed(2)}`,onChange:C=>z({length1:parseFloat(C.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"len2-slider",children:["Length 2: ",b.length2.toFixed(2)]}),t.jsx("input",{id:"len2-slider",type:"range",min:"0.2",max:"2.0",step:"0.1",value:b.length2,"aria-label":`Length 2: ${b.length2.toFixed(2)}`,onChange:C=>z({length2:parseFloat(C.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"gravity-slider",children:["Gravity: ",b.gravity.toFixed(2)]}),t.jsx("input",{id:"gravity-slider",type:"range",min:"1.0",max:"20.0",step:"0.1",value:b.gravity,"aria-label":`Gravity: ${b.gravity.toFixed(2)}`,onChange:C=>z({gravity:parseFloat(C.target.value)})})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"damping-slider",children:["Damping: ",b.damping.toFixed(3)]}),t.jsx("input",{id:"damping-slider",type:"range",min:"0.0",max:"0.2",step:"0.005",value:b.damping,"aria-label":`Damping: ${b.damping.toFixed(3)}`,onChange:C=>z({damping:parseFloat(C.target.value)})})]})]});default:return null}};return t.jsxs("aside",{className:`controls ${r?"collapsed":""} ${s?"mobile":""}`,role:"region","aria-label":"Simulation controls",style:{"--panel-bg":re.panelBg,"--panel-border":re.panelBorder,"--text-color":re.text,"--text-muted":re.textMuted,"--accent":re.accent,"--accent2":re.accent2,"--heading":re.heading,"--param-color":re.paramColor},children:[t.jsx("button",{className:"controls-toggle",onClick:()=>e(!r),"aria-label":r?"Show controls":"Hide controls","aria-expanded":!r,children:r?"âš™ï¸":"âœ•"}),!r&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{id:"system-heading",children:"Chaos System"}),t.jsx("div",{className:"system-tabs",role:"tablist","aria-labelledby":"system-heading",children:["lorenz","rossler","doublePendulum"].map(C=>t.jsx("button",{role:"tab","aria-selected":i===C,"aria-label":`Select ${C==="doublePendulum"?"Double Pendulum":C} system`,className:`system-tab ${i===C?"active":""}`,onClick:()=>nt(C),children:fs[C]},C))})]}),t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{children:"Simulation"}),t.jsxs("div",{className:"button-group",children:[t.jsx("button",{onClick:()=>d(!c),className:`play-button ${c?"playing":"paused"}`,"aria-label":c?"Pause simulation":"Play simulation",children:c?"â¸ Pause":"â–¶ Play"}),t.jsx("button",{onClick:N,className:"reset-button","aria-label":"Reset simulation",children:"ðŸ”„ Reset"})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"speed-slider",children:["Speed: ",h.toFixed(1),"x"]}),t.jsx("input",{id:"speed-slider",type:"range",min:"0.1",max:"5.0",step:"0.1",value:h,"aria-label":`Simulation speed: ${h.toFixed(1)}x`,onChange:C=>u(parseFloat(C.target.value))})]}),t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"trail-slider",children:["Trail: ",m,m>3e3&&t.jsx("span",{className:"warn",children:" âš ï¸ High"})]}),t.jsx("input",{id:"trail-slider",type:"range",min:"100",max:"5000",step:"100",value:m,"aria-label":`Trail length: ${m} points`,onChange:C=>l(parseInt(C.target.value))})]})]}),t.jsxs("div",{className:"control-section butterfly-section",children:[t.jsx("h3",{children:"ðŸ¦‹ Butterfly Effect"}),t.jsx("div",{className:"checkbox-group",children:t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:x,"aria-label":"Enable butterfly mode: show two systems with tiny initial difference",onChange:C=>{f(C.target.checked),C.target.checked&&N()}}),"Enable Butterfly Mode"]})}),x&&t.jsxs("div",{className:"slider-group offset-slider",children:[t.jsxs("label",{htmlFor:"offset-slider",children:["Initial Offset: ",t.jsx("span",{className:"offset-value",children:qe(v)})]}),t.jsx("input",{id:"offset-slider",type:"range",min:"-6",max:"-0.5",step:"0.1",value:Math.log10(v),"aria-label":`Initial offset between systems: ${qe(v)}`,onChange:C=>{P(Math.pow(10,parseFloat(C.target.value))),N()}}),t.jsxs("div",{className:"offset-labels","aria-hidden":"true",children:[t.jsx("span",{children:"Tiny"}),t.jsx("span",{children:"Large"})]})]})]}),t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{children:"View"}),i!=="doublePendulum"&&t.jsx("div",{className:"checkbox-group",children:t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:y,"aria-label":"Auto-rotate camera around the attractor",onChange:C=>S(C.target.checked)}),"Auto Rotate"]})}),t.jsx("div",{className:"checkbox-group",children:t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:oe,"aria-label":"Toggle bloom glow post-processing effect",onChange:C=>ye(C.target.checked)}),"âœ¨ Bloom Glow"]})}),oe&&t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"bloom-intensity",children:["Bloom: ",he.toFixed(1)]}),t.jsx("input",{id:"bloom-intensity",type:"range",min:"0.2",max:"4.0",step:"0.1",value:he,"aria-label":`Bloom intensity: ${he.toFixed(1)}`,onChange:C=>fe(parseFloat(C.target.value))})]})]}),t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{children:"âœ¨ Experience"}),t.jsxs("div",{className:"experience-buttons",children:[t.jsx("button",{className:`experience-btn cinematic ${D?"active":""}`,onClick:()=>H(!D),"aria-pressed":D,"aria-label":"Toggle cinematic chase camera that follows the trail",children:"ðŸŽ¬ Chase Cam"}),t.jsx("button",{className:`experience-btn autopilot ${L?"active":""}`,onClick:()=>Y(!L),"aria-pressed":L,"aria-label":"Toggle chaos autopilot that morphs parameters automatically",children:"ðŸ¤– Autopilot"}),t.jsx("button",{className:`experience-btn audio ${ie?"active":""}`,onClick:()=>Re(!ie),"aria-pressed":ie,"aria-label":"Toggle chaos sonification â€” hear the attractor as sound",children:"ðŸ”Š Sonify"}),t.jsx("button",{className:`experience-btn swarm ${le?"active":""}`,onClick:()=>xe(!le),"aria-pressed":le,"aria-label":"Toggle particle swarm â€” 200 particles trace the attractor simultaneously",children:"ðŸ¦ Particle Swarm"}),t.jsx("button",{className:"experience-btn perturb",onClick:ve,"aria-label":"Apply random perturbation â€” nudge the system to see chaos in action",children:"âš¡ Perturb"}),t.jsx("button",{className:`experience-btn exposure ${we?"active":""}`,onClick:()=>st(!we),"aria-pressed":we,"aria-label":"Toggle exposure mode â€” long-exposure point cloud accumulation",children:"ðŸ“· Exposure"}),t.jsx("button",{className:`experience-btn shadow ${Se?"active":""}`,onClick:()=>tt(!Se),"aria-pressed":Se,"aria-label":"Toggle floor shadow â€” 2D projection beneath the attractor",children:"ðŸªž Shadow"}),t.jsx("button",{className:"experience-btn ghost-capture",onClick:Te,"aria-label":"Capture ghost â€” freeze current trail as a translucent hologram",children:"ðŸ“¸ Capture"}),t.jsx("button",{className:"experience-btn story",onClick:()=>{se(!0),S(!0)},"aria-label":"Launch guided story mode tour",children:"ðŸ“– Story Mode"})]}),ie&&t.jsxs("div",{className:"audio-controls",children:[t.jsxs("div",{className:"slider-group",children:[t.jsxs("label",{htmlFor:"audio-volume",children:["Volume: ",Math.round(ge*100),"%"]}),t.jsx("input",{id:"audio-volume",type:"range",min:"0",max:"1",step:"0.05",value:ge,"aria-label":`Audio volume: ${Math.round(ge*100)}%`,onChange:C=>be(parseFloat(C.target.value))})]}),t.jsx("div",{className:"autopilot-hint",children:"ðŸŽµ Listening to chaos â€” pitch follows position, volume follows velocity"})]}),L&&t.jsx("div",{className:"autopilot-hint",children:"Parameters are morphing through interesting regions..."}),D&&t.jsx("div",{className:"autopilot-hint",children:"Camera is following the trail head. Orbit controls disabled."}),le&&t.jsx("div",{className:"autopilot-hint",children:"ðŸ¦ 200 particles are swarming through the attractor..."}),we&&t.jsxs("div",{className:"autopilot-hint",children:["ðŸ“· Accumulating points... Press E to toggle, Shift+E to clear",t.jsx("button",{className:"hint-action-btn",onClick:rt,"aria-label":"Clear exposure cloud",children:"Clear"})]}),et>0&&Ce()>0&&t.jsxs("div",{className:"autopilot-hint",children:["ðŸ“¸ ",Ce()," ghost",Ce()!==1?"s":""," captured (F to add, Shift+F to clear)",t.jsx("button",{className:"hint-action-btn",onClick:ee,"aria-label":"Clear all ghost trails",children:"Clear"})]}),Se&&i!=="doublePendulum"&&t.jsx("div",{className:"autopilot-hint",children:"ðŸªž Showing 2D shadow projection below the attractor"})]}),t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{id:"theme-heading",children:"Theme"}),t.jsx("div",{className:"theme-grid",role:"radiogroup","aria-labelledby":"theme-heading",children:Object.keys(U).map(C=>t.jsx("button",{role:"radio","aria-checked":T===C,"aria-label":`${C} theme`,className:`theme-btn ${T===C?"active":""}`,onClick:()=>A(C),style:{"--tbg":U[C].bg,"--taccent":U[C].accent},children:ps[C]},C))})]}),t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{children:"Presets"}),t.jsx("div",{className:"preset-chips",role:"group","aria-label":"Parameter presets",children:He[i].map(C=>t.jsx("button",{className:`preset-chip ${g===C.name?"active":""}`,onClick:()=>at(C.name),"aria-label":`${C.name}: ${C.description}`,"aria-pressed":g===C.name,children:C.name},C.name))})]}),ot(),i!=="doublePendulum"&&t.jsxs("div",{className:"control-section",children:[t.jsx("h3",{children:"ðŸ”¬ Analysis"}),t.jsxs("div",{className:"analysis-buttons",children:[t.jsx("button",{className:`analysis-btn ${E?"active":""}`,onClick:()=>M(!E),"aria-pressed":E,"aria-label":"Toggle Lyapunov exponent indicator",children:"Î» Lyapunov"}),t.jsx("button",{className:`analysis-btn ${F?"active":""}`,onClick:()=>B(!F),"aria-pressed":F,"aria-label":"Toggle bifurcation diagram",children:"ðŸ“ˆ Bifurcation"}),t.jsx("button",{className:`analysis-btn ${O?"active":""}`,onClick:()=>$(!O),"aria-pressed":O,"aria-label":"Toggle PoincarÃ© section",children:"â—Ž PoincarÃ©"}),t.jsx("button",{className:`analysis-btn ${_?"active":""}`,onClick:()=>q(!_),"aria-pressed":_,"aria-label":"Toggle parameter space explorer",children:"ðŸ—ºï¸ Param Space"})]})]})]})]})},ys={lorenz:{title:"Lorenz Attractor",description:"The Lorenz attractor is a set of chaotic solutions of the Lorenz system, discovered by Edward Lorenz in 1963. It arises from a simplified model of atmospheric convection.",equations:["dx/dt = Ïƒ(y - x)","dy/dt = x(Ï - z) - y","dz/dt = xy - Î²z"],whatMakesChaotic:'The system is chaotic because small changes in initial conditions lead to drastically different outcomes over time. This is the famous "butterfly effect" â€” a butterfly flapping its wings in Brazil could theoretically cause a tornado in Texas.',parameters:{"Ïƒ (sigma)":"Prandtl number â€” relates viscosity to thermal conductivity","Ï (rho)":"Rayleigh number â€” measures temperature difference","Î² (beta)":"Geometric factor related to the size of convection cells"}},rossler:{title:"RÃ¶ssler Attractor",description:"The RÃ¶ssler attractor is another chaotic system, developed by Otto RÃ¶ssler in 1976. It was designed to be simpler than the Lorenz system while still exhibiting chaotic behavior.",equations:["dx/dt = -y - z","dy/dt = x + ay","dz/dt = b + z(x - c)"],whatMakesChaotic:"The RÃ¶ssler system shows how even simple nonlinear equations can produce chaos. The attractor has a characteristic spiral structure that folds back on itself, creating sensitive dependence on initial conditions.",parameters:{a:"Controls the rate of expansion in the y direction",b:"Constant term that affects the z component",c:"Controls the folding and stretching of the attractor"}},doublePendulum:{title:"Double Pendulum",description:"A double pendulum consists of two pendulums attached end to end. Despite being a deterministic system governed by well-known physical laws, it exhibits chaotic motion.",equations:["Complex coupled differential equations","involving angles Î¸â‚, Î¸â‚‚ and their","angular velocities Ï‰â‚, Ï‰â‚‚"],whatMakesChaotic:"The chaos arises from the nonlinear coupling between the two pendulums. Small changes in the initial angles or velocities can lead to completely different trajectories. This demonstrates that chaos can emerge from simple, everyday systems.",parameters:{"Mass 1, Mass 2":"Masses of the first and second pendulum bobs","Length 1, Length 2":"Lengths of the first and second pendulum arms",Gravity:"Gravitational acceleration",Damping:"Energy loss due to friction (0 = no damping)"}}},bs=()=>{const{currentSystem:r,showInfoPanel:e,setShowInfoPanel:s}=I();if(!e)return t.jsx("button",{className:"info-toggle collapsed",onClick:()=>s(!0),"aria-label":"Show system information panel",children:"â„¹ï¸"});const a=ys[r];return t.jsxs("aside",{className:"info-panel",role:"complementary","aria-label":"System information",children:[t.jsxs("div",{className:"info-header",children:[t.jsx("h2",{children:a.title}),t.jsx("button",{className:"info-close",onClick:()=>s(!1),"aria-label":"Close information panel",children:"âœ•"})]}),t.jsxs("div",{className:"info-content",children:[t.jsxs("section",{"aria-labelledby":"info-overview",children:[t.jsx("h3",{id:"info-overview",children:"Overview"}),t.jsx("p",{children:a.description})]}),t.jsxs("section",{"aria-labelledby":"info-equations",children:[t.jsx("h3",{id:"info-equations",children:"Equations"}),t.jsx("div",{className:"equations",role:"math","aria-label":"System equations",children:a.equations.map((i,n)=>t.jsx("div",{className:"equation",children:i},n))})]}),t.jsxs("section",{"aria-labelledby":"info-chaos",children:[t.jsx("h3",{id:"info-chaos",children:"What Makes It Chaotic?"}),t.jsx("p",{children:a.whatMakesChaotic})]}),t.jsxs("section",{"aria-labelledby":"info-params",children:[t.jsx("h3",{id:"info-params",children:"Parameters"}),t.jsx("dl",{className:"parameters",children:Object.entries(a.parameters).map(([i,n])=>t.jsxs("div",{className:"parameter",children:[t.jsx("dt",{children:t.jsx("strong",{children:i})}),t.jsx("dd",{children:n})]},i))})]}),t.jsxs("section",{"aria-labelledby":"info-tips",children:[t.jsx("h3",{id:"info-tips",children:"Tips"}),t.jsxs("ul",{children:[t.jsx("li",{children:"Try the side-by-side mode to see how small changes create big differences"}),t.jsx("li",{children:"Experiment with different presets to explore various behaviors"}),t.jsx("li",{children:"Adjust the trail length to see more or less of the trajectory"}),t.jsx("li",{children:"Use the speed control to slow down and observe the motion closely"})]})]})]})]})},ue=[{title:"Welcome to Chaos Lab! ðŸ¦‹",description:"Explore the beautiful world of chaos theory through interactive visualizations. Watch as simple equations create complex, unpredictable patterns."},{title:"Try Side-by-Side Mode",description:"Enable 'Butterfly Mode' to see the butterfly effect in action. Two systems with tiny differences will evolve completely differently!",highlight:"side-by-side"},{title:"Experiment with Parameters",description:"Adjust the sliders to see how small changes in parameters can dramatically alter the behavior. Try the preset configurations for interesting starting points.",highlight:"parameters"},{title:"Explore Different Systems",description:"Switch between Lorenz Attractor, RÃ¶ssler Attractor, and Double Pendulum to see different types of chaotic behavior.",highlight:"systems"},{title:"Hear the Chaos ðŸ”Š",description:"Press M or click 'Sonify' to hear the chaos as sound! The pitch follows the attractor's position and the volume pulses with its velocity. Best with headphones.",highlight:"audio"},{title:"Learn More",description:"Click the info button (â„¹ï¸) to learn about the mathematics and physics behind each system. Ready to explore chaos?",highlight:"info"}],xs=()=>{const[r,e]=o.useState(!1),[s,a]=o.useState(0),{setSideBySideMode:i,setShowInfoPanel:n}=I(),c=o.useRef(null);o.useEffect(()=>{localStorage.getItem("chaosLabTutorial")||e(!0)},[]),o.useEffect(()=>{r&&c.current&&c.current.focus()},[r,s]);const d=o.useCallback(()=>{localStorage.setItem("chaosLabTutorial","completed"),e(!1)},[]),h=o.useCallback(()=>{s<ue.length-1?a(s+1):d()},[s,d]),u=o.useCallback(()=>{switch(ue[s].highlight){case"side-by-side":i(!0);break;case"info":n(!0);break}h()},[s,h,i,n]),m=o.useCallback(f=>{f.key==="Escape"?d():(f.key==="Enter"||f.key===" ")&&(f.preventDefault(),h())},[d,h]);if(!r)return null;const l=ue[s],x=s===ue.length-1;return t.jsx("div",{className:"quick-start-overlay",role:"dialog","aria-modal":"true","aria-label":"Quick start tutorial",onKeyDown:m,children:t.jsxs("div",{className:"quick-start-modal",ref:c,tabIndex:-1,children:[t.jsxs("div",{className:"quick-start-header",children:[t.jsx("h2",{id:"qs-title",children:l.title}),t.jsx("button",{className:"quick-start-close",onClick:d,"aria-label":"Close tutorial",children:"âœ•"})]}),t.jsxs("div",{className:"quick-start-content",children:[t.jsx("p",{id:"qs-desc",children:l.description}),t.jsx("div",{className:"quick-start-progress",role:"progressbar","aria-valuenow":s+1,"aria-valuemin":1,"aria-valuemax":ue.length,"aria-label":`Step ${s+1} of ${ue.length}`,children:ue.map((f,v)=>t.jsx("div",{className:`progress-dot ${v<=s?"active":""}`,"aria-hidden":"true"},v))})]}),t.jsxs("div",{className:"quick-start-actions",children:[t.jsx("button",{className:"quick-start-skip",onClick:d,children:"Skip Tutorial"}),t.jsx("button",{className:"quick-start-next",onClick:l.highlight?u:h,"aria-describedby":"qs-desc",children:x?"Let's Explore!":"Next"})]})]})})},vs=()=>{const{sideBySideMode:r,divergence:e,colorTheme:s}=I(),a=U[s];if(!r)return null;const i=Math.log10(Math.max(e,1e-4)),n=Math.min(1,Math.max(0,(i+4)/6)),c=Math.round(n*100),d=(1-n)*120,h=e<.001?e.toExponential(2):e.toFixed(3);return t.jsxs("div",{className:"divergence-meter",role:"meter","aria-label":"Divergence between the two systems","aria-valuenow":n,"aria-valuemin":0,"aria-valuemax":1,"aria-valuetext":`Divergence: ${h}`,children:[t.jsx("div",{className:"divergence-label",style:{color:a.textMuted},children:"Divergence"}),t.jsx("div",{className:"divergence-bar-track",children:t.jsx("div",{className:"divergence-bar-fill",style:{width:`${c}%`,background:`hsl(${d}, 90%, 55%)`,boxShadow:`0 0 10px hsla(${d}, 90%, 55%, 0.5), 0 0 20px hsla(${d}, 90%, 55%, 0.2)`}})}),t.jsx("div",{className:"divergence-value",style:{color:`hsl(${d}, 80%, 65%)`,textShadow:`0 0 12px hsla(${d}, 90%, 55%, 0.4)`},children:h})]})},Ss=()=>{const{showLyapunov:r,lyapunovExponent:e,colorTheme:s}=I(),a=U[s],i=o.useRef("");if(!r)return null;const c=(Math.max(-2,Math.min(3,e))+2)/5,d=(1-c)*120,h=Math.min(100,Math.max(5,c*100)),u=e>.1?"Chaotic":e>-.05?"Edge of Chaos":"Stable",m=e>.1?"ðŸ”´":e>-.05?"ðŸŸ¡":"ðŸŸ¢",l=i.current!==u;return l&&(i.current=u),t.jsxs("div",{className:"lyapunov-indicator",role:"region","aria-label":`Lyapunov exponent indicator: system is ${u}`,style:{"--panel-bg":a.panelBg,"--panel-border":a.panelBorder,"--text":a.text,"--text-muted":a.textMuted,"--bar-hue":d},children:[t.jsxs("div",{className:"lyapunov-header",children:[t.jsx("span",{className:"lyapunov-label",children:"Î» (Lyapunov)"}),t.jsxs("span",{className:"lyapunov-status","aria-hidden":"true",children:[m," ",u]})]}),t.jsxs("div",{className:"lyapunov-value",style:{color:`hsl(${d}, 90%, 60%)`},children:["Î» = ",e.toFixed(3)]}),t.jsxs("div",{className:"lyapunov-bar-track",role:"meter","aria-valuenow":e,"aria-valuemin":-2,"aria-valuemax":3,"aria-label":"Lyapunov exponent",children:[t.jsx("div",{className:"lyapunov-bar-fill",style:{width:`${h}%`,background:`hsl(${d}, 85%, 50%)`,boxShadow:`0 0 10px hsla(${d}, 85%, 50%, 0.6)`}}),t.jsx("div",{className:"lyapunov-bar-zero","aria-hidden":"true"})]}),t.jsx("div",{className:"lyapunov-hint",children:"Measures how fast nearby paths diverge. Positive = chaos."}),l&&t.jsxs("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:["System is now ",u,", Lyapunov exponent: ",e.toFixed(2)]})]})},ws=[{key:"Space",action:"Play / Pause simulation"},{key:"R",action:"Reset simulation"},{key:"1",action:"Switch to Lorenz attractor"},{key:"2",action:"Switch to RÃ¶ssler attractor"},{key:"3",action:"Switch to Double Pendulum"},{key:"S",action:"Toggle side-by-side (Butterfly) mode"},{key:"C",action:"Toggle cinematic chase camera"},{key:"A",action:"Toggle chaos autopilot"},{key:"M",action:"Toggle audio sonification"},{key:"B",action:"Toggle bloom glow effect"},{key:"G",action:"Toggle particle swarm mode"},{key:"X",action:"Perturb â€” random kick to the system"},{key:"F",action:"Capture ghost trail (Shift+F to clear)"},{key:"D",action:"Toggle floor shadow projection"},{key:"E",action:"Toggle exposure mode (Shift+E to clear)"},{key:"T",action:"Cycle through color themes"},{key:"P",action:"Screenshot current view"},{key:"L",action:"Copy share link to clipboard"},{key:"H / ?",action:"Toggle this help overlay"},{key:"Esc",action:"Close open dialogs"}],js=({isVisible:r,onClose:e})=>{const s=o.useRef(null);return o.useEffect(()=>{r&&s.current?.focus()},[r]),o.useEffect(()=>{if(!r)return;const a=i=>{(i.key==="Escape"||i.key==="h"||i.key==="H"||i.key==="?")&&(i.preventDefault(),e())};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[r,e]),r?t.jsx("div",{className:"help-overlay",role:"dialog","aria-modal":"true","aria-label":"Keyboard shortcuts",onClick:e,children:t.jsxs("div",{className:"help-modal",ref:s,tabIndex:-1,onClick:a=>a.stopPropagation(),children:[t.jsxs("div",{className:"help-header",children:[t.jsx("h2",{children:"âŒ¨ï¸ Keyboard Shortcuts"}),t.jsx("button",{className:"help-close",onClick:e,"aria-label":"Close help",children:"âœ•"})]}),t.jsx("div",{className:"help-grid",children:ws.map(({key:a,action:i})=>t.jsxs("div",{className:"help-row",children:[t.jsx("kbd",{className:"help-key",children:a}),t.jsx("span",{className:"help-action",children:i})]},a))}),t.jsxs("div",{className:"help-footer",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Mouse:"})," Drag to rotate Â· Scroll to zoom Â· Right-drag to pan"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Touch:"})," Drag to rotate Â· Pinch to zoom"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Right-click"})," canvas for quick actions"]})]})]})}):null},Ps=12e3,ze=2e3,Ms=()=>{const{storyMode:r,setStoryMode:e,currentStoryIndex:s,setCurrentStoryIndex:a,setCurrentSystem:i,setLorenzParams:n,setRosslerParams:c,setDoublePendulumParams:d,setTrailLength:h,setSpeed:u,setSideBySideMode:m,setInitialOffset:l,setCurrentPreset:x,setAutoRotate:f,resetSimulation:v,colorTheme:P,setCinematicCamera:y,setParticleSwarm:S}=I(),g=U[P],p=o.useRef(null),[T,A]=o.useState(!1),[j,k]=o.useState(0),w=o.useCallback(E=>{const M=ae[E];if(M){switch(i(M.system),h(M.trailLength),u(M.speed),m(M.sideBySide),l(M.offset),x(null),f(!0),y(!M.sideBySide),S(M.name==="The Murmuration"),M.system){case"lorenz":n(M.params);break;case"rossler":c(M.params);break;case"doublePendulum":d(M.params);break}v()}},[i,n,c,d,h,u,m,l,x,f,y,S,v]),R=o.useCallback(()=>{A(!0),setTimeout(()=>{const E=(s+1)%ae.length;a(E),w(E),k(E),setTimeout(()=>A(!1),100)},ze/2)},[s,a,w]),b=o.useCallback(()=>{A(!0),setTimeout(()=>{const E=(s-1+ae.length)%ae.length;a(E),w(E),k(E),setTimeout(()=>A(!1),100)},ze/2)},[s,a,w]);o.useEffect(()=>{r&&(w(s),k(s))},[r]),o.useEffect(()=>{if(r)return p.current=setTimeout(R,Ps),()=>{p.current&&clearTimeout(p.current)}},[r,s,R]);const z=o.useCallback(()=>{e(!1),y(!1),S(!1),f(!1),p.current&&clearTimeout(p.current)},[e,y,S,f]);if(o.useEffect(()=>{if(!r)return;const E=M=>{M.key==="Escape"?z():M.key==="ArrowRight"||M.key===" "?(M.preventDefault(),R()):M.key==="ArrowLeft"&&(M.preventDefault(),b())};return window.addEventListener("keydown",E),()=>window.removeEventListener("keydown",E)},[r,R,b,z]),!r)return null;const N=ae[j];return N?t.jsxs("div",{className:`story-mode-overlay ${T?"transitioning":""}`,style:{"--story-accent":g.accent,"--story-bg":g.panelBg,"--story-text":g.text,"--story-border":g.panelBorder},children:[t.jsx("div",{className:"story-progress",children:ae.map((E,M)=>t.jsx("button",{className:`story-dot ${M===j?"active":""} ${M<j?"visited":""}`,onClick:()=>{A(!0),setTimeout(()=>{a(M),w(M),k(M),setTimeout(()=>A(!1),100)},ze/2)},"aria-label":`Go to story ${M+1}: ${ae[M].name}`},M))}),t.jsxs("div",{className:"story-card",children:[t.jsx("div",{className:"story-emoji",children:N.emoji}),t.jsxs("div",{className:"story-text",children:[t.jsx("h2",{className:"story-title",children:N.name}),t.jsx("p",{className:"story-description",children:N.description})]}),t.jsxs("div",{className:"story-counter",children:[j+1," / ",ae.length]})]}),t.jsxs("div",{className:"story-nav",children:[t.jsx("button",{className:"story-nav-btn",onClick:b,"aria-label":"Previous story",children:"â†"}),t.jsx("button",{className:"story-nav-btn story-exit",onClick:z,"aria-label":"Exit story mode",children:"âœ• Exit"}),t.jsx("button",{className:"story-nav-btn",onClick:R,"aria-label":"Next story",children:"â†’"})]})]}):null},Ke={lorenz:{xRange:[-25,25],yRange:[-30,30],zRange:[0,55]},rossler:{xRange:[-15,15],yRange:[-15,15],zRange:[0,30]},doublePendulum:{xRange:[-3,3],yRange:[-3,3],zRange:[-1,1]}};function Fe(r,e,s,a,i){const n=Math.max(e,Math.min(s,r));return a+(n-e)/(s-e)*(i-a)}const Pe=[130.81,146.83,164.81,196,220,261.63,293.66,329.63,392,440,523.25,587.33,659.26];function Ze(r){let e=Pe[0],s=Math.abs(r-e);for(let a=1;a<Pe.length;a++){const i=Math.abs(r-Pe[a]);i<s&&(s=i,e=Pe[a])}return e}const Rs=()=>{const{audioEnabled:r,audioVolume:e,currentSystem:s,isPlaying:a}=I(),i=o.useRef(null),n=o.useRef(null),c=o.useRef(null),d=o.useRef(null),h=o.useRef(null),u=o.useRef(null),m=o.useRef(null),l=o.useRef(null),x=o.useRef(0),f=o.useCallback(()=>{if(i.current)return;const y=new AudioContext;i.current=y;const S=y.createOscillator();S.type="sine",S.frequency.value=220,n.current=S;const g=y.createOscillator();g.type="triangle",g.frequency.value=220,g.detune.value=7,c.current=g;const p=y.createBiquadFilter();p.type="lowpass",p.frequency.value=800,p.Q.value=2,h.current=p;const T=y.createGain();T.gain.value=0,d.current=T;const A=y.createGain();A.gain.value=e,u.current=A;const j=y.createDelay(1);j.delayTime.value=.3;const k=y.createGain();k.gain.value=.25;const w=y.createGain();w.gain.value=.3,m.current=w,S.connect(p),g.connect(p),p.connect(T),T.connect(A),T.connect(j),j.connect(k),k.connect(j),j.connect(w),w.connect(A),A.connect(y.destination),S.start(),g.start()},[e]),v=o.useCallback(()=>{if(x.current&&(cancelAnimationFrame(x.current),x.current=0),n.current){try{n.current.stop()}catch{}n.current=null}if(c.current){try{c.current.stop()}catch{}c.current=null}i.current&&(i.current.close(),i.current=null),d.current=null,h.current=null,u.current=null,m.current=null,l.current=null},[]),P=o.useCallback(()=>{const y=i.current,S=n.current,g=c.current,p=d.current,T=h.current;if(!y||!S||!g||!p||!T)return;const A=V.system;if(!A?.points||A.points.length<5){p.gain.setTargetAtTime(0,y.currentTime,.1),x.current=requestAnimationFrame(P);return}const j=V.type||"lorenz",k=A.points,w=k[k.length-1],R=Ke[j]||Ke.lorenz,b=l.current||w,z=w.x-b.x,N=w.y-b.y,E=w.z-b.z,M=Math.sqrt(z*z+N*N+E*E);l.current={x:w.x,y:w.y,z:w.z};const F=y.currentTime,B=.08,O=Fe(w.x,R.xRange[0],R.xRange[1],100,600),$=Ze(O);S.frequency.setTargetAtTime($,F,B);const _=Fe(w.y,R.yRange[0],R.yRange[1],80,500),q=Ze(_)*1.5;g.frequency.setTargetAtTime(q,F,B*1.5);const D=Fe(w.z,R.zRange[0],R.zRange[1],200,2500);T.frequency.setTargetAtTime(D,F,B);const L=Math.min(1,M/(j==="doublePendulum"?2:15)),Y=L*L*.4;p.gain.setTargetAtTime(Y,F,B),x.current=requestAnimationFrame(P)},[]);return o.useEffect(()=>(r&&a?(f(),setTimeout(()=>{x.current=requestAnimationFrame(P)},100)):v(),()=>{v()}),[r,a,f,v,P]),o.useEffect(()=>{u.current&&i.current&&u.current.gain.setTargetAtTime(e,i.current.currentTime,.05)},[e]),o.useEffect(()=>{r&&d.current&&i.current&&(a||d.current.gain.setTargetAtTime(0,i.current.currentTime,.2))},[a,r]),o.useEffect(()=>{l.current=null},[s]),null};function Ts(){const{currentSystem:r}=I();return o.useCallback(()=>{const s=document.querySelector("canvas");if(s)try{const a=r==="doublePendulum"?"pendulum":r,i=new Date().toISOString().split("T")[0],n=`chaos-lab-${a}-${i}.png`;s.toBlob(c=>{if(!c)return;const d=URL.createObjectURL(c),h=document.createElement("a");h.href=d,h.download=n,document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(d)},"image/png")}catch(a){console.warn("Screenshot failed:",a)}},[r])}const Cs=new Set(["lorenz","rossler","doublePendulum"]),Es=new Set(["classic","neon","blueprint","terminal"]);function Qe(){const r=I.getState(),e=new URLSearchParams;switch(e.set("sys",r.currentSystem),e.set("theme",r.colorTheme),e.set("speed",r.speed.toFixed(1)),e.set("trail",String(r.trailLength)),e.set("sbs",r.sideBySideMode?"1":"0"),r.sideBySideMode&&e.set("offset",r.initialOffset.toExponential(1)),r.bloomEnabled&&e.set("bloom",r.bloomIntensity.toFixed(1)),r.audioEnabled&&e.set("audio","1"),r.currentSystem){case"lorenz":e.set("sigma",r.lorenzParams.sigma.toFixed(2)),e.set("rho",r.lorenzParams.rho.toFixed(2)),e.set("beta",r.lorenzParams.beta.toFixed(3));break;case"rossler":e.set("a",r.rosslerParams.a.toFixed(3)),e.set("b",r.rosslerParams.b.toFixed(3)),e.set("c",r.rosslerParams.c.toFixed(2));break;case"doublePendulum":e.set("m1",r.doublePendulumParams.mass1.toFixed(2)),e.set("m2",r.doublePendulumParams.mass2.toFixed(2)),e.set("l1",r.doublePendulumParams.length1.toFixed(2)),e.set("l2",r.doublePendulumParams.length2.toFixed(2)),e.set("g",r.doublePendulumParams.gravity.toFixed(2)),e.set("damp",r.doublePendulumParams.damping.toFixed(3));break}return"#"+e.toString()}function As(r){if(!r||r.length<2)return!1;try{const e=new URLSearchParams(r.slice(1)),s=I.getState(),a=e.get("sys");if(a&&Cs.has(a))s.setCurrentSystem(a);else return!1;const i=e.get("theme");i&&Es.has(i)&&s.setColorTheme(i);const n=parseFloat(e.get("speed")||"");n>0&&n<=5&&s.setSpeed(n);const c=parseInt(e.get("trail")||"");if(c>=100&&c<=5e3&&s.setTrailLength(c),e.get("sbs")==="1"){s.setSideBySideMode(!0);const u=parseFloat(e.get("offset")||"");u>0&&u<1&&s.setInitialOffset(u)}const h=parseFloat(e.get("bloom")||"");switch(h>0&&h<=4?(s.setBloomEnabled(!0),s.setBloomIntensity(h)):e.has("bloom")&&e.get("bloom")==="0"&&s.setBloomEnabled(!1),e.get("audio")==="1"&&s.setAudioEnabled(!0),a){case"lorenz":{const u=parseFloat(e.get("sigma")||""),m=parseFloat(e.get("rho")||""),l=parseFloat(e.get("beta")||"");u>0&&s.setLorenzParams({sigma:u}),m>0&&s.setLorenzParams({rho:m}),l>0&&s.setLorenzParams({beta:l});break}case"rossler":{const u=parseFloat(e.get("a")||""),m=parseFloat(e.get("b")||""),l=parseFloat(e.get("c")||"");u>0&&s.setRosslerParams({a:u}),m>0&&s.setRosslerParams({b:m}),l>0&&s.setRosslerParams({c:l});break}case"doublePendulum":{const u=parseFloat(e.get("m1")||""),m=parseFloat(e.get("m2")||""),l=parseFloat(e.get("l1")||""),x=parseFloat(e.get("l2")||""),f=parseFloat(e.get("g")||""),v=parseFloat(e.get("damp")||"");u>0&&s.setDoublePendulumParams({mass1:u}),m>0&&s.setDoublePendulumParams({mass2:m}),l>0&&s.setDoublePendulumParams({length1:l}),x>0&&s.setDoublePendulumParams({length2:x}),f>0&&s.setDoublePendulumParams({gravity:f}),v>=0&&s.setDoublePendulumParams({damping:v});break}}return!0}catch{return!1}}function Je(){return window.location.origin+window.location.pathname+Qe()}function ks(){const r=o.useRef(!1);o.useEffect(()=>{r.current||(r.current=!0,window.location.hash&&As(window.location.hash))},[]);const{currentSystem:e,colorTheme:s,speed:a,trailLength:i,sideBySideMode:n,initialOffset:c,lorenzParams:d,rosslerParams:h,doublePendulumParams:u,bloomEnabled:m,bloomIntensity:l,audioEnabled:x}=I();o.useEffect(()=>{const f=setTimeout(()=>{window.history.replaceState(null,"",Qe())},500);return()=>clearTimeout(f)},[e,s,a,i,n,c,d,h,u,m,l,x])}const Ne=["classic","neon","blueprint","terminal"],Le=["lorenz","rossler","doublePendulum"];function zs(r){const e=Ts();o.useEffect(()=>{const s=a=>{const i=a.target.tagName;if(i==="INPUT"||i==="TEXTAREA"||i==="SELECT"||a.ctrlKey||a.metaKey||a.altKey)return;const n=I.getState();switch(a.key){case" ":a.preventDefault(),n.setIsPlaying(!n.isPlaying);break;case"r":case"R":n.resetSimulation();break;case"1":n.setCurrentSystem(Le[0]),n.setCurrentPreset(null);break;case"2":n.setCurrentSystem(Le[1]),n.setCurrentPreset(null);break;case"3":n.setCurrentSystem(Le[2]),n.setCurrentPreset(null);break;case"s":case"S":n.setSideBySideMode(!n.sideBySideMode),n.sideBySideMode||n.resetSimulation();break;case"t":case"T":{const c=Ne.indexOf(n.colorTheme),d=Ne[(c+1)%Ne.length];n.setColorTheme(d);break}case"h":case"H":case"?":r();break;case"p":case"P":e();break;case"l":case"L":try{navigator.clipboard.writeText(Je())}catch{window.prompt("Share this URL:",Je())}break;case"c":case"C":n.setCinematicCamera(!n.cinematicCamera);break;case"a":case"A":n.setChaosAutopilot(!n.chaosAutopilot);break;case"m":case"M":n.setAudioEnabled(!n.audioEnabled);break;case"b":case"B":n.setBloomEnabled(!n.bloomEnabled);break;case"g":n.setParticleSwarm(!n.particleSwarm);break;case"G":n.setParticleSwarm(!n.particleSwarm);break;case"x":case"X":n.perturbSystem();break;case"f":n.captureGhost();break;case"F":n.clearGhosts();break;case"d":n.setShowFloorShadow(!n.showFloorShadow);break;case"D":n.setShowFloorShadow(!n.showFloorShadow);break;case"e":n.setExposureMode(!n.exposureMode);break;case"E":n.clearExposure();break;case"Escape":n.storyMode?(n.setStoryMode(!1),n.setCinematicCamera(!1)):n.showBifurcation?n.setShowBifurcation(!1):n.showPoincare?n.setShowPoincare(!1):n.showParameterSpace?n.setShowParameterSpace(!1):n.cinematicCamera&&n.setCinematicCamera(!1);break}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[r,e])}const Fs=o.lazy(()=>_e(()=>import("./BifurcationDiagram-O0Hzjq-S.js"),__vite__mapDeps([0,1,2])).then(r=>({default:r.BifurcationDiagram}))),Ns=o.lazy(()=>_e(()=>import("./PoincareSection-BEnob7Mp.js"),__vite__mapDeps([3,1,4])).then(r=>({default:r.PoincareSection}))),Ls=o.lazy(()=>_e(()=>import("./ParameterSpace-DsCtjsWw.js"),__vite__mapDeps([5,1,6])).then(r=>({default:r.ParameterSpace})));function Is(){const r=I(e=>e.setIsPlaying);o.useEffect(()=>{const e=window.matchMedia("(prefers-reduced-motion: reduce)");e.matches&&r(!1);const s=a=>{a.matches&&r(!1)};return e.addEventListener("change",s),()=>e.removeEventListener("change",s)},[r])}function _s(){const{colorTheme:r,currentSystem:e,_perturbCounter:s,showPerformanceWarning:a,setShowPerformanceWarning:i}=I(),n=U[r],[c,d]=o.useState(!1),[h,u]=o.useState(!1),[m,l]=o.useState(!0),[x,f]=o.useState(!1),v=o.useRef(e),[P,y]=o.useState(!1),[S,g]=o.useState(!1),p=o.useRef(s),T=o.useCallback(()=>d(j=>!j),[]);Is(),zs(T),ks(),o.useEffect(()=>{const j=setTimeout(()=>u(!0),100),k=setTimeout(()=>f(!0),1200),w=setTimeout(()=>l(!1),6e3);return()=>{clearTimeout(j),clearTimeout(k),clearTimeout(w)}},[]),o.useEffect(()=>{if(v.current!==e){y(!0);const j=setTimeout(()=>y(!1),600);return v.current=e,()=>clearTimeout(j)}},[e]),o.useEffect(()=>{if(s>0&&s!==p.current){g(!0);const j=setTimeout(()=>g(!1),450);return p.current=s,()=>clearTimeout(j)}},[s]);const A=e==="lorenz"?"Lorenz Attractor":e==="rossler"?"RÃ¶ssler Attractor":"Double Pendulum";return t.jsxs("div",{className:`app ${h?"entered":"entering"} ${P?"system-transitioning":""} ${S?"perturbed":""}`,style:{"--bg":n.bg,"--text":n.text,"--accent":n.accent},children:[t.jsx("a",{href:"#controls-region",className:"skip-link",children:"Skip to controls"}),t.jsxs("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:["Now viewing: ",A]}),t.jsx("main",{className:P?"scene-crossfade":"",children:t.jsx(ms,{})}),t.jsxs("div",{className:`ui-layer ${x?"visible":""}`,children:[t.jsx(bs,{}),t.jsx("div",{id:"controls-region",children:t.jsx(gs,{})}),t.jsx(vs,{}),t.jsx(Ss,{}),t.jsxs(o.Suspense,{fallback:null,children:[t.jsx(Fs,{}),t.jsx(Ns,{}),t.jsx(Ls,{})]})]}),t.jsx(js,{isVisible:c,onClose:T}),t.jsx(Ms,{}),t.jsx(xs,{}),t.jsx(Rs,{}),a&&t.jsxs("div",{className:"performance-warning",role:"alert",style:{position:"fixed",bottom:"12px",left:"50%",transform:"translateX(-50%)",background:"rgba(200, 120, 0, 0.9)",color:"#fff",padding:"8px 20px",borderRadius:"8px",fontSize:"13px",fontFamily:"system-ui, sans-serif",zIndex:1e3,backdropFilter:"blur(8px)",display:"flex",alignItems:"center",gap:"10px",boxShadow:"0 2px 12px rgba(0,0,0,0.4)"},children:[t.jsx("span",{children:"âš ï¸ Low FPS detected â€” try reducing trail length or disabling particle swarm"}),t.jsx("button",{onClick:()=>i(!1),style:{background:"rgba(255,255,255,0.2)",border:"none",color:"#fff",borderRadius:"4px",padding:"2px 8px",cursor:"pointer",fontSize:"12px"},"aria-label":"Dismiss performance warning",children:"âœ•"})]}),t.jsxs("div",{className:`title-overlay ${m?"visible":"faded"}`,"aria-hidden":"true",onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),children:[t.jsx("h1",{children:"Chaos Lab"}),t.jsx("p",{children:"Interactive Chaos Theory Visualizer"})]}),t.jsx("div",{className:`instructions ${x?"visible":""}`,"aria-hidden":"true",children:t.jsx("p",{children:"Drag to explore Â· Scroll to dive deeper Â· Right-drag to drift"})})]})}yt.createRoot(document.getElementById("root")).render(t.jsx(o.StrictMode,{children:t.jsx(_s,{})}));export{U as T,V as s,I as u};
